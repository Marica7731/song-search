<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¼”å”±è€…ç»Ÿè®¡ - æ­Œæ›²å‡ºåœºé¢‘ç‡åˆ†æ</title>
    <style>
        /* å…¨å±€æ ·å¼å¤ç”¨ */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "PingFang SC", "Microsoft YaHei", sans-serif; 
            max-width: 1400px; 
            margin: 0 auto; 
            padding: 30px 20px; 
            background: linear-gradient(135deg, #f5f7fa 0%, #e4e8ec 100%);
            min-height: 100vh;
        }
        h1 { 
            text-align: center; 
            color: #2c3e50; 
            margin-bottom: 10px;
            font-size: 28px;
            font-weight: 700;
            text-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .sub-header {
            text-align: center;
            color: #6c757d;
            margin-bottom: 30px;
            font-size: 14px;
        }
        .nav-link {
            color: #00a1d6;
            text-decoration: none;
            font-weight: 600;
        }
        .nav-link:hover { text-decoration: underline; }

        /* ç­›é€‰åŒºåŸŸ */
        .filter-container {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            padding: 20px 25px;
            background: white;
            border-radius: 12px;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            margin-bottom: 25px;
        }
        .filter-label {
            font-size: 14px;
            color: #495057;
            font-weight: 600;
            white-space: nowrap;
        }
        .filter-select {
            flex: 1;
            min-width: 200px;
            padding: 10px 15px;
            font-size: 14px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            outline: none;
            background: white;
            cursor: pointer;
            transition: all 0.2s;
        }
        .filter-select:focus {
            border-color: #00a1d6;
            box-shadow: 0 0 0 3px rgba(0, 161, 214, 0.1);
        }
        .filter-btn {
            padding: 10px 20px;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            background: #f8f9fa;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            color: #495057;
            transition: all 0.2s;
        }
        .filter-btn:hover {
            border-color: #00a1d6;
            color: #00a1d6;
            background: #f0f9ff;
        }
        .filter-btn.primary {
            background: linear-gradient(135deg, #00a1d6 0%, #00c6ff 100%);
            color: white;
            border-color: transparent;
            box-shadow: 0 4px 12px rgba(0, 161, 214, 0.3);
        }
        .filter-btn.primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 6px 16px rgba(0, 161, 214, 0.4);
        }

        /* ç»Ÿè®¡ä¿¡æ¯ */
        .stats-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding: 0 5px;
        }
        .stats-text {
            font-size: 14px;
            color: #6c757d;
            font-weight: 500;
        }
        .sort-hint {
            font-size: 12px;
            color: #adb5bd;
        }

        /* åˆ—è¡¨æ ·å¼ */
        #stats-list { list-style: none; padding: 0; margin-bottom: 35px; }
        .stat-item {
            padding: 22px 25px;
            margin-bottom: 15px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
            transition: all 0.3s ease;
        }
        .stat-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.08);
        }
        
        /* æ’è¡Œå¤´éƒ¨ */
        .stat-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 20px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        .stat-main-info { flex: 1; min-width: 250px; }
        .stat-rank-title {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 6px;
        }
        .rank-badge {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 800;
            font-size: 14px;
            flex-shrink: 0;
        }
        .rank-1 { background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%); color: #8b6914; }
        .rank-2 { background: linear-gradient(135deg, #c0c0c0 0%, #e8e8e8 100%); color: #5a5a5a; }
        .rank-3 { background: linear-gradient(135deg, #cd7f32 0%, #e9a66a 100%); color: #5c3a1a; }
        .rank-other { background: #f8f9fa; color: #6c757d; border: 1px solid #e9ecef; }
        
        .song-title-large {
            font-size: 20px;
            font-weight: 800;
            color: #2c3e50;
            line-height: 1.3;
        }
        .artist-original-row {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin-top: 8px;
        }
        .info-chip {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 13px;
            font-weight: 500;
        }
        .chip-artist { background: #e3f2fd; color: #1565c0; }
        .chip-original { background: #e8f5e9; color: #2e7d32; }
        .chip-original.cover { background: #fff3e0; color: #e65100; }

        /* é¢‘ç‡å¾½ç«  */
        .count-badge {
            padding: 8px 18px;
            border-radius: 20px;
            font-size: 16px;
            font-weight: 800;
            background: linear-gradient(135deg, #6f42c1 0%, #8a6edb 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(111, 66, 193, 0.3);
            white-space: nowrap;
        }

        /* åœºæ¬¡åˆ—è¡¨ */
        .performances-section {
            border-top: 1px solid #f1f3f5;
            padding-top: 15px;
            margin-top: 5px;
        }
        .perf-title {
            font-size: 13px;
            color: #adb5bd;
            font-weight: 600;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .perf-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        .perf-link {
            display: inline-block;
            padding: 6px 14px;
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            font-size: 13px;
            color: #495057;
            text-decoration: none;
            transition: all 0.2s;
        }
        .perf-link:hover {
            border-color: #00a1d6;
            color: #00a1d6;
            background: #f0f9ff;
            transform: translateY(-1px);
        }

        /* è¿›åº¦/ç©ºçŠ¶æ€ */
        .progress-msg { 
            text-align: center; 
            color: #495057; 
            padding: 60px 20px; 
            font-size: 16px; 
            font-weight: 500;
        }
        .empty-msg { 
            text-align: center; 
            color: #6c757d; 
            padding: 60px 20px; 
            font-size: 16px; 
            display: none;
            font-weight: 500;
        }

        /* åˆ†é¡µå¤ç”¨ */
        .pagination { 
            display: flex; 
            justify-content: center; 
            align-items: center;
            gap: 8px; 
            flex-wrap: wrap;
            margin-top: 30px;
            padding: 20px;
        }
        .page-btn { 
            padding: 10px 16px; 
            border: 1px solid #e9ecef; 
            border-radius: 8px; 
            background: white; 
            cursor: pointer; 
            font-size: 14px;
            font-weight: 500;
            color: #495057;
            min-width: 44px;
            text-align: center;
            transition: all 0.2s ease;
            box-shadow: 0 2px 6px rgba(0,0,0,0.04);
        }
        .page-btn:hover:not(.disabled):not(.active):not(.ellipsis) { 
            background: #f8f9fa;
            border-color: #00a1d6;
            color: #00a1d6;
        }
        .page-btn.active { 
            background: linear-gradient(135deg, #00a1d6 0%, #00c6ff 100%);
            color: white; 
            border-color: transparent;
            box-shadow: 0 4px 12px rgba(0, 161, 214, 0.3);
        }
        .page-btn.disabled { 
            cursor: not-allowed; 
            color: #adb5bd; 
            background: #f8f9fa;
            border-color: #e9ecef;
            box-shadow: none;
        }
        .page-btn.ellipsis {
            border: none;
            background: transparent;
            box-shadow: none;
            cursor: default;
            min-width: 30px;
        }
    </style>
</head>
<body>
    <h1>ğŸ¤ æ¼”å”±è€…ç»Ÿè®¡ä¸æ­Œæ›²å‡ºåœºé¢‘ç‡</h1>
    <div class="sub-header">
        æŸ¥çœ‹å“ªä½æ­Œæ‰‹çš„å“ªé¦–æ­Œæ¼”å”±æ¬¡æ•°æœ€å¤š | <a href="index.html" class="nav-link">è¿”å›æ­Œæ›²æŸ¥è¯¢ç«™</a>
    </div>

    <div class="filter-container">
        <span class="filter-label">ğŸ¤ ç­›é€‰æ¼”å”±è€…ï¼š</span>
        <select id="artist-filter" class="filter-select">
            <option value="all">å…¨éƒ¨æ¼”å”±è€…</option>
        </select>
        <button id="reset-btn" class="filter-btn">ğŸ”„ é‡ç½®</button>
    </div>

    <div class="stats-bar">
        <div class="stats-text" id="summary-text">åŠ è½½ä¸­...</div>
        <div class="sort-hint">ğŸ’¡ åˆ—è¡¨æŒ‰å‡ºåœºæ¬¡æ•°é™åºæ’åˆ—</div>
    </div>

    <div class="progress-msg" id="progress-msg">ğŸ“¥ æ­£åœ¨åŠ è½½å¹¶ç»Ÿè®¡æ•°æ®...</div>
    <div class="empty-msg" id="empty-msg">âŒ æš‚æ— æ•°æ®</div>
    <ul id="stats-list"></ul>
    <div class="pagination" id="pagination"></div>

    <script>
        // é…ç½®
        const PAGE_SIZE = 20;
        let currentPage = 1;
        
        // æ•°æ®æº
        let originalData = [];
        let aggregatedData = []; // èšåˆåçš„æ•°æ®
        let filteredData = [];   // ç­›é€‰åçš„æ•°æ®
        
        // å·¥å…·å‡½æ•°ï¼šåˆ¤æ–­æœ‰æ•ˆæ­Œæ‰‹
        function isValidArtist(artist) {
            if (!artist || artist.trim() === '') return false;
            if (artist.includes('æ¥æºå¤„æœªæä¾›æ ‡å‡†æ ¼å¼æ­Œæ‰‹')) return false;
            return true;
        }

        // ========== æ ¸å¿ƒï¼šæ•°æ®èšåˆé€»è¾‘ ==========
        function aggregateData(rawData) {
            // Key: "NormalizedTitle|NormalizedArtist", Value: {info}
            const map = new Map();

            rawData.forEach(item => {
                const artist = item.artist || '';
                if (!isValidArtist(artist)) return; // è·³è¿‡æ— æ­Œæ‰‹çš„

                const title = item.title || 'æœªçŸ¥æ­Œæ›²';
                // æ„é€ èšåˆKey (æ­Œå+æ­Œæ‰‹)
                const key = `${title.trim().toLowerCase()}|${artist.trim().toLowerCase()}`;

                if (!map.has(key)) {
                    map.set(key, {
                        title: title,
                        artist: artist,
                        originalArtist: item.originalArtist || '', // å‡è®¾æ•°æ®ä¸­æœ‰æ­¤å­—æ®µï¼Œæ²¡æœ‰åˆ™ä¸ºç©º
                        count: 0,
                        performances: [] // å­˜å‚¨ {link, collection, p?}
                    });
                }

                const entry = map.get(key);
                entry.count++;
                
                // å°è¯•æå–åˆ†På· (ä»…ç”¨äºæ˜¾ç¤ºï¼Œéå¿…é¡»)
                let pText = '';
                if (item.link && item.link.includes('?p=')) {
                    try {
                        const urlParams = new URLSearchParams(item.link.split('?')[1]);
                        const p = urlParams.get('p');
                        if (p) pText = `P${p}`;
                    } catch(e) {}
                }

                entry.performances.push({
                    link: item.link,
                    collection: item.collection || 'æœªçŸ¥åˆé›†',
                    p: pText
                });
            });

            // è½¬ä¸ºæ•°ç»„å¹¶æ’åº
            const arr = Array.from(map.values());
            arr.sort((a, b) => b.count - a.count); // æŒ‰æ¬¡æ•°é™åº
            return arr;
        }

        // ========== æ¸²æŸ“å‡½æ•° ==========
        function renderList(data) {
            const listEl = document.getElementById('stats-list');
            listEl.innerHTML = '';

            const start = (currentPage - 1) * PAGE_SIZE;
            const end = start + PAGE_SIZE;
            const pageData = data.slice(start, end);

            if (pageData.length === 0) {
                document.getElementById('empty-msg').style.display = 'block';
            } else {
                document.getElementById('empty-msg').style.display = 'none';
                
                pageData.forEach((item, index) => {
                    const globalRank = start + index + 1;
                    
                    // æ’åå¾½ç« æ ·å¼
                    let rankClass = 'rank-other';
                    if (globalRank === 1) rankClass = 'rank-1';
                    else if (globalRank === 2) rankClass = 'rank-2';
                    else if (globalRank === 3) rankClass = 'rank-3';

                    // åŸå”±æ ‡ç­¾
                    const hasOriginal = item.originalArtist && item.originalArtist.trim() !== '';
                    const isCover = hasOriginal && item.originalArtist.toLowerCase() !== item.artist.toLowerCase();
                    
                    // åœºæ¬¡é“¾æ¥
                    const perfHtml = item.performances.map((perf, i) => {
                        const linkText = perf.p ? `${perf.collection} (${perf.p})` : perf.collection;
                        return `<a href="${perf.link}" target="_blank" class="perf-link">${linkText}</a>`;
                    }).join('');

                    const li = document.createElement('li');
                    li.className = 'stat-item';
                    li.innerHTML = `
                        <div class="stat-header">
                            <div class="stat-main-info">
                                <div class="stat-rank-title">
                                    <div class="rank-badge ${rankClass}">${globalRank}</div>
                                    <div class="song-title-large">${item.title}</div>
                                </div>
                                <div class="artist-original-row">
                                    <span class="info-chip chip-artist">ğŸ¤ ${item.artist}</span>
                                    ${hasOriginal ? `<span class="info-chip chip-original ${isCover ? 'cover' : ''}">ğŸ“ ${isCover ? 'åŸå”±: ' + item.originalArtist : 'åŸå”±'}</span>` : ''}
                                </div>
                            </div>
                            <div class="count-badge">${item.count} æ¬¡</div>
                        </div>
                        <div class="performances-section">
                            <div class="perf-title">ğŸ¬ æ¼”å”±åœºæ¬¡ (${item.count}ä¸ªè§†é¢‘)</div>
                            <div class="perf-grid">${perfHtml}</div>
                        </div>
                    `;
                    listEl.appendChild(li);
                });
            }

            renderPagination(data.length);
        }

        // åˆ†é¡µæ¸²æŸ“
        function renderPagination(total) {
            const paginationEl = document.getElementById('pagination');
            paginationEl.innerHTML = '';
            const totalPages = Math.ceil(total / PAGE_SIZE);
            if (totalPages <= 1) return;

            const prevBtn = document.createElement('button');
            prevBtn.className = `page-btn ${currentPage === 1 ? 'disabled' : ''}`;
            prevBtn.textContent = 'ä¸Šä¸€é¡µ';
            prevBtn.onclick = () => {
                if (currentPage > 1) { currentPage--; renderList(filteredData); }
            };
            paginationEl.appendChild(prevBtn);

            const startPage = Math.max(1, currentPage - 3);
            const endPage = Math.min(totalPages, currentPage + 3);
            for (let i = startPage; i <= endPage; i++) {
                const btn = document.createElement('button');
                btn.className = `page-btn ${i === currentPage ? 'active' : ''}`;
                btn.textContent = i;
                btn.onclick = () => { currentPage = i; renderList(filteredData); };
                paginationEl.appendChild(btn);
            }

            const nextBtn = document.createElement('button');
            nextBtn.className = `page-btn ${currentPage === totalPages ? 'disabled' : ''}`;
            nextBtn.textContent = 'ä¸‹ä¸€é¡µ';
            nextBtn.onclick = () => {
                if (currentPage < totalPages) { currentPage++; renderList(filteredData); }
            };
            paginationEl.appendChild(nextBtn);
        }

        // åˆå§‹åŒ–ç­›é€‰ä¸‹æ‹‰æ¡†
        function initArtistFilter() {
            const select = document.getElementById('artist-filter');
            const artists = new Set();
            
            aggregatedData.forEach(item => {
                artists.add(item.artist);
            });

            // æŒ‰å­—æ¯/æ‹¼éŸ³é¡ºåºæ’åºï¼ˆç®€å•å®ç°ï¼‰
            const sortedArtists = Array.from(artists).sort();
            
            sortedArtists.forEach(artist => {
                const opt = document.createElement('option');
                opt.value = artist;
                opt.textContent = artist;
                select.appendChild(opt);
            });

            // ç»‘å®šäº‹ä»¶
            select.addEventListener('change', () => {
                const val = select.value;
                currentPage = 1;
                if (val === 'all') {
                    filteredData = [...aggregatedData];
                } else {
                    filteredData = aggregatedData.filter(d => d.artist === val);
                }
                updateSummary();
                renderList(filteredData);
            });
        }

        // æ›´æ–°ç»Ÿè®¡æ‘˜è¦
        function updateSummary() {
            const totalSongs = aggregatedData.length;
            const totalArtists = new Set(aggregatedData.map(d => d.artist)).size;
            const filterCount = filteredData.length;
            
            let text = `ğŸ“Š å…±ç»Ÿè®¡ ${totalArtists} ä½æ­Œæ‰‹ï¼Œ${totalSongs} é¦–ä¸åŒæ­Œæ›²`;
            if (filteredData.length !== aggregatedData.length) {
                text += ` | å½“å‰ç­›é€‰ï¼š${filterCount} é¦–`;
            }
            
            document.getElementById('summary-text').textContent = text;
        }

        // åŠ è½½æ•°æ®ï¼ˆå¤ç”¨ä¹‹å‰çš„é€»è¾‘ï¼‰
        async function loadData() {
            const progressMsg = document.getElementById('progress-msg');
            try {
                const res = await fetch('data/index.json');
                if (!res.ok) throw new Error('æ— æ³•åŠ è½½ index.json');
                const config = await res.json();
                const files = config.files || [];
                
                if (files.length === 0) throw new Error('index.json ä¸­æ— æ–‡ä»¶é…ç½®');

                // å¹¶è¡ŒåŠ è½½æ‰€æœ‰ JS
                let loadedCount = 0;
                const promises = files.map(fileName => {
                    return new Promise((resolve) => {
                        const script = document.createElement('script');
                        script.src = `data/${fileName}`;
                        script.onload = () => {
                            loadedCount++;
                            progressMsg.textContent = `ğŸ“¥ åŠ è½½æ•°æ® (${loadedCount}/${files.length})...`;
                            resolve();
                        };
                        script.onerror = () => resolve(); // å¿½ç•¥å¤±è´¥
                        document.body.appendChild(script);
                    });
                });

                await Promise.all(promises);
                
                // æ­¤æ—¶ window.SONG_DATA åº”è¯¥å·²è¢«å¡«å……
                if (!window.SONG_DATA || window.SONG_DATA.length === 0) {
                    throw new Error('æœªæ‰¾åˆ°æ­Œæ›²æ•°æ®');
                }

                originalData = [...window.SONG_DATA];
                
                // æ‰§è¡Œèšåˆ
                progressMsg.textContent = 'ğŸ”„ æ­£åœ¨ç»Ÿè®¡å‡ºåœºé¢‘ç‡...';
                aggregatedData = aggregateData(originalData);
                filteredData = [...aggregatedData];

                // åˆå§‹åŒ–ç•Œé¢
                initArtistFilter();
                updateSummary();
                
                progressMsg.style.display = 'none';
                renderList(filteredData);

            } catch (err) {
                console.error(err);
                progressMsg.textContent = `âŒ åŠ è½½å¤±è´¥: ${err.message}`;
            }
        }

        // é‡ç½®æŒ‰é’®
        document.getElementById('reset-btn').addEventListener('click', () => {
            document.getElementById('artist-filter').value = 'all';
            currentPage = 1;
            filteredData = [...aggregatedData];
            updateSummary();
            renderList(filteredData);
        });

        // å¯åŠ¨
        document.addEventListener('DOMContentLoaded', loadData);
    </script>
</body>
</html>
