<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ­Œæ›²ç»Ÿè®¡ - å‡ºåœºé¢‘ç‡ä¸VTuberæ­Œå•</title>
    <style>
        /* --- å…¨å±€æ ·å¼å¤ç”¨ (ä¸ index.html ä¿æŒä¸€è‡´) --- */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "PingFang SC", "Microsoft YaHei", sans-serif; 
            max-width: 1200px; 
            margin: 0 auto; 
            padding: 30px 20px; 
            background: linear-gradient(135deg, #f5f7fa 0%, #e4e8ec 100%);
            min-height: 100vh;
        }
        h1 { 
            text-align: center; 
            color: #2c3e50; 
            margin-bottom: 10px;
            font-size: 28px;
            font-weight: 700;
            text-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .sub-header {
            text-align: center;
            color: #6c757d;
            margin-bottom: 25px;
            font-size: 14px;
        }
        .nav-link {
            color: #00a1d6;
            text-decoration: none;
            font-weight: 600;
        }
        .nav-link:hover { text-decoration: underline; }

        /* --- æ–°å¢ï¼šTab åˆ‡æ¢å™¨æ ·å¼ --- */
        .tabs-container {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 25px;
        }
        .tab-btn {
            padding: 12px 35px;
            border: none;
            border-radius: 25px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            background: white;
            color: #495057;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            transition: all 0.3s ease;
        }
        .tab-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .tab-btn.active {
            background: linear-gradient(135deg, #00a1d6 0%, #00c6ff 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(0, 161, 214, 0.4);
        }

        /* --- ç­›é€‰ä¸æœç´¢æ ·å¼ (å¤ç”¨ index.html) --- */
        .filter-search-container {
            display: flex;
            flex-direction: column;
            gap: 18px;
            margin-bottom: 25px;
        }
        .filter-bar {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            padding: 15px 20px;
            background: white;
            border-radius: 12px;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        .filter-label {
            font-size: 14px;
            color: #495057;
            font-weight: 600;
            white-space: nowrap;
        }
        .filter-btn {
            padding: 7px 16px;
            border: 1px solid #e9ecef;
            border-radius: 20px;
            background: #f8f9fa;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            color: #495057;
            transition: all 0.2s ease;
        }
        .filter-btn:hover {
            border-color: #00a1d6;
            color: #00a1d6;
            background: #f0f9ff;
        }
        .filter-btn.active {
            background: linear-gradient(135deg, #00a1d6 0%, #00c6ff 100%);
            color: white;
            border-color: transparent;
            box-shadow: 0 4px 12px rgba(0, 161, 214, 0.3);
        }
        .search-container { 
            display: flex; 
            gap: 12px; 
            flex-wrap: wrap;
        }
        #search-input { 
            flex: 1; 
            min-width: 250px;
            padding: 16px 20px; 
            font-size: 16px; 
            border: 2px solid #e9ecef; 
            border-radius: 12px; 
            outline: none; 
            background: white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            transition: all 0.3s ease;
        }
        #search-input:focus { 
            border-color: #00a1d6; 
            box-shadow: 0 0 0 4px rgba(0, 161, 214, 0.1);
        }
        #search-btn { 
            padding: 0 32px; 
            background: linear-gradient(135deg, #00a1d6 0%, #00c6ff 100%);
            color: white; 
            border: none; 
            border-radius: 12px; 
            font-size: 16px; 
            font-weight: 600;
            cursor: pointer; 
            white-space: nowrap;
            box-shadow: 0 4px 15px rgba(0, 161, 214, 0.3);
            transition: all 0.3s ease;
        }
        #search-btn:hover { 
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 161, 214, 0.4);
        }

        /* --- ç»Ÿè®¡ä¿¡æ¯æ  --- */
        .stats-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding: 0 5px;
        }
        .stats-text {
            font-size: 13px;
            color: #6c757d;
            font-weight: 500;
        }

        /* --- é€šç”¨åˆ—è¡¨ä¸è¿›åº¦ --- */
        .progress-msg { 
            text-align: center; 
            color: #495057; 
            padding: 60px 20px; 
            font-size: 16px; 
            font-weight: 500;
        }
        .empty-msg { 
            text-align: center; 
            color: #6c757d; 
            padding: 60px 20px; 
            font-size: 16px; 
            display: none;
            font-weight: 500;
        }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* --- Tab 1: æ’è¡Œæ ·å¼ (ä¼˜åŒ–ç‰ˆ) --- */
        #rank-list { list-style: none; padding: 0; margin-bottom: 35px; }
        .rank-item {
            padding: 22px 25px;
            margin-bottom: 15px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
            transition: all 0.3s ease;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 20px;
            flex-wrap: wrap;
        }
        .rank-item:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(0,0,0,0.08); }
        .rank-main { flex: 1; min-width: 250px; }
        .rank-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 8px;
        }
        .rank-badge {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 800;
            font-size: 14px;
            flex-shrink: 0;
        }
        .rank-1 { background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%); color: #8b6914; }
        .rank-2 { background: linear-gradient(135deg, #c0c0c0 0%, #e8e8e8 100%); color: #5a5a5a; }
        .rank-3 { background: linear-gradient(135deg, #cd7f32 0%, #e9a66a 100%); color: #5c3a1a; }
        .rank-other { background: #f8f9fa; color: #6c757d; border: 1px solid #e9ecef; }
        .song-title-large {
            font-size: 20px;
            font-weight: 800;
            color: #2c3e50;
            line-height: 1.3;
        }
        .info-chip {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 13px;
            font-weight: 500;
            margin-top: 6px;
        }
        .chip-artist { background: #e3f2fd; color: #1565c0; }
        .count-badge {
            padding: 8px 18px;
            border-radius: 20px;
            font-size: 16px;
            font-weight: 800;
            background: linear-gradient(135deg, #6f42c1 0%, #8a6edb 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(111, 66, 193, 0.3);
            white-space: nowrap;
        }
        .perf-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 12px;
            border-top: 1px solid #f1f3f5;
            padding-top: 12px;
        }
        .perf-link {
            display: inline-block;
            padding: 5px 12px;
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            font-size: 12px;
            color: #495057;
            text-decoration: none;
            transition: all 0.2s;
        }
        .perf-link:hover {
            border-color: #00a1d6;
            color: #00a1d6;
            background: #f0f9ff;
            transform: translateY(-1px);
        }

        /* --- Tab 2: VTuber åˆ†ç±»æ ·å¼ --- */
        #vtuber-list { list-style: none; padding: 0; margin-bottom: 35px; }
        .vtuber-group {
            margin-bottom: 30px;
            background: white;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }
        .vtuber-header {
            padding: 18px 25px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .vtuber-name {
            font-size: 20px;
            font-weight: 800;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .vtuber-count {
            font-size: 14px;
            opacity: 0.9;
            background: rgba(255,255,255,0.2);
            padding: 4px 12px;
            border-radius: 12px;
        }
        .vtuber-songs {
            padding: 20px 25px;
        }
        .vtuber-song-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px dashed #f1f3f5;
        }
        .vtuber-song-item:last-child { border-bottom: none; }
        .vtuber-song-title {
            font-weight: 600;
            color: #2c3e50;
            font-size: 15px;
        }
        .vtuber-song-meta {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .mini-count {
            font-size: 12px;
            color: #6c757d;
            background: #f8f9fa;
            padding: 2px 8px;
            border-radius: 8px;
        }

        /* --- åˆ†é¡µ (å¤ç”¨) --- */
        .pagination { 
            display: flex; 
            justify-content: center; 
            align-items: center;
            gap: 8px; 
            flex-wrap: wrap;
            margin-top: 30px;
            padding: 20px;
        }
        .page-btn { 
            padding: 10px 16px; 
            border: 1px solid #e9ecef; 
            border-radius: 8px; 
            background: white; 
            cursor: pointer; 
            font-size: 14px;
            font-weight: 500;
            color: #495057;
            min-width: 44px;
            text-align: center;
            transition: all 0.2s ease;
            box-shadow: 0 2px 6px rgba(0,0,0,0.04);
        }
        .page-btn:hover:not(.disabled):not(.active) { 
            background: #f8f9fa;
            border-color: #00a1d6;
            color: #00a1d6;
        }
        .page-btn.active { 
            background: linear-gradient(135deg, #00a1d6 0%, #00c6ff 100%);
            color: white; 
            border-color: transparent;
            box-shadow: 0 4px 12px rgba(0, 161, 214, 0.3);
        }
        .page-btn.disabled { 
            cursor: not-allowed; 
            color: #adb5bd; 
            background: #f8f9fa;
            border-color: #e9ecef;
            box-shadow: none;
        }
    </style>
</head>
<body>
    <h1>ğŸ“Š æ­Œæ›²ç»Ÿè®¡ä¸åˆ†æ</h1>
    <div class="sub-header">
        æŸ¥çœ‹æ­Œæ›²å‡ºåœºé¢‘ç‡ä¸ VTuber ä¸ªäººæ­Œå• | <a href="index.html" class="nav-link">è¿”å›æ­Œæ›²æŸ¥è¯¢ç«™</a>
    </div>

    <!-- Tab åˆ‡æ¢å™¨ -->
    <div class="tabs-container">
        <button class="tab-btn active" data-tab="rank">ğŸ† æ­Œæ›²æ€»å‡ºåœºæ’è¡Œ</button>
        <button class="tab-btn" data-tab="vtuber">ğŸ¤ æŒ‰ VTuber åˆ†ç±»</button>
    </div>

    <!-- ç­›é€‰ä¸æœç´¢ (å…±ç”¨) -->
    <div class="filter-search-container">
        <div class="filter-bar" id="filter-bar">
            <span class="filter-label">ğŸ” ç­›é€‰æ¥æº/VTuberï¼š</span>
        </div>
        <div class="search-container">
            <input type="text" id="search-input" placeholder="è¾“å…¥æ­Œåæˆ–æ­Œæ‰‹æœç´¢...">
            <button id="search-btn">ğŸ” æœç´¢</button>
        </div>
    </div>

    <div class="stats-bar">
        <div class="stats-text" id="summary-text">åŠ è½½ä¸­...</div>
    </div>

    <div class="progress-msg" id="progress-msg">ğŸ“¥ æ­£åœ¨åŠ è½½å¹¶ç»Ÿè®¡æ•°æ®...</div>
    <div class="empty-msg" id="empty-msg">âŒ æš‚æ— æ•°æ®</div>

    <!-- Tab 1 å†…å®¹ï¼šæ’è¡Œ -->
    <div id="tab-rank" class="tab-content active">
        <ul id="rank-list"></ul>
        <div class="pagination" id="pagination-rank"></div>
    </div>

    <!-- Tab 2 å†…å®¹ï¼šVTuber åˆ†ç±» -->
    <div id="tab-vtuber" class="tab-content">
        <ul id="vtuber-list"></ul>
        <!-- VTuber åˆ†ç±»æš‚æ—¶ä¸åˆ†é¡µï¼Œæˆ–è€…å¯ä»¥åç»­æ·»åŠ  -->
    </div>

    <script>
        // å…¨å±€æ•°æ®
        window.SONG_DATA = [];
        let originalData = [];
        let fileNames = [];
        let FILE_TO_ALIAS = {};
        
        // å½“å‰çŠ¶æ€
        let activeTab = 'rank'; // 'rank' or 'vtuber'
        let activeFilter = 'all';
        let searchKeyword = '';
        const PAGE_SIZE = 30;
        let currentRankPage = 1;

        // å·¥å…·å‡½æ•°
        function isValidArtist(artist) {
            if (!artist || artist.trim() === '') return false;
            if (artist.includes('æ¥æºå¤„æœªæä¾›æ ‡å‡†æ ¼å¼æ­Œæ‰‹')) return false;
            return true;
        }
        function normalizeString(str) {
            if (!str) return '';
            let s = str.trim();
            s = s.replace(/[\uFF01-\uFF5E]/g, ch => String.fromCharCode(ch.charCodeAt(0) - 0xFEE0));
            s = s.replace(/\u3000/g, ' ');
            s = s.replace(/[ï½ã€œËœ]/g, '~').replace(/[â€”â€“â€•]/g, '-');
            s = s.replace(/\s+/g, ' ');
            return s;
        }

        // ========== 1. æ•°æ®èšåˆé€»è¾‘ ==========
        
        // èšåˆç±»å‹ 1: æŒ‰ "æ­Œå+æ­Œæ‰‹" èšåˆ (ç”¨äºæ’è¡Œ)
        function aggregateBySong(data) {
            const map = new Map();
            data.forEach(item => {
                const artist = item.artist || '';
                if (!isValidArtist(artist)) return;

                const title = item.title || 'æœªçŸ¥æ­Œæ›²';
                const key = `${normalizeString(title)}|${normalizeString(artist)}`;

                if (!map.has(key)) {
                    map.set(key, {
                        title: title,
                        artist: artist,
                        count: 0,
                        performances: []
                    });
                }
                const entry = map.get(key);
                entry.count++;
                entry.performances.push({
                    link: item.link,
                    collection: item.collection || 'æœªçŸ¥åˆé›†'
                });
            });
            const arr = Array.from(map.values());
            arr.sort((a, b) => b.count - a.count);
            return arr;
        }

        // èšåˆç±»å‹ 2: æŒ‰ "æ­Œæ‰‹/VTuber" èšåˆ (ç”¨äºåˆ†ç±»)
        function aggregateByVtuber(data) {
            const map = new Map();
            data.forEach(item => {
                const artist = item.artist || '';
                if (!isValidArtist(artist)) return;

                // è¿™é‡Œçš„ key å°±æ˜¯æ­Œæ‰‹å
                const key = normalizeString(artist);
                if (!map.has(key)) {
                    map.set(key, {
                        name: artist, // ä¿ç•™åŸå§‹æ˜¾ç¤ºå
                        songs: new Map() // ç”¨ Map å­˜è¯¥æ­Œæ‰‹çš„æ­Œæ›²å»é‡
                    });
                }
                const vtuberEntry = map.get(key);
                
                // ç»Ÿè®¡è¯¥æ­Œæ‰‹çš„è¿™é¦–æ­Œ
                const songKey = normalizeString(item.title || 'æœªçŸ¥');
                if (!vtuberEntry.songs.has(songKey)) {
                    vtuberEntry.songs.set(songKey, {
                        title: item.title || 'æœªçŸ¥æ­Œæ›²',
                        count: 0,
                        links: []
                    });
                }
                const songEntry = vtuberEntry.songs.get(songKey);
                songEntry.count++;
                if (item.link) songEntry.links.push(item.link);
            });

            // è½¬ä¸ºæ•°ç»„å¹¶æ’åº
            const result = Array.from(map.values());
            // æŒ‰æ­Œæ›²æ€»æ•°æ’åº
            result.sort((a, b) => {
                const sumA = Array.from(a.songs.values()).reduce((acc, s) => acc + s.count, 0);
                const sumB = Array.from(b.songs.values()).reduce((acc, s) => acc + s.count, 0);
                return sumB - sumA;
            });

            // å†…éƒ¨æ­Œæ›²ä¹ŸæŒ‰æ¬¡æ•°æ’åº
            result.forEach(v => {
                const songArr = Array.from(v.songs.values());
                songArr.sort((a, b) => b.count - a.count);
                v.songs = songArr; // æ›¿æ¢ä¸ºæ•°ç»„
                v.totalCount = songArr.reduce((acc, s) => acc + s.count, 0);
            });

            return result;
        }

        // ========== 2. ç­›é€‰ä¸æœç´¢é€»è¾‘ ==========
        function getFilteredData() {
            let data = [...originalData];

            // 1. æŒ‰æ¥æºç­›é€‰ (activeFilter å¯èƒ½æ˜¯ 'all' æˆ– æ–‡ä»¶å æˆ– 'missing-artist')
            if (activeFilter !== 'all') {
                if (activeFilter === 'missing-artist') {
                    data = data.filter(item => !isValidArtist(item.artist));
                } else {
                    data = data.filter(item => item.source === activeFilter);
                }
            }

            // 2. æŒ‰å…³é”®è¯æœç´¢
            if (searchKeyword) {
                const kw = searchKeyword.toLowerCase();
                data = data.filter(item => {
                    const t = (item.title || '').toLowerCase();
                    const a = (item.artist || '').toLowerCase();
                    const c = (item.collection || '').toLowerCase();
                    return t.includes(kw) || a.includes(kw) || c.includes(kw);
                });
            }

            return data;
        }

        // ========== 3. æ¸²æŸ“é€»è¾‘ ==========

        function generateFilterButtons() {
            const filterBar = document.getElementById('filter-bar');
            filterBar.innerHTML = '<span class="filter-label">ğŸ” ç­›é€‰æ¥æº/VTuberï¼š</span>';

            // å…¨éƒ¨
            const allBtn = document.createElement('button');
            allBtn.className = `filter-btn ${activeFilter === 'all' ? 'active' : ''}`;
            allBtn.textContent = 'å…¨éƒ¨';
            allBtn.onclick = () => { activeFilter = 'all'; currentRankPage = 1; updateAllViews(); };
            filterBar.appendChild(allBtn);

            const spacer = document.createElement('span');
            spacer.style.width = '10px';
            filterBar.appendChild(spacer);

            // æ¥æºæ–‡ä»¶
            fileNames.forEach(fileName => {
                const fileBase = fileName.replace('.js', '');
                const btnText = FILE_TO_ALIAS[fileBase] || fileBase;
                const btn = document.createElement('button');
                btn.className = `filter-btn ${activeFilter === fileName ? 'active' : ''}`;
                btn.textContent = btnText;
                btn.onclick = () => { activeFilter = fileName; currentRankPage = 1; updateAllViews(); };
                filterBar.appendChild(btn);
            });
        }

        // --- Tab 1 æ¸²æŸ“: æ’è¡Œ ---
        function renderRankList(data) {
            const listEl = document.getElementById('rank-list');
            const aggData = aggregateBySong(data);
            
            // æ›´æ–°æ‘˜è¦
            document.getElementById('summary-text').textContent = `ğŸ“Š å…±ç»Ÿè®¡ ${aggData.length} é¦–ä¸åŒçš„â€œæ­Œæ›²+æ­Œæ‰‹â€ç»„åˆ`;

            // åˆ†é¡µ
            const start = (currentRankPage - 1) * PAGE_SIZE;
            const end = start + PAGE_SIZE;
            const pageData = aggData.slice(start, end);

            if (pageData.length === 0) {
                document.getElementById('empty-msg').style.display = 'block';
                listEl.innerHTML = '';
            } else {
                document.getElementById('empty-msg').style.display = 'none';
                listEl.innerHTML = '';
                
                pageData.forEach((item, idx) => {
                    const globalRank = start + idx + 1;
                    let rankClass = 'rank-other';
                    if (globalRank === 1) rankClass = 'rank-1';
                    else if (globalRank === 2) rankClass = 'rank-2';
                    else if (globalRank === 3) rankClass = 'rank-3';

                    const linksHtml = item.performances.slice(0, 5).map(p => // åªæ˜¾ç¤ºå‰5ä¸ªé“¾æ¥é˜²æ­¢å¤ªé•¿
                        `<a href="${p.link}" target="_blank" class="perf-link">${p.collection}</a>`
                    ).join('');
                    const moreHint = item.performances.length > 5 ? `<span style="font-size:12px;color:#adb5bd;">...è¿˜æœ‰ ${item.performances.length - 5} ä¸ªåœºæ¬¡</span>` : '';

                    const li = document.createElement('li');
                    li.className = 'rank-item';
                    li.innerHTML = `
                        <div class="rank-main">
                            <div class="rank-header">
                                <div class="rank-badge ${rankClass}">${globalRank}</div>
                                <div>
                                    <div class="song-title-large">${item.title}</div>
                                    <span class="info-chip chip-artist">ğŸ¤ ${item.artist}</span>
                                </div>
                            </div>
                            <div class="perf-grid">
                                ${linksHtml}
                                ${moreHint}
                            </div>
                        </div>
                        <div class="count-badge">${item.count} æ¬¡</div>
                    `;
                    listEl.appendChild(li);
                });
            }

            renderPagination(aggData.length, 'rank');
        }

        // --- Tab 2 æ¸²æŸ“: VTuber åˆ†ç±» ---
        function renderVtuberList(data) {
            const listEl = document.getElementById('vtuber-list');
            const aggData = aggregateByVtuber(data);

            // æ›´æ–°æ‘˜è¦ (è¦†ç›–)
            document.getElementById('summary-text').textContent = `ğŸ¤ å…±æ”¶å½• ${aggData.length} ä½ VTuber/æ­Œæ‰‹çš„æ­Œå•`;

            if (aggData.length === 0) {
                document.getElementById('empty-msg').style.display = 'block';
                listEl.innerHTML = '';
            } else {
                document.getElementById('empty-msg').style.display = 'none';
                listEl.innerHTML = '';

                aggData.forEach(vtuber => {
                    const songsHtml = vtuber.songs.map(song => {
                        const firstLink = song.links[0] || '#';
                        return `
                            <div class="vtuber-song-item">
                                <div class="vtuber-song-title">${song.title}</div>
                                <div class="vtuber-song-meta">
                                    <span class="mini-count">å”±äº† ${song.count} æ¬¡</span>
                                    <a href="${firstLink}" target="_blank" class="perf-link" style="padding:4px 8px;">ç›´è¾¾</a>
                                </div>
                            </div>
                        `;
                    }).join('');

                    const li = document.createElement('li');
                    li.className = 'vtuber-group';
                    li.innerHTML = `
                        <div class="vtuber-header">
                            <div class="vtuber-name">
                                ğŸ™ï¸ ${vtuber.name}
                            </div>
                            <div class="vtuber-count">æ€»è®¡ ${vtuber.totalCount} é¦–æŠ•ç¨¿</div>
                        </div>
                        <div class="vtuber-songs">
                            ${songsHtml}
                        </div>
                    `;
                    listEl.appendChild(li);
                });
            }
        }

        // åˆ†é¡µæ¸²æŸ“
        function renderPagination(total, type) {
            const el = document.getElementById('pagination-rank');
            if (type !== 'rank') return; // VTuber tab æš‚æ—¶ä¸åˆ†é¡µ
            
            el.innerHTML = '';
            const totalPages = Math.ceil(total / PAGE_SIZE);
            if (totalPages <= 1) return;

            const prev = document.createElement('button');
            prev.className = `page-btn ${currentRankPage === 1 ? 'disabled' : ''}`;
            prev.textContent = 'ä¸Šä¸€é¡µ';
            prev.onclick = () => { if(currentRankPage>1) { currentRankPage--; updateAllViews(); } };
            el.appendChild(prev);

            const start = Math.max(1, currentRankPage - 3);
            const end = Math.min(totalPages, currentRankPage + 3);
            for(let i=start; i<=end; i++) {
                const btn = document.createElement('button');
                btn.className = `page-btn ${i === currentRankPage ? 'active' : ''}`;
                btn.textContent = i;
                btn.onclick = () => { currentRankPage = i; updateAllViews(); };
                el.appendChild(btn);
            }

            const next = document.createElement('button');
            next.className = `page-btn ${currentRankPage === totalPages ? 'disabled' : ''}`;
            next.textContent = 'ä¸‹ä¸€é¡µ';
            next.onclick = () => { if(currentRankPage < totalPages) { currentRankPage++; updateAllViews(); } };
            el.appendChild(next);
        }

        // ========== 4. æ€»æ§ä¸åˆå§‹åŒ– ==========

        function updateAllViews() {
            generateFilterButtons(); // ä¿æŒæŒ‰é’®çŠ¶æ€åŒæ­¥
            const data = getFilteredData();
            
            // æ§åˆ¶ç©ºçŠ¶æ€æ˜¾ç¤º
            if (data.length === 0) {
                document.getElementById('empty-msg').style.display = 'block';
                document.getElementById('rank-list').innerHTML = '';
                document.getElementById('vtuber-list').innerHTML = '';
                document.getElementById('summary-text').textContent = 'ğŸ˜” å½“å‰ç­›é€‰ä¸‹æ²¡æœ‰æ•°æ®';
            } else {
                document.getElementById('empty-msg').style.display = 'none';
                if (activeTab === 'rank') {
                    renderRankList(data);
                } else {
                    renderVtuberList(data);
                }
            }
        }

        function switchTab(tab) {
            activeTab = tab;
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelector(`.tab-btn[data-tab="${tab}"]`).classList.add('active');
            
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.getElementById(`tab-${tab}`).classList.add('active');

            updateAllViews();
        }

        // åŠ è½½æ•°æ® (å¤ç”¨ index.html é€»è¾‘)
        function loadScriptsParallel(fileList) {
            const progressMsg = document.getElementById('progress-msg');
            let loadedCount = 0;
            const totalFiles = fileList.length;

            const promises = fileList.map(fileName => {
                return new Promise((resolve) => {
                    const script = document.createElement('script');
                    script.src = `data/${fileName}`;
                    script.onload = () => {
                        const newDataCount = window.SONG_DATA.length - originalData.length;
                        if (newDataCount > 0) {
                            const newData = window.SONG_DATA.slice(-newDataCount);
                            newData.forEach(item => item.source = fileName);
                            originalData = [...window.SONG_DATA];
                        }
                        loadedCount++;
                        progressMsg.textContent = `ğŸ“¥ åŠ è½½æ•°æ® (${loadedCount}/${totalFiles})...`;
                        resolve();
                    };
                    script.onerror = () => resolve();
                    document.body.appendChild(script);
                });
            });
            return Promise.all(promises);
        }

        async function bootstrap() {
            try {
                const res = await fetch('data/index.json');
                if (!res.ok) throw new Error('æ— æ³•åŠ è½½ index.json');
                const config = await res.json();
                fileNames.push(...(config.files || []));
                FILE_TO_ALIAS = config.fileToAlias || {};

                await loadScriptsParallel(fileNames);

                document.getElementById('progress-msg').style.display = 'none';
                
                // ç»‘å®š Tab äº‹ä»¶
                document.querySelectorAll('.tab-btn').forEach(btn => {
                    btn.addEventListener('click', () => switchTab(btn.dataset.tab));
                });

                // ç»‘å®šæœç´¢äº‹ä»¶
                const searchInput = document.getElementById('search-input');
                const searchBtn = document.getElementById('search-btn');
                
                const doSearch = () => {
                    searchKeyword = searchInput.value.trim();
                    currentRankPage = 1;
                    updateAllViews();
                };

                searchBtn.addEventListener('click', doSearch);
                searchInput.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') doSearch();
                });

                // åˆå§‹åŒ–
                generateFilterButtons();
                updateAllViews();

            } catch (err) {
                console.error(err);
                document.getElementById('progress-msg').textContent = `âŒ åŠ è½½å¤±è´¥: ${err.message}`;
            }
        }

        document.addEventListener('DOMContentLoaded', bootstrap);
    </script>
</body>
</html>
