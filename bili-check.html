<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>æ­Œåº“è·¨åº“é‡å¤æ£€æŸ¥</title>
<link rel="icon" href="https://cdn-icons-png.flaticon.com/16/889/889666.png">
<style>
/* åŸºç¡€æ ·å¼ */
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;background:#f6f7f9;padding:20px}
.main{max-width:1200px;margin:0 auto}
.header{text-align:center;margin-bottom:24px}
.header h2{color:#2c3e50;margin-bottom:8px}
.header p{color:#6c757d;font-size:14px}
/* æ–°å¢å¯¼èˆªé“¾æ¥æ ·å¼ */
.sub-header{text-align:center;margin-bottom:16px;font-size:14px;color:#6c757d}
.nav-link{color:#00a1d6;text-decoration:none;font-weight:500}
.nav-link:hover{text-decoration:underline}

/* åŠŸèƒ½æ ‡ç­¾åˆ‡æ¢ */
.function-tabs{display:flex;justify-content:center;gap:8px;margin-bottom:24px;border-bottom:1px solid #e9ecef;padding-bottom:8px}
.function-tab{padding:8px 20px;background:white;border:1px solid #ddd;border-radius:8px;cursor:pointer;font-size:14px;font-weight:500;transition:all 0.2s}
.function-tab:hover{border-color:#00a1d6;color:#00a1d6}
.function-tab.active{background:#00a1d6;color:white;border-color:#00a1d6}

/* æœç´¢æ ï¼ˆBVæŸ¥é‡ï¼‰ */
.search-box{display:flex;gap:12px;margin-bottom:24px;flex-wrap:wrap}
#bvInput{flex:1;min-width:280px;padding:14px 16px;border:1px solid #ddd;border-radius:8px;font-size:14px;outline:none;transition:border 0.2s}
#bvInput:focus{border-color:#00a1d6;box-shadow:0 0 0 3px rgba(0,161,214,0.1)}
#searchBtn{padding:0 24px;background:#00a1d6;color:white;border:0;border-radius:8px;cursor:pointer;font-size:14px;font-weight:500;transition:background 0.2s}
#searchBtn:hover{background:#008fb3}

/* æ­ŒåæŸ¥è¯¢åŒºï¼ˆæ–°å¢ï¼‰ */
.title-search-area{margin-bottom:24px;display:none}
.title-search-area.active{display:block}
#titleInput{width:100%;min-height:120px;padding:14px 16px;border:1px solid #ddd;border-radius:8px;font-size:14px;outline:none;transition:border 0.2s;margin-bottom:16px;resize:vertical;font-family:inherit}
#titleInput:focus{border-color:#00a1d6;box-shadow:0 0 0 3px rgba(0,161,214,0.1)}
.title-controls{display:flex;gap:12px;flex-wrap:wrap;justify-content:flex-end}
#searchTitleBtn{padding:8px 24px;background:#00a1d6;color:white;border:0;border-radius:8px;cursor:pointer;font-size:14px;font-weight:500}
#searchTitleBtn:hover{background:#008fb3}
#validateBtn{padding:8px 24px;background:#28a745;color:white;border:0;border-radius:8px;cursor:pointer;font-size:14px;font-weight:500;margin-left:8px}
#validateBtn:hover{background:#218838}

/* æ­Œæ‰‹é€‰æ‹©åŒºï¼ˆæ–°å¢ï¼‰ */
.artist-select-area{margin-bottom:24px;display:none}
.artist-select-area.active{display:block}
.select-item{background:white;border-radius:8px;padding:16px;margin-bottom:12px;box-shadow:0 2px 4px rgba(0,0,0,0.04)}
.select-item h4{margin-bottom:8px;color:#2c3e50;font-size:15px;display:flex;align-items:center;gap:8px}
.valid-tag{color:#28a745;font-size:12px;font-weight:normal}
.invalid-tag{color:#dc3545;font-size:12px;font-weight:normal}
.artist-options{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:8px}
.artist-option{padding:4px 12px;background:#f1f3f5;border:1px solid #ddd;border-radius:6px;cursor:pointer;font-size:13px}
.artist-option:hover{border-color:#00a1d6;color:#00a1d6}
.artist-option.selected{background:#00a1d6;color:white;border-color:#00a1d6}
.artist-option.matched{background:#e8f5e9;border-color:#28a745;color:#28a745}
/* æ–°å¢ï¼šé”™è¯¯ç­”æ¡ˆæ ·å¼ */
.artist-option.error{background:#fdf2f8;border:1px solid #dc3545;color:#dc3545;font-weight:500}
.artist-option.error:hover{background:#fef0f5;border-color:#c82333;color:#c82333}
/* æ–°å¢ï¼šæ¥æºæ ‡ç­¾æ ·å¼ */
.source-label{font-size:11px;color:#6c757d;margin-left:6px}
.no-result{color:#6c757d;font-size:13px;padding:4px 0}

/* æ’åˆ—ç»„åˆåŒºï¼ˆæ–°å¢ï¼‰ */
.combination-area{margin-bottom:24px;display:none;padding:16px;background:white;border-radius:8px;box-shadow:0 2px 4px rgba(0,0,0,0.04)}
.combination-area.active{display:block}
.combination-area h4{margin-bottom:12px;color:#2c3e50;font-size:15px}
.combination-list{max-height:200px;overflow-y:auto;margin-bottom:12px;border:1px solid #e9ecef;border-radius:6px;padding:8px}
.combination-item{padding:6px 8px;margin-bottom:4px;border-radius:4px;cursor:pointer;font-size:14px}
.combination-item:hover{background:#f1f3f5}
.combination-item.selected{background:#00a1d6;color:white}
.combination-controls{display:flex;gap:12px;justify-content:flex-end}
.generate-combination-btn{padding:6px 16px;background:#6f42c1;color:white;border:0;border-radius:6px;cursor:pointer;font-size:13px}
.generate-combination-btn:hover{background:#5a32a3}

/* ç»“æœç”ŸæˆåŒºï¼ˆæ–°å¢ï¼‰ */
.result-generate-area{margin-bottom:24px;display:none}
.result-generate-area.active{display:block}
#resultText{width:100%;min-height:150px;padding:14px 16px;border:1px solid #ddd;border-radius:8px;font-size:14px;outline:none;transition:border 0.2s;margin-bottom:16px;resize:vertical;font-family:inherit;background:#f8f9fa}
#copyResultBtn{padding:8px 24px;background:#6f42c1;color:white;border:0;border-radius:8px;cursor:pointer;font-size:14px;font-weight:500}
#copyResultBtn:hover{background:#5a32a3}

/* æ¥æºæ ‡ç­¾é¡µ */
.source-tabs{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:20px;padding-bottom:12px;border-bottom:1px solid #e9ecef}
.source-tab{padding:8px 16px;background:white;border:1px solid #ddd;border-radius:6px;cursor:pointer;font-size:14px;transition:all 0.2s}
.source-tab:hover{border-color:#00a1d6;color:#00a1d6}
.source-tab.active{background:#00a1d6;color:white;border-color:#00a1d6}

/* ç­›é€‰æ  + ç»Ÿè®¡æ  */
.filter-bar{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;flex-wrap:wrap;gap:12px}
.stat-info{font-size:14px;color:#495057}
.filter-btn{padding:6px 16px;background:#28a745;color:white;border:0;border-radius:6px;cursor:pointer;font-size:13px;margin-left:8px}
.filter-btn:hover{background:#218838}
.filter-btn.active{background:#1e7e34}

/* å¤åˆ¶ç­›é€‰åŒº */
.copy-controls{display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin-top:10px}
.copy-controls label{font-size:13px;color:#495057;display:flex;align-items:center;gap:4px}
.copy-controls input{width:16px;height:16px}
.copy-btn{padding:6px 16px;background:#6f42c1;color:white;border:0;border-radius:6px;cursor:pointer;font-size:13px}
.copy-btn:hover{background:#5a32a3}

/* æ­Œæ›²åˆ—è¡¨ */
.result-list{margin-bottom:30px}
.song-item{background:white;border-radius:8px;padding:16px;margin-bottom:12px;border-left:4px solid #ddd;box-shadow:0 2px 4px rgba(0,0,0,0.04)}
.song-item.dup{border-left-color:#dc3545}
.song-item.unique{border-left-color:#28a745}
.song-item.hidden{display:none}

/* æ­Œæ›²æ ‡é¢˜ï¼ˆæŠ˜å æ€æ ¸å¿ƒï¼‰ */
.song-title{display:flex;justify-content:space-between;align-items:flex-start;cursor:pointer;font-weight:600;color:#2c3e50;margin-bottom:8px}
.title-left{flex:1}
.title-right{text-align:right;min-width:120px}
.dup-tag{display:inline-block;background:#dc3545;color:white;font-size:12px;padding:2px 8px;border-radius:4px;margin-left:8px}
.unique-tag{display:inline-block;background:#28a745;color:white;font-size:12px;padding:2px 8px;border-radius:4px;margin-left:8px}
.collapse-toggle{font-size:18px;color:#6c757d;cursor:pointer;margin-left:8px}

/* æŠ˜å æ€æ‘˜è¦ä¿¡æ¯ */
.collapse-summary{font-size:13px;color:#6c757d;margin-bottom:8px;padding-bottom:8px;border-bottom:1px solid #f1f3f5}
.summary-item{margin-bottom:4px}
.dup-preview{margin-top:6px}
.dup-preview-item{font-size:12px;color:#495057;margin-top:2px;display:flex;align-items:center}
.dup-preview-more{font-size:12px;color:#00a1d6;margin-top:4px}

/* å±•å¼€å†…å®¹ */
.collapse-content{max-height:0;overflow:hidden;transition:max-height 0.3s ease}
.collapse-content.show{max-height:5000px}
.meta-info{font-size:13px;color:#495057;line-height:1.8}
.meta-row{margin-bottom:6px}
.sub-info{margin-top:12px;padding-top:12px;border-top:1px solid #e9ecef}
.dup-list{margin-top:8px}
.dup-item{display:flex;align-items:center;margin-top:4px;padding:4px 8px;background:#f8f9fa;border-radius:4px;font-size:12px}
.bv-tag{display:inline-block;background:#6f42c1;color:white;font-size:11px;padding:2px 6px;border-radius:3px;margin-right:8px}

/* å¤åˆ¶æç¤º */
.copy-toast{position:fixed;bottom:30px;right:30px;padding:10px 20px;background:rgba(0,0,0,0.8);color:white;border-radius:4px;font-size:14px;opacity:0;transform:translateY(20px);transition:all 0.3s;pointer-events:none;z-index:9999}
.copy-toast.show{opacity:1;transform:translateY(0)}
</style>
</head>
<body>
<div class="main">
  <!-- å¤´éƒ¨ -->
  <div class="header">
    <h2>ğŸµ æ­Œæ›²æ•°æ®ç®¡ç†å·¥å…·</h2>
    <div class="sub-header">
      <a href="index.html" class="nav-link">è¿”å›é¦–é¡µ</a> | 
      <a href="stats.html" class="nav-link">æŸ¥çœ‹æ¼”å”±è€…ç»Ÿè®¡ä¸æ’è¡Œ</a> | 
      <a href="bili-check.html" class="nav-link">BVå·æŸ¥é‡å·¥å…·</a>
    </div>
    <p>æ”¯æŒBVå·æŸ¥é‡ã€æ­Œå-æ­Œæ‰‹æ‰¹é‡æŸ¥è¯¢/æ ¡éªŒ | è‡ªåŠ¨ç”Ÿæˆæ’åˆ—ç»„åˆ</p>
  </div>

  <!-- åŠŸèƒ½æ ‡ç­¾åˆ‡æ¢ -->
  <div class="function-tabs">
    <div class="function-tab active" id="bvCheckTab">BVå·æŸ¥é‡</div>
    <div class="function-tab" id="titleSearchTab">æ­Œå-æ­Œæ‰‹æŸ¥è¯¢/æ ¡éªŒ</div>
  </div>

  <!-- BVå·æŸ¥é‡åŠŸèƒ½åŒº -->
  <div id="bvCheckArea">
    <!-- æœç´¢æ  -->
    <div class="search-box">
      <input id="bvInput" placeholder="è¾“å…¥BVå·æˆ–Bç«™è§†é¢‘é“¾æ¥ï¼ˆä¾‹å¦‚ï¼šBV1pDfaByERNï¼‰" type="text">
      <button id="searchBtn">å¼€å§‹åˆ†æ</button>
    </div>

    <!-- æ¥æºæ ‡ç­¾é¡µ -->
    <div class="source-tabs" id="tabContainer"></div>

    <!-- ç­›é€‰æ  + ç»Ÿè®¡ -->
    <div class="filter-bar">
      <div class="stat-info" id="statInfo">è¯·è¾“å…¥BVå·å¼€å§‹åˆ†æ</div>
      <div>
        <button class="filter-btn" id="showAllBtn">æ˜¾ç¤ºå…¨éƒ¨æ­Œæ›²</button>
        <button class="filter-btn" id="showUniqueBtn">åªçœ‹æœªé‡å¤æ­Œæ›²</button>
      </div>
    </div>

    <!-- å¤åˆ¶ç­›é€‰åŒº -->
    <div class="copy-controls">
      <label><input type="checkbox" id="copyOnlyUnique" checked> ä»…å¤åˆ¶éé‡å¤æ­Œæ›²</label>
      <label><input type="checkbox" id="copyTitle" checked> æ­Œå</label>
      <label><input type="checkbox" id="copyLink"> æ­Œæ›²é“¾æ¥</label>
      <label><input type="checkbox" id="copyCount"> å‡ºç°æ¬¡æ•°</label>
      <!-- æ–°å¢ï¼šå¤åˆ¶æ¥æºé€‰é¡¹ -->
      <label><input type="checkbox" id="copySource"> æ¥æº</label>
      <label><input type="radio" name="copyFormat" id="copyText" checked> çº¯æ–‡æœ¬</label>
      <label><input type="radio" name="copyFormat" id="copyTable"> è¡¨æ ¼</label>
      <button class="copy-btn" id="copyBtn">ğŸ“‹ å¤åˆ¶ç»“æœ</button>
    </div>

    <!-- ç»“æœåˆ—è¡¨ -->
    <div class="result-list" id="resultList"></div>
  </div>

  <!-- æ­Œå-æ­Œæ‰‹æŸ¥è¯¢åŠŸèƒ½åŒºï¼ˆæ–°å¢ï¼‰ -->
  <div id="titleSearchArea" class="title-search-area">
    <!-- æ­Œåè¾“å…¥æ¡† -->
    <textarea id="titleInput" placeholder="æ”¯æŒä¸¤ç§è¾“å…¥æ ¼å¼ï¼š
1. çº¯æ­Œåï¼ˆæ¯è¡Œä¸€ä¸ªï¼‰ï¼š
çµ¶é ‚è®ƒæ­Œ
æœˆå…‰
ã‚·ãƒ‹ã‚«ãƒ«ãƒ»ã‚·ãƒ‹ã‚«ãƒ«

2. å®Œæ•´æ ¼å¼ï¼ˆå¸¦åºå·å’Œæ­Œæ‰‹ï¼‰ï¼š
01. çµ¶é ‚è®ƒæ­Œ - å’Œã¬ã‹
02. æœˆå…‰ - ã¯ã‚‹ã¾ãã”ã¯ã‚“
03. ã‚·ãƒ‹ã‚«ãƒ«ãƒ»ã‚·ãƒ‹ã‚«ãƒ« - åæ¯ feat. Such"></textarea>
    
    <div class="title-controls">
      <button id="searchTitleBtn">æŸ¥è¯¢/æ ¡éªŒæ­Œæ‰‹</button>
      <button id="validateBtn">ç”Ÿæˆæ’åˆ—ç»„åˆ</button>
    </div>

    <!-- æ­Œæ‰‹é€‰æ‹©åŒº -->
    <div class="artist-select-area" id="artistSelectArea">
      <div id="artistSelectContainer"></div>
    </div>

    <!-- æ’åˆ—ç»„åˆåŒºï¼ˆæ–°å¢ï¼‰ -->
    <div class="combination-area" id="combinationArea">
      <h4>ğŸ­ æ‰€æœ‰å¯èƒ½çš„æ’åˆ—ç»„åˆ</h4>
      <div class="combination-list" id="combinationList"></div>
      <div class="combination-controls">
        <button class="generate-combination-btn" id="useCombinationBtn">ä½¿ç”¨é€‰ä¸­çš„ç»„åˆ</button>
      </div>
    </div>

    <!-- ç»“æœç”ŸæˆåŒº -->
    <div class="result-generate-area" id="resultGenerateArea">
      <textarea id="resultText" readonly placeholder="ç”Ÿæˆçš„ç»“æœå°†æ˜¾ç¤ºåœ¨è¿™é‡Œ..."></textarea>
      <button id="copyResultBtn">ğŸ“‹ å¤åˆ¶ç»“æœ</button>
    </div>
  </div>

  <!-- å¤åˆ¶æç¤º -->
  <div class="copy-toast" id="copyToast">å¤åˆ¶æˆåŠŸï¼</div>
</div>

<script>
// å…¨å±€å˜é‡
let allSongs = [];          // å…¨åº“æ­Œæ›²æ•°æ®
let fileList = [];          // JSæ–‡ä»¶åˆ—è¡¨
let fileAlias = {};         // æ–‡ä»¶åˆ«åæ˜ å°„
let currentTab = 'all';     // å½“å‰é€‰ä¸­çš„æ¥æºæ ‡ç­¾
let targetBvSongs = [];     // è¾“å…¥BVå¯¹åº”çš„æ‰€æœ‰æ­Œæ›²ï¼ˆå…¨åº“ç­›é€‰ï¼‰
let bvToSourceMap = new Map(); // BVå·åˆ°æ¥æºçš„æ˜ å°„
let analysisResult = [];    // æœ€æ–°åˆ†æç»“æœ
let showOnlyUnique = false; // æ˜¯å¦åªæ˜¾ç¤ºæœªé‡å¤æ­Œæ›²
let titleSearchResults = []; // æ­ŒåæŸ¥è¯¢ç»“æœ
let selectedArtists = {};   // é€‰ä¸­çš„æ­Œæ‰‹æ˜ å°„ {æ­Œå: æ­Œæ‰‹}
let inputFormatType = '';   // è¾“å…¥æ ¼å¼ç±»å‹ï¼špure(çº¯æ­Œå)/full(å®Œæ•´æ ¼å¼)
let allCombinations = [];   // æ‰€æœ‰å¯èƒ½çš„æ’åˆ—ç»„åˆ
let selectedCombination = ''; // é€‰ä¸­çš„æ’åˆ—ç»„åˆ

// ================= å·¥å…·å‡½æ•° =================
// æå–BVå·
function extractBV(str) {
  if (!str) return '';
  const match = str.match(/BV[a-zA-Z0-9]+/);
  return match ? match[0] : '';
}

// è·å–æ¥æºåˆ«åï¼ˆæ ¸å¿ƒæ–°å¢ï¼šç»Ÿä¸€å¤„ç†æ¥æºæ˜¾ç¤ºï¼‰
function getSourceAlias(source) {
  if (!source) return 'æœªçŸ¥æ¥æº';
  // å»æ‰.jsåç¼€åæŸ¥æ‰¾åˆ«å
  const key = source.replace('.js', '');
  return fileAlias[key] || source;
}

// æ˜¾ç¤ºå¤åˆ¶æç¤º
function showCopyToast() {
  const toast = document.getElementById('copyToast');
  toast.classList.add('show');
  setTimeout(() => toast.classList.remove('show'), 2000);
}

// åˆ‡æ¢åŠŸèƒ½æ ‡ç­¾
function switchFunctionTab(tabId) {
  // åˆ‡æ¢æ ‡ç­¾æ ·å¼
  document.querySelectorAll('.function-tab').forEach(tab => {
    tab.classList.toggle('active', tab.id === tabId);
  });
  
  // åˆ‡æ¢åŠŸèƒ½åŒºæ˜¾ç¤º
  document.getElementById('bvCheckArea').style.display = tabId === 'bvCheckTab' ? 'block' : 'none';
  document.getElementById('titleSearchArea').classList.toggle('active', tabId === 'titleSearchTab');
}

// åˆ‡æ¢æ˜¾ç¤ºæ¨¡å¼ï¼ˆå…¨éƒ¨/ä»…æœªé‡å¤ï¼‰
function toggleShowMode(onlyUnique) {
  showOnlyUnique = onlyUnique;
  // æ›´æ–°æŒ‰é’®æ ·å¼
  document.getElementById('showAllBtn').classList.toggle('active', !onlyUnique);
  document.getElementById('showUniqueBtn').classList.toggle('active', onlyUnique);
  // é‡æ–°æ¸²æŸ“åˆ—è¡¨
  renderSongList();
}

// è§£æè¾“å…¥å†…å®¹ï¼ˆæ”¯æŒä¸¤ç§æ ¼å¼ï¼‰
function parseInputContent() {
  const input = document.getElementById('titleInput').value.trim();
  if (!input) {
    alert('è¯·è¾“å…¥è¦æŸ¥è¯¢çš„æ­Œåï¼');
    return [];
  }
  
  const lines = input.split('\n').map(line => line.trim()).filter(line => line);
  const result = [];
  
  // æ£€æµ‹è¾“å…¥æ ¼å¼
  const fullFormatRegex = /^\d{1,2}\.\s*(.+?)\s*-\s*(.+)$/;
  let hasFullFormat = false;
  
  lines.forEach(line => {
    const fullMatch = line.match(fullFormatRegex);
    if (fullMatch) {
      hasFullFormat = true;
      // å®Œæ•´æ ¼å¼ï¼š01. çµ¶é ‚è®ƒæ­Œ - å’Œã¬ã‹
      result.push({
        title: fullMatch[1].trim(),
        inputArtist: fullMatch[2].trim(),
        line: line
      });
    } else {
      // çº¯æ­Œåæ ¼å¼
      result.push({
        title: line.trim(),
        inputArtist: '',
        line: line
      });
    }
  });
  
  // è®¾ç½®è¾“å…¥æ ¼å¼ç±»å‹
  inputFormatType = hasFullFormat ? 'full' : 'pure';
  
  return result;
}

// ç”Ÿæˆæ‰€æœ‰å¯èƒ½çš„æ’åˆ—ç»„åˆï¼ˆåŒ…å«é”™è¯¯ç­”æ¡ˆï¼‰
function generateAllCombinations() {
  if (titleSearchResults.length === 0) {
    alert('è¯·å…ˆæŸ¥è¯¢æ­Œæ‰‹ä¿¡æ¯ï¼');
    return;
  }
  
  // è·å–æ¯é¦–æ­Œçš„å¯é€‰æ­Œæ‰‹åˆ—è¡¨ï¼ˆåŒ…å«é”™è¯¯ç­”æ¡ˆï¼‰
  const optionsList = titleSearchResults.map(item => {
    let options = [];
    // å¦‚æœæœ‰è¾“å…¥çš„é”™è¯¯æ­Œæ‰‹ï¼Œå…ˆåŠ å…¥
    if (item.inputArtist && !item.isArtistValid && item.inputArtist.trim()) {
      options.push(item.inputArtist);
    }
    // å†åŠ å…¥æ­£ç¡®çš„æ­Œæ‰‹åˆ—è¡¨
    options = options.concat(item.artists.map(artistItem => artistItem.name));
    return options;
  });
  
  // é€’å½’ç”Ÿæˆç¬›å¡å°”ç§¯ï¼ˆæ’åˆ—ç»„åˆï¼‰
  function cartesianProduct(arr) {
    return arr.reduce((a, b) => {
      return a.flatMap(d => b.map(e => [d, e].flat()));
    }, [[]]);
  }
  
  // ç”Ÿæˆæ‰€æœ‰ç»„åˆ
  const combinations = cartesianProduct(optionsList);
  
  // è½¬æ¢ä¸ºæ–‡æœ¬æ ¼å¼
  allCombinations = combinations.map((comb, idx) => {
    let text = '';
    comb.forEach((artist, lineIdx) => {
      const num = (lineIdx + 1).toString().padStart(2, '0');
      const title = titleSearchResults[lineIdx].title;
      text += `${num}. ${title} ${artist ? '- ' + artist : ''}\n`;
    });
    return text.trim();
  });
  
  // å»é‡ï¼ˆé¿å…é‡å¤ç»„åˆï¼‰
  allCombinations = [...new Set(allCombinations)];
  
  // æ¸²æŸ“ç»„åˆåˆ—è¡¨
  renderCombinationList();
  
  // æ˜¾ç¤ºæ’åˆ—ç»„åˆåŒº
  document.getElementById('combinationArea').classList.add('active');
  
  return allCombinations;
}

// æ¸²æŸ“æ’åˆ—ç»„åˆåˆ—è¡¨
function renderCombinationList() {
  const container = document.getElementById('combinationList');
  container.innerHTML = '';
  
  if (allCombinations.length === 0) {
    container.innerHTML = '<div style="text-align:center;padding:8px;color:#6c757d;">æš‚æ— å¯ç”¨ç»„åˆ</div>';
    return;
  }
  
  allCombinations.forEach((comb, idx) => {
    const item = document.createElement('div');
    item.className = `combination-item ${idx === 0 ? 'selected' : ''}`;
    item.textContent = comb;
    item.dataset.index = idx;
    
    // é»˜è®¤é€‰ä¸­ç¬¬ä¸€ä¸ªç»„åˆ
    if (idx === 0) {
      selectedCombination = comb;
    }
    
    // ç‚¹å‡»é€‰ä¸­ç»„åˆ
    item.addEventListener('click', () => {
      // ç§»é™¤å…¶ä»–é€‰ä¸­çŠ¶æ€
      container.querySelectorAll('.combination-item').forEach(el => {
        el.classList.remove('selected');
      });
      // æ·»åŠ å½“å‰é€‰ä¸­çŠ¶æ€
      item.classList.add('selected');
      selectedCombination = comb;
    });
    
    container.appendChild(item);
  });
}

// ================= æ­Œå-æ­Œæ‰‹æŸ¥è¯¢/æ ¡éªŒåŠŸèƒ½ï¼ˆæ ¸å¿ƒå¢å¼ºï¼‰ =================
// æŸ¥è¯¢/æ ¡éªŒæ­Œæ‰‹ä¿¡æ¯
function searchAndValidateArtists() {
  const inputItems = parseInputContent();
  if (inputItems.length === 0) return;
  
  // æ¸…ç©ºä¹‹å‰çš„ç»“æœ
  titleSearchResults = [];
  selectedArtists = {};
  
  // éå†æ¯ä¸ªè¾“å…¥é¡¹æŸ¥è¯¢åŒ¹é…çš„æ­Œæ‰‹
  inputItems.forEach(item => {
    const title = item.title;
    const inputArtist = item.inputArtist;
    
    // ä¸åŒºåˆ†å¤§å°å†™åŒ¹é…æ­Œå
    const lowerTitle = title.toLowerCase().trim();
    const matchedSongs = allSongs.filter(song => 
      (song.title || '').toLowerCase().trim() === lowerTitle
    );
    
    // é‡æ„ï¼šæ”¶é›†æ­Œæ‰‹åŠå…¶æ¥æºä¿¡æ¯ï¼ˆå»é‡ï¼‰
    const artistMap = new Map(); // key: æ­Œæ‰‹å, value: æ¥æºåˆ—è¡¨
    matchedSongs.forEach(song => {
      const artist = song.artist || 'æœªçŸ¥æ­Œæ‰‹';
      const source = getSourceAlias(song.source);
      if (!artistMap.has(artist)) {
        artistMap.set(artist, new Set());
      }
      artistMap.get(artist).add(source);
    });
    
    // è½¬æ¢ä¸ºå¸¦æ¥æºçš„æ­Œæ‰‹åˆ—è¡¨
    const artists = Array.from(artistMap.entries()).map(([name, sources]) => ({
      name: name,
      sources: Array.from(sources).join(' / ')
    })).filter(Boolean);
    
    // æå–çº¯æ­Œæ‰‹ååˆ—è¡¨ï¼ˆç”¨äºæ ¡éªŒï¼‰
    const artistNames = artists.map(artist => artist.name);
    
    // æ ¡éªŒè¾“å…¥çš„æ­Œæ‰‹æ˜¯å¦æ­£ç¡®
    let isArtistValid = false;
    if (inputArtist && artistNames.length > 0) {
      isArtistValid = artistNames.some(artist => 
        artist.toLowerCase().trim() === inputArtist.toLowerCase().trim()
      );
    }
    
    // ä¿å­˜ç»“æœ
    titleSearchResults.push({
      title: title,
      inputArtist: inputArtist,
      artists: artists, // æ”¹ä¸ºå¸¦æ¥æºçš„æ­Œæ‰‹å¯¹è±¡åˆ—è¡¨
      artistNames: artistNames, // ä¿ç•™çº¯æ­Œæ‰‹ååˆ—è¡¨
      hasResult: artists.length > 0,
      isArtistValid: isArtistValid,
      originalLine: item.line
    });
    
    // é»˜è®¤é€‰ä¸­ï¼šå¦‚æœæ˜¯å®Œæ•´æ ¼å¼ï¼Œä¼˜å…ˆé€‰ä¸­è¾“å…¥çš„æ­Œæ‰‹ï¼ˆå³ä½¿æ˜¯é”™è¯¯çš„ï¼‰ï¼Œå¦åˆ™é€‰ç¬¬ä¸€ä¸ªæ­£ç¡®æ­Œæ‰‹
    let defaultArtist = '';
    if (inputFormatType === 'full' && inputArtist.trim()) {
      defaultArtist = inputArtist; // ä¼˜å…ˆé€‰ä¸­è¾“å…¥çš„æ­Œæ‰‹ï¼ˆé”™è¯¯ç­”æ¡ˆä¹Ÿä¿ç•™ï¼‰
    } else if (artistNames.length > 0) {
      defaultArtist = artistNames[0];
    }
    
    selectedArtists[title] = defaultArtist;
  });
  
  // æ¸²æŸ“æ­Œæ‰‹é€‰æ‹©ç•Œé¢ï¼ˆå¸¦æ ¡éªŒç»“æœ+é”™è¯¯ç­”æ¡ˆ+æ¥æºï¼‰
  renderArtistSelectWithValidation();
  
  // æ˜¾ç¤ºæ­Œæ‰‹é€‰æ‹©åŒºå’Œç»“æœç”ŸæˆåŒº
  document.getElementById('artistSelectArea').classList.add('active');
  document.getElementById('resultGenerateArea').classList.add('active');
  
  // ç”Ÿæˆåˆå§‹ç»“æœ
  generateResultText();
}

// æ¸²æŸ“æ­Œæ‰‹é€‰æ‹©ç•Œé¢ï¼ˆå¸¦æ ¡éªŒç»“æœ+é”™è¯¯ç­”æ¡ˆ+æ¥æºï¼‰
function renderArtistSelectWithValidation() {
  const container = document.getElementById('artistSelectContainer');
  container.innerHTML = '';
  
  titleSearchResults.forEach(item => {
    const selectItem = document.createElement('div');
    selectItem.className = 'select-item';
    
    // æ ‡é¢˜ï¼ˆå¸¦æ ¡éªŒçŠ¶æ€ï¼‰
    let titleHtml = `<h4>${item.title}`;
    if (inputFormatType === 'full') {
      if (item.hasResult) {
        titleHtml += item.isArtistValid 
          ? `<span class="valid-tag">âœ… æ­Œæ‰‹ "${item.inputArtist}" éªŒè¯é€šè¿‡</span>`
          : `<span class="invalid-tag">âŒ æ­Œæ‰‹ "${item.inputArtist}" ä¸åº“ä¸­ä¸ç¬¦ï¼Œåº“ä¸­æ­Œæ‰‹ï¼š${item.artistNames.join(' / ')}</span>`;
      } else {
        titleHtml += `<span class="invalid-tag">âŒ æœªæ‰¾åˆ°è¯¥æ­Œæ›²ä¿¡æ¯</span>`;
      }
    }
    titleHtml += `</h4>`;
    selectItem.innerHTML = titleHtml;
    
    // æ­Œæ‰‹é€‰é¡¹
    const optionsDiv = document.createElement('div');
    optionsDiv.className = 'artist-options';
    
    if (item.hasResult) {
      // 1. å¦‚æœæœ‰è¾“å…¥çš„é”™è¯¯æ­Œæ‰‹ï¼Œå…ˆæ˜¾ç¤ºï¼ˆæ ‡çº¢ï¼‰
      if (inputFormatType === 'full' && item.inputArtist.trim() && !item.isArtistValid) {
        const errorBtn = document.createElement('div');
        errorBtn.className = `artist-option error ${selectedArtists[item.title] === item.inputArtist ? 'selected' : ''}`;
        errorBtn.innerHTML = `${item.inputArtist} (è¾“å…¥å€¼) <span class="source-label">æ— åŒ¹é…æ¥æº</span>`;
        errorBtn.onclick = () => {
          // æ›´æ–°é€‰ä¸­çš„æ­Œæ‰‹
          selectedArtists[item.title] = item.inputArtist;
          // æ›´æ–°æŒ‰é’®æ ·å¼
          optionsDiv.querySelectorAll('.artist-option').forEach(btn => {
            btn.classList.remove('selected');
          });
          errorBtn.classList.add('selected');
          // é‡æ–°ç”Ÿæˆç»“æœ
          generateResultText();
        };
        optionsDiv.appendChild(errorBtn);
        
        // æ·»åŠ åˆ†éš”ç¬¦
        const divider = document.createElement('div');
        divider.style.width = '100%';
        divider.style.height = '1px';
        divider.style.backgroundColor = '#eee';
        divider.style.margin = '4px 0';
        optionsDiv.appendChild(divider);
      }
      
      // 2. æ˜¾ç¤ºåº“ä¸­çš„æ­£ç¡®æ­Œæ‰‹åˆ—è¡¨ï¼ˆå¸¦æ¥æºï¼‰
      item.artists.forEach(artist => {
        const optionBtn = document.createElement('div');
        // æ ‡è®°åŒ¹é…çš„æ­Œæ‰‹ï¼ˆè¾“å…¥çš„æ­£ç¡®æ­Œæ‰‹ï¼‰
        const isMatched = inputFormatType === 'full' && artist.name.toLowerCase() === item.inputArtist.toLowerCase();
        optionBtn.className = `artist-option 
          ${selectedArtists[item.title] === artist.name ? 'selected' : ''}
          ${isMatched ? 'matched' : ''}`;
        // æ˜¾ç¤ºæ­Œæ‰‹å + æ¥æºä¿¡æ¯
        optionBtn.innerHTML = `${artist.name} (åº“ä¸­å€¼) <span class="source-label">æ¥æºï¼š${artist.sources}</span>`;
        optionBtn.onclick = () => {
          // æ›´æ–°é€‰ä¸­çš„æ­Œæ‰‹
          selectedArtists[item.title] = artist.name;
          // æ›´æ–°æŒ‰é’®æ ·å¼
          optionsDiv.querySelectorAll('.artist-option').forEach(btn => {
            btn.classList.remove('selected');
          });
          optionBtn.classList.add('selected');
          // é‡æ–°ç”Ÿæˆç»“æœ
          generateResultText();
        };
        optionsDiv.appendChild(optionBtn);
      });
    } else {
      // æ— åŒ¹é…ç»“æœï¼Œä½†ä»æ˜¾ç¤ºè¾“å…¥çš„æ­Œæ‰‹ï¼ˆå¦‚æœæœ‰ï¼‰
      if (inputFormatType === 'full' && item.inputArtist.trim()) {
        const errorBtn = document.createElement('div');
        errorBtn.className = `artist-option error ${selectedArtists[item.title] === item.inputArtist ? 'selected' : ''}`;
        errorBtn.innerHTML = `${item.inputArtist} (è¾“å…¥å€¼) <span class="source-label">æ— åŒ¹é…æ¥æº</span>`;
        errorBtn.onclick = () => {
          selectedArtists[item.title] = item.inputArtist;
          optionsDiv.querySelectorAll('.artist-option').forEach(btn => {
            btn.classList.remove('selected');
          });
          errorBtn.classList.add('selected');
          generateResultText();
        };
        optionsDiv.appendChild(errorBtn);
      } else {
        // æ— åŒ¹é…ç»“æœ
        const noResult = document.createElement('div');
        noResult.className = 'no-result';
        noResult.textContent = 'âŒ æœªæ‰¾åˆ°åŒ¹é…çš„æ­Œæ›²ä¿¡æ¯';
        optionsDiv.appendChild(noResult);
      }
    }
    
    selectItem.appendChild(optionsDiv);
    container.appendChild(selectItem);
  });
}

// ç”Ÿæˆç»“æœæ–‡æœ¬
function generateResultText() {
  // å¦‚æœé€‰ä¸­äº†æ’åˆ—ç»„åˆï¼Œä¼˜å…ˆä½¿ç”¨ç»„åˆå†…å®¹
  if (selectedCombination) {
    document.getElementById('resultText').value = selectedCombination;
    return;
  }
  
  // å¦åˆ™ä½¿ç”¨æ‰‹åŠ¨é€‰æ‹©çš„æ­Œæ‰‹ï¼ˆåŒ…å«é”™è¯¯ç­”æ¡ˆï¼‰
  let result = '';
  
  titleSearchResults.forEach((item, index) => {
    const num = (index + 1).toString().padStart(2, '0');
    const artist = selectedArtists[item.title] || '';
    result += `${num}. ${item.title} ${artist ? '- ' + artist : ''}\n`;
  });
  
  // æ›´æ–°ç»“æœæ–‡æœ¬æ¡†
  document.getElementById('resultText').value = result.trim();
}

// ä½¿ç”¨é€‰ä¸­çš„æ’åˆ—ç»„åˆ
function useSelectedCombination() {
  if (!selectedCombination) {
    alert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªæ’åˆ—ç»„åˆï¼');
    return;
  }
  
  // æ›´æ–°ç»“æœæ–‡æœ¬
  document.getElementById('resultText').value = selectedCombination;
  
  // è§£æç»„åˆå†…å®¹ï¼Œæ›´æ–°é€‰ä¸­çš„æ­Œæ‰‹æ˜ å°„
  const lines = selectedCombination.split('\n');
  lines.forEach(line => {
    const match = line.match(/^\d{1,2}\.\s*(.+?)\s*-\s*(.+)$/);
    if (match) {
      const title = match[1].trim();
      const artist = match[2].trim();
      selectedArtists[title] = artist;
    }
  });
  
  // é‡æ–°æ¸²æŸ“æ­Œæ‰‹é€‰æ‹©ç•Œé¢
  renderArtistSelectWithValidation();
}

// å¤åˆ¶æ­Œå-æ­Œæ‰‹ç»“æœ
function copyResultText() {
  const resultText = document.getElementById('resultText').value.trim();
  if (!resultText) {
    alert('æš‚æ— ç»“æœå¯å¤åˆ¶ï¼');
    return;
  }
  
  // å¤åˆ¶åˆ°å‰ªè´´æ¿
  navigator.clipboard.writeText(resultText)
    .then(() => {
      showCopyToast();
    })
    .catch(err => {
      console.error('å¤åˆ¶å¤±è´¥ï¼š', err);
      alert('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶ï¼');
    });
}

// ================= æ•°æ®åŠ è½½ =================
async function loadAllData() {
  try {
    // åŠ è½½ç´¢å¼•æ–‡ä»¶
    const indexRes = await fetch('data/index.json');
    const indexData = await indexRes.json();
    fileList = indexData.files || [];
    fileAlias = indexData.fileToAlias || {};
    
    // æ¸²æŸ“æ¥æºæ ‡ç­¾é¡µ
    renderSourceTabs();

    // å¹¶è¡ŒåŠ è½½æ‰€æœ‰JSæ–‡ä»¶
    const loadFileTasks = fileList.map(fileName => 
      fetch(`data/${fileName}`)
        .then(res => res.text())
        .then(jsContent => {
          // æ‰§è¡ŒJSæ–‡ä»¶è·å–æ­Œæ›²æ•°æ®
          const fakeWindow = { SONG_DATA: [] };
          try {
            const executeCode = new Function('window', jsContent);
            executeCode(fakeWindow);
          } catch (e) {
            console.warn(`æ‰§è¡Œ${fileName}å‡ºé”™ï¼š`, e.message);
          }
          // ç»™æ¯é¦–æ­Œæ·»åŠ æ¥æºæ ‡è¯†
          return fakeWindow.SONG_DATA.map(song => ({
            ...song,
            source: fileName
          }));
        })
        .catch(err => {
          console.error(`åŠ è½½${fileName}å¤±è´¥ï¼š`, err);
          return [];
        })
    );

    // åˆå¹¶æ‰€æœ‰æ­Œæ›²æ•°æ®
    const songArrays = await Promise.all(loadFileTasks);
    allSongs = songArrays.flat();
    
    // æ„å»ºBVå·åˆ°æ¥æºçš„æ˜ å°„
    allSongs.forEach(song => {
      const bv = extractBV(song.link);
      if (bv) bvToSourceMap.set(bv, song.source);
    });

    console.log(`âœ… å…¨åº“åŠ è½½å®Œæˆï¼šå…± ${allSongs.length} é¦–æ­Œæ›²`);
  } catch (err) {
    console.error('âŒ æ•°æ®åŠ è½½å¤±è´¥ï¼š', err);
    document.getElementById('statInfo').textContent = `æ•°æ®åŠ è½½å¤±è´¥ï¼š${err.message}`;
  }
}

// ================= ç•Œé¢æ¸²æŸ“ =================
// æ¸²æŸ“æ¥æºæ ‡ç­¾é¡µ
function renderSourceTabs() {
  const container = document.getElementById('tabContainer');
  container.innerHTML = '';

  // å…¨éƒ¨æ ‡ç­¾
  const allTab = document.createElement('div');
  allTab.className = `source-tab ${currentTab === 'all' ? 'active' : ''}`;
  allTab.textContent = 'å…¨éƒ¨';
  allTab.onclick = () => switchSourceTab('all');
  container.appendChild(allTab);

  // å„æ¥æºæ ‡ç­¾
  fileList.forEach(fileName => {
    const tab = document.createElement('div');
    tab.className = `source-tab ${currentTab === fileName ? 'active' : ''}`;
    tab.textContent = getSourceAlias(fileName); // ä½¿ç”¨ç»Ÿä¸€çš„æ¥æºåˆ«åå‡½æ•°
    tab.onclick = () => switchSourceTab(fileName);
    container.appendChild(tab);
  });
}

// æ¸²æŸ“æ­Œæ›²åˆ—è¡¨ï¼ˆæ ¸å¿ƒï¼šæŠ˜å æ€å±•ç¤º3æ¡+æ•°æ®ï¼Œæ”¯æŒç­›é€‰æœªé‡å¤ï¼‰
function renderSongList() {
  const container = document.getElementById('resultList');
  container.innerHTML = '';

  if (analysisResult.length === 0) {
    container.innerHTML = '<div style="text-align:center;padding:20px;color:#6c757d;">æš‚æ— åˆ†æç»“æœï¼Œè¯·è¾“å…¥BVå·å¼€å§‹åˆ†æ</div>';
    return;
  }

  // ç­›é€‰è¦æ˜¾ç¤ºçš„æ­Œæ›²
  let displayResult = analysisResult;
  if (showOnlyUnique) {
    displayResult = analysisResult.filter(item => !item.isDup);
  }

  if (displayResult.length === 0) {
    container.innerHTML = '<div style="text-align:center;padding:20px;color:#6c757d;">æš‚æ— ç¬¦åˆæ¡ä»¶çš„æ­Œæ›²</div>';
    return;
  }

  displayResult.forEach((item, index) => {
    const song = item.song;
    const isDup = item.isDup;
    const dupList = item.dupList;
    const dupCount = dupList.length;
    // è·å–æ­Œæ›²æ¥æºåˆ«å
    const songSource = getSourceAlias(song.source);
    
    // æ­Œæ›²é¡¹å®¹å™¨
    const songItem = document.createElement('div');
    songItem.className = `song-item ${isDup ? 'dup' : 'unique'}`;

    // æ ‡é¢˜åŒºåŸŸï¼ˆæŠ˜å æ€ï¼‰
    const titleDiv = document.createElement('div');
    titleDiv.className = 'song-title';
    titleDiv.innerHTML = `
      <div class="title-left">
        ${index + 1}. ${song.title}
        ${isDup ? `<span class="dup-tag">é‡å¤ ${dupCount} æ¬¡</span>` : `<span class="unique-tag">æ— é‡å¤</span>`}
      </div>
      <div class="title-right">
        <span style="font-size:12px;margin-right:8px;">${songSource}</span>
        <span class="collapse-toggle">â–¼</span>
      </div>
    `;

    // æŠ˜å æ€æ‘˜è¦ä¿¡æ¯
    const summaryDiv = document.createElement('div');
    summaryDiv.className = 'collapse-summary';
    
    // åŸºç¡€ä¿¡æ¯ï¼ˆæ–°å¢æ¥æºå­—æ®µï¼‰
    summaryDiv.innerHTML = `
      <div class="summary-item">ğŸ‘¤ æ­Œæ‰‹ï¼š${song.artist || 'æœªçŸ¥'}</div>
      <div class="summary-item">ğŸ“ åˆé›†ï¼š${song.collection || 'æœªçŸ¥'}</div>
      <div class="summary-item">ğŸ“¦ æ¥æºï¼š${songSource}</div>
      <div class="summary-item">ğŸ”— BVå·ï¼š${extractBV(song.link)}</div>
      <div class="summary-item">ğŸŒ é“¾æ¥ï¼š<a href="${song.link}" target="_blank" style="color:#00a1d6;">ç‚¹å‡»æŸ¥çœ‹</a></div>
      <div class="summary-item">ğŸ“Š å½“å‰åº“ï¼š${getSourceAlias(currentTab)} | åŒ¹é…ç»“æœï¼š${dupCount} æ¡</div>
    `;

    // é‡å¤é¢„è§ˆï¼ˆæœ€å¤š3æ¡ï¼‰
    if (isDup) {
      const previewHtml = [];
      // å–å‰3æ¡é‡å¤é¡¹
      const previewItems = dupList.slice(0, 3);
      previewItems.forEach((dup, idx) => {
        previewHtml.push(`
          <div class="dup-preview-item">
            <span class="bv-tag">${extractBV(dup.link)}</span>
            ${dup.title} | ${getSourceAlias(dup.source)}
          </div>
        `);
      });
      // è¶…è¿‡3æ¡æ˜¾ç¤ºæ›´å¤šæç¤º
      if (dupCount > 3) {
        previewHtml.push(`<div class="dup-preview-more">... è¿˜æœ‰ ${dupCount - 3} æ¡é‡å¤é¡¹ï¼ˆç‚¹å‡»å±•å¼€æŸ¥çœ‹å…¨éƒ¨ï¼‰</div>`);
      }
      
      summaryDiv.innerHTML += `
        <div class="dup-preview">
          <div style="font-size:12px;margin-bottom:4px;color:#dc3545;">é‡å¤é¢„è§ˆï¼ˆå‰3æ¡ï¼‰ï¼š</div>
          ${previewHtml.join('')}
        </div>
      `;
    }

    // å±•å¼€å†…å®¹åŒºåŸŸ
    const contentDiv = document.createElement('div');
    contentDiv.className = 'collapse-content';
    
    // å±•å¼€å†…å®¹è¯¦æƒ…ï¼ˆå¼ºåŒ–æ¥æºæ˜¾ç¤ºï¼‰
    let dupListHtml = '';
    if (isDup) {
      dupList.forEach(dup => {
        dupListHtml += `
          <div class="dup-item">
            <span class="bv-tag">${extractBV(dup.link)}</span>
            <div style="flex:1;">
              <div>${dup.title}</div>
              <div style="font-size:11px;color:#6c757d;">
                æ­Œæ‰‹ï¼š${dup.artist || 'æœªçŸ¥'} | æ¥æºï¼š${getSourceAlias(dup.source)}
                <br>é“¾æ¥ï¼š<a href="${dup.link}" target="_blank" style="color:#00a1d6;">${dup.link}</a>
              </div>
            </div>
          </div>
        `;
      });
    }

    contentDiv.innerHTML = `
      <div class="meta-info">
        <div class="meta-row">ğŸ‘¤ æ­Œæ‰‹ï¼š${song.artist || 'æœªçŸ¥'}</div>
        <div class="meta-row">ğŸ“ åˆé›†ï¼š${song.collection || 'æœªçŸ¥'}</div>
        <div class="meta-row">ğŸ“¦ æ¥æºï¼š${songSource}</div>
        <div class="meta-row">ğŸ”— é“¾æ¥ï¼š<a href="${song.link}" target="_blank" style="color:#00a1d6;">${song.link}</a></div>
        <div class="sub-info">
          <div style="font-weight:500;margin-bottom:8px;">
            åœ¨ ${getSourceAlias(currentTab)} ä¸­æ‰¾åˆ° ${dupCount} æ¡åŒ¹é…ç»“æœï¼š
          </div>
          <div class="dup-list">${isDup ? dupListHtml : '<div style="color:#28a745;">âœ… æ— é‡å¤è®°å½•</div>'}</div>
        </div>
      </div>
    `;

    // æŠ˜å /å±•å¼€åˆ‡æ¢
    titleDiv.addEventListener('click', () => {
      contentDiv.classList.toggle('show');
      const toggleIcon = titleDiv.querySelector('.collapse-toggle');
      toggleIcon.textContent = contentDiv.classList.contains('show') ? 'â–²' : 'â–¼';
    });

    // ç»„è£…æ­Œæ›²é¡¹
    songItem.appendChild(titleDiv);
    songItem.appendChild(summaryDiv);
    songItem.appendChild(contentDiv);
    container.appendChild(songItem);
  });
}

// ================= æ ¸å¿ƒé€»è¾‘ =================
// åˆ‡æ¢æ¥æºæ ‡ç­¾é¡µ
function switchSourceTab(tab) {
  currentTab = tab;
  renderSourceTabs();
  // é‡æ–°åˆ†æï¼ˆå¸¦ç€ä¹‹å‰çš„BVæ­Œæ›²åˆ—è¡¨ï¼‰
  if (targetBvSongs.length > 0) {
    analyzeDuplicates();
  }
}

// æœç´¢BVå·ï¼ˆå…¨åº“ç­›é€‰å¯¹åº”æ­Œæ›²ï¼‰
function searchBV() {
  const input = document.getElementById('bvInput').value.trim();
  const bv = extractBV(input);
  
  if (!bv) {
    alert('è¯·è¾“å…¥æœ‰æ•ˆçš„BVå·æˆ–Bç«™è§†é¢‘é“¾æ¥ï¼');
    return;
  }

  // é‡ç½®ç­›é€‰çŠ¶æ€
  toggleShowMode(false);

  // å…¨åº“ç­›é€‰è¯¥BVå¯¹åº”çš„æ‰€æœ‰æ­Œæ›²
  targetBvSongs = allSongs.filter(song => extractBV(song.link) === bv);
  
  if (targetBvSongs.length === 0) {
    document.getElementById('statInfo').textContent = `æœªæ‰¾åˆ°BVå·ã€Œ${bv}ã€çš„ç›¸å…³æ­Œæ›²`;
    document.getElementById('resultList').innerHTML = `<div style="text-align:center;padding:20px;color:#6c757d;">æœªæ‰¾åˆ°BVå·ã€Œ${bv}ã€çš„ç›¸å…³æ­Œæ›²</div>`;
    analysisResult = [];
    return;
  }

  // è‡ªåŠ¨åˆ‡æ¢åˆ°è¯¥BVçš„ä¸»è¦æ¥æºæ ‡ç­¾
  const mainSource = targetBvSongs[0].source;
  switchSourceTab(mainSource);
}

// åˆ†æé‡å¤ï¼ˆæ ¸å¿ƒï¼šåœ¨å½“å‰æ ‡ç­¾åº“ä¸­æŸ¥é‡ï¼‰
function analyzeDuplicates() {
  // ç­›é€‰å½“å‰æ ‡ç­¾åº“çš„æ­Œæ›²æ± 
  const currentPool = currentTab === 'all' 
    ? allSongs 
    : allSongs.filter(song => song.source === currentTab);

  // åˆ†ææ¯é¦–ç›®æ ‡æ­Œæ›²çš„é‡å¤æƒ…å†µ
  analysisResult = targetBvSongs.map(song => {
    // æŒ‰æ ‡é¢˜ï¼ˆå¿½ç•¥å¤§å°å†™ï¼‰åŒ¹é…é‡å¤é¡¹
    const songTitle = (song.title || '').trim().toLowerCase();
    const dupList = currentPool.filter(item => 
      (item.title || '').trim().toLowerCase() === songTitle
    );

    return {
      song: song,
      dupList: dupList,
      isDup: dupList.length > 1, // é‡å¤åˆ¤æ–­ï¼ˆå‡ºç°æ¬¡æ•°>1ï¼‰
      dupCount: dupList.length
    };
  });

  // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
  const total = targetBvSongs.length;
  const dupCount = analysisResult.filter(item => item.isDup).length;
  const uniqueCount = total - dupCount;
  const currentSourceName = getSourceAlias(currentTab); // ä½¿ç”¨ç»Ÿä¸€çš„æ¥æºåˆ«å
  
  document.getElementById('statInfo').textContent = 
    `åˆ†æBVæ­Œæ›²ï¼š${total} é¦– | å½“å‰åº“ï¼š${currentSourceName} | é‡å¤ï¼š${dupCount} é¦– | éé‡å¤ï¼š${uniqueCount} é¦–`;

  // æ¸²æŸ“ç»“æœåˆ—è¡¨
  renderSongList();
}

// å¤åˆ¶åŠŸèƒ½ï¼ˆBVæŸ¥é‡ï¼‰- æ–°å¢å¤åˆ¶æ¥æºé€‰é¡¹
function copyResults() {
  if (analysisResult.length === 0) {
    alert('æš‚æ— åˆ†æç»“æœå¯å¤åˆ¶ï¼');
    return;
  }

  // è·å–å¤åˆ¶é€‰é¡¹
  const onlyUnique = document.getElementById('copyOnlyUnique').checked;
  const includeTitle = document.getElementById('copyTitle').checked;
  const includeLink = document.getElementById('copyLink').checked;
  const includeCount = document.getElementById('copyCount').checked;
  const includeSource = document.getElementById('copySource').checked; // æ–°å¢æ¥æºé€‰é¡¹
  const isTextFormat = document.getElementById('copyText').checked;

  // ç­›é€‰è¦å¤åˆ¶çš„æ­Œæ›²
  let copyData = analysisResult;
  if (onlyUnique) {
    copyData = analysisResult.filter(item => !item.isDup);
  }

  if (copyData.length === 0) {
    alert('æ²¡æœ‰ç¬¦åˆç­›é€‰æ¡ä»¶çš„æ­Œæ›²å¯å¤åˆ¶ï¼');
    return;
  }

  // æ„å»ºå¤åˆ¶å†…å®¹
  let content = '';
  
  // çº¯æ–‡æœ¬æ ¼å¼
  if (isTextFormat) {
    copyData.forEach(item => {
      const parts = [];
      if (includeTitle) parts.push(item.song.title || 'æœªçŸ¥æ­Œæ›²');
      if (includeSource) parts.push(`æ¥æºï¼š${getSourceAlias(item.song.source)}`); // æ–°å¢æ¥æº
      if (includeLink) parts.push(`é“¾æ¥ï¼š${item.song.link}`);
      if (includeCount) parts.push(`æ¬¡æ•°ï¼š${item.dupCount}`);
      content += parts.join(' | ') + '\n';
    });
  } 
  // è¡¨æ ¼æ ¼å¼ï¼ˆTSVï¼Œå¯ç›´æ¥ç²˜è´´åˆ°Excelï¼‰
  else {
    // è¡¨å¤´
    const headers = [];
    if (includeTitle) headers.push('æ­Œå');
    if (includeSource) headers.push('æ¥æº'); // æ–°å¢æ¥æºè¡¨å¤´
    if (includeLink) headers.push('æ­Œæ›²é“¾æ¥');
    if (includeCount) headers.push('å‡ºç°æ¬¡æ•°');
    content += headers.join('\t') + '\n';
    
    // å†…å®¹è¡Œ
    copyData.forEach(item => {
      const row = [];
      if (includeTitle) row.push(item.song.title || 'æœªçŸ¥æ­Œæ›²');
      if (includeSource) row.push(getSourceAlias(item.song.source)); // æ–°å¢æ¥æºå†…å®¹
      if (includeLink) row.push(item.song.link);
      if (includeCount) row.push(item.dupCount);
      content += row.join('\t') + '\n';
    });
  }

  // å¤åˆ¶åˆ°å‰ªè´´æ¿
  navigator.clipboard.writeText(content.trim())
    .then(() => {
      showCopyToast();
    })
    .catch(err => {
      console.error('å¤åˆ¶å¤±è´¥ï¼š', err);
      alert('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶ï¼');
    });
}

// ================= åˆå§‹åŒ– =================
function init() {
  // åŠ è½½å…¨åº“æ•°æ®
  loadAllData();

  // ç»‘å®šåŠŸèƒ½æ ‡ç­¾åˆ‡æ¢äº‹ä»¶
  document.getElementById('bvCheckTab').addEventListener('click', () => switchFunctionTab('bvCheckTab'));
  document.getElementById('titleSearchTab').addEventListener('click', () => switchFunctionTab('titleSearchTab'));

  // ç»‘å®šBVæŸ¥é‡ç›¸å…³äº‹ä»¶
  document.getElementById('searchBtn').addEventListener('click', searchBV);
  document.getElementById('bvInput').addEventListener('keydown', e => {
    if (e.key === 'Enter') searchBV();
  });
  document.getElementById('showAllBtn').addEventListener('click', () => toggleShowMode(false));
  document.getElementById('showUniqueBtn').addEventListener('click', () => toggleShowMode(true));
  document.getElementById('copyBtn').addEventListener('click', copyResults);

  // ç»‘å®šæ­Œå-æ­Œæ‰‹æŸ¥è¯¢/æ ¡éªŒç›¸å…³äº‹ä»¶ï¼ˆå¢å¼ºï¼‰
  document.getElementById('searchTitleBtn').addEventListener('click', searchAndValidateArtists);
  document.getElementById('validateBtn').addEventListener('click', generateAllCombinations);
  document.getElementById('useCombinationBtn').addEventListener('click', useSelectedCombination);
  document.getElementById('copyResultBtn').addEventListener('click', copyResultText);
  
  // æ”¯æŒå›è½¦æŸ¥è¯¢æ­Œå
  document.getElementById('titleInput').addEventListener('keydown', e => {
    if (e.key === 'Enter' && e.ctrlKey) { // Ctrl+Enter æŸ¥è¯¢
      searchAndValidateArtists();
    }
  });
}

// å¯åŠ¨åº”ç”¨
document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
