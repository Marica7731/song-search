<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BVæ­Œåº“é‡å¤æ£€æŸ¥</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:Arial,sans-serif;background:#f6f7f9;padding:20px}
.main{max-width:1000px;margin:0 auto}
.header{text-align:center;margin-bottom:20px}
.search-box{display:flex;gap:10px;margin-bottom:20px}
#bvInput{flex:1;padding:12px;border:1px solid #ddd;border-radius:8px;font-size:14px}
#searchBtn{padding:0 20px;background:#00a1d6;color:white;border:0;border-radius:8px;cursor:pointer}
.source-tabs{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:20px;padding-bottom:10px;border-bottom:1px solid #ddd}
.source-tab{padding:6px 12px;background:white;border:1px solid #ddd;border-radius:6px;cursor:pointer}
.source-tab.active{background:#00a1d6;color:white;border-color:#00a1d6}
.stat{display:flex;gap:15px;margin-bottom:16px;font-size:14px;color:#333}
.song-item{background:white;border-radius:8px;padding:12px;margin-bottom:10px;border-left:4px solid #ddd}
.song-item.dup{border-left-color:#f56c6c}
.song-item.unique{border-left-color:#67c23a}
.song-title{display:flex;justify-content:space-between;align-items:center;cursor:pointer;font-weight:bold}
.dup-tag{background:#f56c6c;color:white;font-size:12px;padding:2px 6px;border-radius:4px}
.unique-tag{background:#67c23a;color:white;font-size:12px;padding:2px 6px;border-radius:4px}
.collapse{max-height:0;overflow:hidden;transition:max-height 0.3s}
.collapse.show{max-height:5000px}
.meta{margin-top:8px;font-size:12px;color:#666;line-height:1.6}
.sub-info{margin-top:6px;padding-top:6px;border-top:1px solid #eee}
.bv-tag{display:inline-block;background:#6f42c1;color:white;font-size:11px;padding:2px 4px;border-radius:3px;margin-right:4px;margin-bottom:4px}
</style>
</head>
<body>
<div class="main">
  <div class="header">
    <h2>ğŸ” BV æ­Œåº“è·¨åº“é‡å¤æ£€æŸ¥</h2>
    <div style="color:#666;margin-top:4px">è¾“å…¥BV â†’ è‡ªåŠ¨å®šä½æ¥æº â†’ åˆ‡tabå³åœ¨è¯¥åº“æŸ¥é‡</div>
  </div>

  <div class="search-box">
    <input id="bvInput" placeholder="è¾“å…¥BVå·æˆ–Bç«™è§†é¢‘é“¾æ¥" type="text">
    <button id="searchBtn">å¼€å§‹åˆ†æ</button>
  </div>

  <div class="source-tabs" id="tabContainer"></div>
  <div class="stat" id="stat"></div>
  <div id="result"></div>
</div>

<script>
let allSongs = [];
let fileList = [];
let fileAlias = {};
let currentTab = 'all';
let targetBvSongs = []; // ä½ è¾“å…¥çš„BVå¯¹åº”çš„æ‰€æœ‰æ­Œæ›²ï¼ˆå…¨åº“æå‡ºï¼‰
let bvToSourceMap = new Map();

// å…¨åº“åŠ è½½
async function loadAll() {
  const index = await fetch('data/index.json').then(r=>r.json());
  fileList = index.files || [];
  fileAlias = index.fileToAlias || {};
  renderTabs();

  const tasks = fileList.map(f => 
    fetch(`data/${f}`)
      .then(r=>r.text())
      .then(text=>{
        const w = {SONG_DATA:[]};
        try{new Function('window', text)(w)}catch{}
        return w.SONG_DATA.map(s=>({...s, source:f}));
      })
  );
  const arrays = await Promise.all(tasks);
  allSongs = arrays.flat();
  allSongs.forEach(s=>{
    const bv = extractBV(s.link);
    if(bv) bvToSourceMap.set(bv, s.source);
  });
  console.log('å…¨åº“åŠ è½½å®Œæˆ', allSongs.length);
}

function extractBV(str) {
  if(!str) return '';
  const m = str.match(/BV[a-zA-Z0-9]+/);
  return m ? m[0] : '';
}

function renderTabs() {
  const c = document.getElementById('tabContainer');
  c.innerHTML = '';
  const allTab = document.createElement('div');
  allTab.className='source-tab'+(currentTab==='all'?' active':'');
  allTab.textContent='å…¨éƒ¨';
  allTab.onclick=()=>switchTab('all');
  c.appendChild(allTab);

  fileList.forEach(f=>{
    const t=document.createElement('div');
    t.className='source-tab'+(currentTab===f?' active':'');
    t.textContent=fileAlias[f.replace('.js','')]||f;
    t.onclick=()=>switchTab(f);
    c.appendChild(t);
  });
}

function switchTab(tab) {
  currentTab = tab;
  renderTabs();
  doCheck(); // åˆ‡tab â†’ ç«‹åˆ»åœ¨å½“å‰tabåº“é‡ŒæŸ¥é‡
}

// ä½ è¾“å…¥BV â†’ å…¨åº“æå‡ºè¯¥BVæ‰€æœ‰æ­Œ â†’ è‡ªåŠ¨åˆ‡æ¥æº
async function searchBV() {
  const input = document.getElementById('bvInput').value.trim();
  const bv = extractBV(input);
  if(!bv){alert('è¯·è¾“å…¥æœ‰æ•ˆBV');return}
  targetBvSongs = allSongs.filter(s=>extractBV(s.link)===bv);
  if(targetBvSongs.length===0){
    document.getElementById('result').innerHTML='æœªæ‰¾åˆ°è¯¥BV';
    return;
  }
  // è‡ªåŠ¨è·³è½¬åˆ°è¯¥BVæ‰€åœ¨æ¥æºtab
  const firstSource = targetBvSongs[0].source;
  switchTab(firstSource);
}

// æ ¸å¿ƒï¼šç”¨ targetBvSongs åœ¨å½“å‰tabåº“é‡ŒæŸ¥é‡
function doCheck() {
  if(targetBvSongs.length===0)return;
  const pool = currentTab==='all' 
    ? allSongs 
    : allSongs.filter(s=>s.source===currentTab);

  const keyMap = new Map();
  pool.forEach(s=>{
    const k = (s.title||'').trim().toLowerCase() + '|' + (s.artist||'').trim().toLowerCase();
    keyMap.set(k, s);
  });

  const res = targetBvSongs.map(s=>{
    const k = (s.title||'').trim().toLowerCase() + '|' + (s.artist||'').trim().toLowerCase();
    const dupInPool = pool.filter(x=> 
      (x.title||'').trim().toLowerCase() === (s.title||'').trim().toLowerCase()
    );
    return {
      song: s,
      dupList: dupInPool,
      isDup: dupInPool.length>0
    };
  });

  renderResult(res);
}

function renderResult(list) {
  const stat = document.getElementById('stat');
  stat.textContent = `åˆ†æBVæ­Œæ›²ï¼š${targetBvSongs.length} é¦–ï½œå½“å‰åº“ï¼š${currentTab==='all'?'å…¨éƒ¨':fileAlias[currentTab.replace('.js','')]}ï½œé‡å¤ï¼š${list.filter(x=>x.isDup).length} é¦–`;

  const dom = document.getElementById('result');
  dom.innerHTML = '';
  list.forEach((item,idx)=>{
    const s = item.song;
    const dup = item.isDup;
    const root = document.createElement('div');
    root.className = 'song-item ' + (dup?'dup':'unique');

    const title = document.createElement('div');
    title.className='song-title';
    title.innerHTML = `
      <span>${idx+1}. ${s.title}</span>
      <span>${dup?'<span class="dup-tag">é‡å¤</span>':'<span class="unique-tag">å”¯ä¸€</span>'}</span>
    `;

    const collapse = document.createElement('div');
    collapse.className='collapse';
    collapse.innerHTML = `
      <div class="meta">
        <div>ğŸ‘¤ ${s.artist||'æœªçŸ¥'}</div>
        <div>ğŸ“ ${s.collection||''}</div>
        <div>ğŸ”— ${s.link}</div>
        <div class="sub-info">
          <div>åœ¨ã€${currentTab==='all'?'å…¨éƒ¨':fileAlias[currentTab.replace('.js','')]}ã€‘ä¸­æ‰¾åˆ° ${item.dupList.length} æ¡é‡å¤ï¼š</div>
          ${item.dupList.map(x=>`
            <div style="margin-top:4px">
              <span class="bv-tag">${extractBV(x.link)}</span>
              ${x.title}ï½œ${fileAlias[x.source.replace('.js','')]||x.source}
            </div>
          `).join('')}
        </div>
      </div>
    `;

    title.onclick=()=>collapse.classList.toggle('show');
    root.appendChild(title);
    root.appendChild(collapse);
    dom.appendChild(root);
  });
}

document.getElementById('searchBtn').onclick=searchBV;
document.getElementById('bvInput').addEventListener('keydown',e=>{
  if(e.key==='Enter')searchBV();
});

loadAll();
</script>
</body>
</html>
