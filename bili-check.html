<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>æ­Œåº“è·¨åº“é‡å¤æ£€æŸ¥</title>
<link rel="icon" href="https://cdn-icons-png.flaticon.com/16/889/889666.png">
<style>
/* åŸºç¡€æ ·å¼ */
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;background:#f6f7f9;padding:20px}
.main{max-width:1200px;margin:0 auto}
.header{text-align:center;margin-bottom:24px}
.header h2{color:#2c3e50;margin-bottom:8px}
.header p{color:#6c757d;font-size:14px}
/* æ–°å¢å¯¼èˆªé“¾æ¥æ ·å¼ */
.sub-header{text-align:center;margin-bottom:16px;font-size:14px;color:#6c757d}
.nav-link{color:#00a1d6;text-decoration:none;font-weight:500}
.nav-link:hover{text-decoration:underline}

/* æœç´¢æ  */
.search-box{display:flex;gap:12px;margin-bottom:24px;flex-wrap:wrap}
#bvInput{flex:1;min-width:280px;padding:14px 16px;border:1px solid #ddd;border-radius:8px;font-size:14px;outline:none;transition:border 0.2s}
#bvInput:focus{border-color:#00a1d6;box-shadow:0 0 0 3px rgba(0,161,214,0.1)}
#searchBtn{padding:0 24px;background:#00a1d6;color:white;border:0;border-radius:8px;cursor:pointer;font-size:14px;font-weight:500;transition:background 0.2s}
#searchBtn:hover{background:#008fb3}

/* æ¥æºæ ‡ç­¾é¡µ */
.source-tabs{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:20px;padding-bottom:12px;border-bottom:1px solid #e9ecef}
.source-tab{padding:8px 16px;background:white;border:1px solid #ddd;border-radius:6px;cursor:pointer;font-size:14px;transition:all 0.2s}
.source-tab:hover{border-color:#00a1d6;color:#00a1d6}
.source-tab.active{background:#00a1d6;color:white;border-color:#00a1d6}

/* ç­›é€‰æ  + ç»Ÿè®¡æ  */
.filter-bar{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;flex-wrap:wrap;gap:12px}
.stat-info{font-size:14px;color:#495057}
.filter-btn{padding:6px 16px;background:#28a745;color:white;border:0;border-radius:6px;cursor:pointer;font-size:13px;margin-left:8px}
.filter-btn:hover{background:#218838}
.filter-btn.active{background:#1e7e34}

/* å¤åˆ¶ç­›é€‰åŒº */
.copy-controls{display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin-top:10px}
.copy-controls label{font-size:13px;color:#495057;display:flex;align-items:center;gap:4px}
.copy-controls input{width:16px;height:16px}
.copy-btn{padding:6px 16px;background:#6f42c1;color:white;border:0;border-radius:6px;cursor:pointer;font-size:13px}
.copy-btn:hover{background:#5a32a3}

/* æ­Œæ›²åˆ—è¡¨ */
.result-list{margin-bottom:30px}
.song-item{background:white;border-radius:8px;padding:16px;margin-bottom:12px;border-left:4px solid #ddd;box-shadow:0 2px 4px rgba(0,0,0,0.04)}
.song-item.dup{border-left-color:#dc3545}
.song-item.unique{border-left-color:#28a745}
.song-item.hidden{display:none}

/* æ­Œæ›²æ ‡é¢˜ï¼ˆæŠ˜å æ€æ ¸å¿ƒï¼‰ */
.song-title{display:flex;justify-content:space-between;align-items:flex-start;cursor:pointer;font-weight:600;color:#2c3e50;margin-bottom:8px}
.title-left{flex:1}
.title-right{text-align:right;min-width:120px}
.dup-tag{display:inline-block;background:#dc3545;color:white;font-size:12px;padding:2px 8px;border-radius:4px;margin-left:8px}
.unique-tag{display:inline-block;background:#28a745;color:white;font-size:12px;padding:2px 8px;border-radius:4px;margin-left:8px}
.collapse-toggle{font-size:18px;color:#6c757d;cursor:pointer;margin-left:8px}

/* æŠ˜å æ€æ‘˜è¦ä¿¡æ¯ */
.collapse-summary{font-size:13px;color:#6c757d;margin-bottom:8px;padding-bottom:8px;border-bottom:1px solid #f1f3f5}
.summary-item{margin-bottom:4px}
.dup-preview{margin-top:6px}
.dup-preview-item{font-size:12px;color:#495057;margin-top:2px;display:flex;align-items:center}
.dup-preview-more{font-size:12px;color:#00a1d6;margin-top:4px}

/* å±•å¼€å†…å®¹ */
.collapse-content{max-height:0;overflow:hidden;transition:max-height 0.3s ease}
.collapse-content.show{max-height:5000px}
.meta-info{font-size:13px;color:#495057;line-height:1.8}
.meta-row{margin-bottom:6px}
.sub-info{margin-top:12px;padding-top:12px;border-top:1px solid #e9ecef}
.dup-list{margin-top:8px}
.dup-item{display:flex;align-items:center;margin-top:4px;padding:4px 8px;background:#f8f9fa;border-radius:4px;font-size:12px}
.bv-tag{display:inline-block;background:#6f42c1;color:white;font-size:11px;padding:2px 6px;border-radius:3px;margin-right:8px}

/* å¤åˆ¶æç¤º */
.copy-toast{position:fixed;bottom:30px;right:30px;padding:10px 20px;background:rgba(0,0,0,0.8);color:white;border-radius:4px;font-size:14px;opacity:0;transform:translateY(20px);transition:all 0.3s;pointer-events:none;z-index:9999}
.copy-toast.show{opacity:1;transform:translateY(0)}
</style>
</head>
<body>
<div class="main">
  <!-- å¤´éƒ¨ -->
  <div class="header">
    <h2>ğŸ” BVæ­Œåº“è·¨åº“é‡å¤æ£€æŸ¥</h2>
    <div class="sub-header">
      è¾“å…¥BVå· â†’ è‡ªåŠ¨å®šä½æ¥æº â†’ åˆ‡æ¢æ ‡ç­¾é¡µå³åœ¨å¯¹åº”åº“æŸ¥é‡ | 
      <a href="index.html" class="nav-link">è¿”å›æ­Œæ›²æŸ¥è¯¢ä¸»ç«™</a> | 
      <a href="stats.html" class="nav-link">æŸ¥çœ‹æ¼”å”±è€…ç»Ÿè®¡ä¸æ’è¡Œ</a>
    </div>
    <p>æ”¯æŒçµæ´»å¤åˆ¶ç­›é€‰ | æŠ˜å æ€å±•ç¤ºæ ¸å¿ƒä¿¡æ¯</p>
  </div>

  <!-- æœç´¢æ  -->
  <div class="search-box">
    <input id="bvInput" placeholder="è¾“å…¥BVå·æˆ–Bç«™è§†é¢‘é“¾æ¥ï¼ˆä¾‹å¦‚ï¼šBV1pDfaByERNï¼‰" type="text">
    <button id="searchBtn">å¼€å§‹åˆ†æ</button>
  </div>

  <!-- æ¥æºæ ‡ç­¾é¡µ -->
  <div class="source-tabs" id="tabContainer"></div>

  <!-- ç­›é€‰æ  + ç»Ÿè®¡ -->
  <div class="filter-bar">
    <div class="stat-info" id="statInfo">è¯·è¾“å…¥BVå·å¼€å§‹åˆ†æ</div>
    <div>
      <button class="filter-btn" id="showAllBtn">æ˜¾ç¤ºå…¨éƒ¨æ­Œæ›²</button>
      <button class="filter-btn" id="showUniqueBtn">åªçœ‹æœªé‡å¤æ­Œæ›²</button>
    </div>
  </div>

  <!-- å¤åˆ¶ç­›é€‰åŒº -->
  <div class="copy-controls">
    <label><input type="checkbox" id="copyOnlyUnique" checked> ä»…å¤åˆ¶éé‡å¤æ­Œæ›²</label>
    <label><input type="checkbox" id="copyTitle" checked> æ­Œå</label>
    <label><input type="checkbox" id="copyLink"> æ­Œæ›²é“¾æ¥</label>
    <label><input type="checkbox" id="copyCount"> å‡ºç°æ¬¡æ•°</label>
    <label><input type="radio" name="copyFormat" id="copyText" checked> çº¯æ–‡æœ¬</label>
    <label><input type="radio" name="copyFormat" id="copyTable"> è¡¨æ ¼</label>
    <button class="copy-btn" id="copyBtn">ğŸ“‹ å¤åˆ¶ç»“æœ</button>
  </div>

  <!-- ç»“æœåˆ—è¡¨ -->
  <div class="result-list" id="resultList"></div>

  <!-- å¤åˆ¶æç¤º -->
  <div class="copy-toast" id="copyToast">å¤åˆ¶æˆåŠŸï¼</div>
</div>

<script>
// å…¨å±€å˜é‡
let allSongs = [];          // å…¨åº“æ­Œæ›²æ•°æ®
let fileList = [];          // JSæ–‡ä»¶åˆ—è¡¨
let fileAlias = {};         // æ–‡ä»¶åˆ«åæ˜ å°„
let currentTab = 'all';     // å½“å‰é€‰ä¸­çš„æ¥æºæ ‡ç­¾
let targetBvSongs = [];     // è¾“å…¥BVå¯¹åº”çš„æ‰€æœ‰æ­Œæ›²ï¼ˆå…¨åº“ç­›é€‰ï¼‰
let bvToSourceMap = new Map(); // BVå·åˆ°æ¥æºçš„æ˜ å°„
let analysisResult = [];    // æœ€æ–°åˆ†æç»“æœ
let showOnlyUnique = false; // æ˜¯å¦åªæ˜¾ç¤ºæœªé‡å¤æ­Œæ›²

// ================= å·¥å…·å‡½æ•° =================
// æå–BVå·
function extractBV(str) {
  if (!str) return '';
  const match = str.match(/BV[a-zA-Z0-9]+/);
  return match ? match[0] : '';
}

// æ˜¾ç¤ºå¤åˆ¶æç¤º
function showCopyToast() {
  const toast = document.getElementById('copyToast');
  toast.classList.add('show');
  setTimeout(() => toast.classList.remove('show'), 2000);
}

// åˆ‡æ¢æ˜¾ç¤ºæ¨¡å¼ï¼ˆå…¨éƒ¨/ä»…æœªé‡å¤ï¼‰
function toggleShowMode(onlyUnique) {
  showOnlyUnique = onlyUnique;
  // æ›´æ–°æŒ‰é’®æ ·å¼
  document.getElementById('showAllBtn').classList.toggle('active', !onlyUnique);
  document.getElementById('showUniqueBtn').classList.toggle('active', onlyUnique);
  // é‡æ–°æ¸²æŸ“åˆ—è¡¨
  renderSongList();
}

// ================= æ•°æ®åŠ è½½ =================
async function loadAllData() {
  try {
    // åŠ è½½ç´¢å¼•æ–‡ä»¶
    const indexRes = await fetch('data/index.json');
    const indexData = await indexRes.json();
    fileList = indexData.files || [];
    fileAlias = indexData.fileToAlias || {};
    
    // æ¸²æŸ“æ¥æºæ ‡ç­¾é¡µ
    renderSourceTabs();

    // å¹¶è¡ŒåŠ è½½æ‰€æœ‰JSæ–‡ä»¶
    const loadFileTasks = fileList.map(fileName => 
      fetch(`data/${fileName}`)
        .then(res => res.text())
        .then(jsContent => {
          // æ‰§è¡ŒJSæ–‡ä»¶è·å–æ­Œæ›²æ•°æ®
          const fakeWindow = { SONG_DATA: [] };
          try {
            const executeCode = new Function('window', jsContent);
            executeCode(fakeWindow);
          } catch (e) {
            console.warn(`æ‰§è¡Œ${fileName}å‡ºé”™ï¼š`, e.message);
          }
          // ç»™æ¯é¦–æ­Œæ·»åŠ æ¥æºæ ‡è¯†
          return fakeWindow.SONG_DATA.map(song => ({
            ...song,
            source: fileName
          }));
        })
        .catch(err => {
          console.error(`åŠ è½½${fileName}å¤±è´¥ï¼š`, err);
          return [];
        })
    );

    // åˆå¹¶æ‰€æœ‰æ­Œæ›²æ•°æ®
    const songArrays = await Promise.all(loadFileTasks);
    allSongs = songArrays.flat();
    
    // æ„å»ºBVå·åˆ°æ¥æºçš„æ˜ å°„
    allSongs.forEach(song => {
      const bv = extractBV(song.link);
      if (bv) bvToSourceMap.set(bv, song.source);
    });

    console.log(`âœ… å…¨åº“åŠ è½½å®Œæˆï¼šå…± ${allSongs.length} é¦–æ­Œæ›²`);
  } catch (err) {
    console.error('âŒ æ•°æ®åŠ è½½å¤±è´¥ï¼š', err);
    document.getElementById('statInfo').textContent = `æ•°æ®åŠ è½½å¤±è´¥ï¼š${err.message}`;
  }
}

// ================= ç•Œé¢æ¸²æŸ“ =================
// æ¸²æŸ“æ¥æºæ ‡ç­¾é¡µ
function renderSourceTabs() {
  const container = document.getElementById('tabContainer');
  container.innerHTML = '';

  // å…¨éƒ¨æ ‡ç­¾
  const allTab = document.createElement('div');
  allTab.className = `source-tab ${currentTab === 'all' ? 'active' : ''}`;
  allTab.textContent = 'å…¨éƒ¨';
  allTab.onclick = () => switchSourceTab('all');
  container.appendChild(allTab);

  // å„æ¥æºæ ‡ç­¾
  fileList.forEach(fileName => {
    const tab = document.createElement('div');
    tab.className = `source-tab ${currentTab === fileName ? 'active' : ''}`;
    tab.textContent = fileAlias[fileName.replace('.js', '')] || fileName;
    tab.onclick = () => switchSourceTab(fileName);
    container.appendChild(tab);
  });
}

// æ¸²æŸ“æ­Œæ›²åˆ—è¡¨ï¼ˆæ ¸å¿ƒï¼šæŠ˜å æ€å±•ç¤º3æ¡+æ•°æ®ï¼Œæ”¯æŒç­›é€‰æœªé‡å¤ï¼‰
function renderSongList() {
  const container = document.getElementById('resultList');
  container.innerHTML = '';

  if (analysisResult.length === 0) {
    container.innerHTML = '<div style="text-align:center;padding:20px;color:#6c757d;">æš‚æ— åˆ†æç»“æœï¼Œè¯·è¾“å…¥BVå·å¼€å§‹åˆ†æ</div>';
    return;
  }

  // ç­›é€‰è¦æ˜¾ç¤ºçš„æ­Œæ›²
  let displayResult = analysisResult;
  if (showOnlyUnique) {
    displayResult = analysisResult.filter(item => !item.isDup);
  }

  if (displayResult.length === 0) {
    container.innerHTML = '<div style="text-align:center;padding:20px;color:#6c757d;">æš‚æ— ç¬¦åˆæ¡ä»¶çš„æ­Œæ›²</div>';
    return;
  }

  displayResult.forEach((item, index) => {
    const song = item.song;
    const isDup = item.isDup;
    const dupList = item.dupList;
    const dupCount = dupList.length;
    
    // æ­Œæ›²é¡¹å®¹å™¨
    const songItem = document.createElement('div');
    songItem.className = `song-item ${isDup ? 'dup' : 'unique'}`;

    // æ ‡é¢˜åŒºåŸŸï¼ˆæŠ˜å æ€ï¼‰
    const titleDiv = document.createElement('div');
    titleDiv.className = 'song-title';
    titleDiv.innerHTML = `
      <div class="title-left">
        ${index + 1}. ${song.title}
        ${isDup ? `<span class="dup-tag">é‡å¤ ${dupCount} æ¬¡</span>` : `<span class="unique-tag">æ— é‡å¤</span>`}
      </div>
      <div class="title-right">
        <span class="collapse-toggle">â–¼</span>
      </div>
    `;

    // æŠ˜å æ€æ‘˜è¦ä¿¡æ¯
    const summaryDiv = document.createElement('div');
    summaryDiv.className = 'collapse-summary';
    
    // åŸºç¡€ä¿¡æ¯
    summaryDiv.innerHTML = `
      <div class="summary-item">ğŸ‘¤ æ­Œæ‰‹ï¼š${song.artist || 'æœªçŸ¥'}</div>
      <div class="summary-item">ğŸ“ åˆé›†ï¼š${song.collection || 'æœªçŸ¥'}</div>
      <div class="summary-item">ğŸ”— BVå·ï¼š${extractBV(song.link)}</div>
      <div class="summary-item">ğŸŒ é“¾æ¥ï¼š<a href="${song.link}" target="_blank" style="color:#00a1d6;">ç‚¹å‡»æŸ¥çœ‹</a></div>
      <div class="summary-item">ğŸ“Š å½“å‰åº“ï¼š${currentTab === 'all' ? 'å…¨éƒ¨' : fileAlias[currentTab.replace('.js', '')] || currentTab} | åŒ¹é…ç»“æœï¼š${dupCount} æ¡</div>
    `;

    // é‡å¤é¢„è§ˆï¼ˆæœ€å¤š3æ¡ï¼‰
    if (isDup) {
      const previewHtml = [];
      // å–å‰3æ¡é‡å¤é¡¹
      const previewItems = dupList.slice(0, 3);
      previewItems.forEach((dup, idx) => {
        previewHtml.push(`
          <div class="dup-preview-item">
            <span class="bv-tag">${extractBV(dup.link)}</span>
            ${dup.title} | ${fileAlias[dup.source.replace('.js', '')] || dup.source}
          </div>
        `);
      });
      // è¶…è¿‡3æ¡æ˜¾ç¤ºæ›´å¤šæç¤º
      if (dupCount > 3) {
        previewHtml.push(`<div class="dup-preview-more">... è¿˜æœ‰ ${dupCount - 3} æ¡é‡å¤é¡¹ï¼ˆç‚¹å‡»å±•å¼€æŸ¥çœ‹å…¨éƒ¨ï¼‰</div>`);
      }
      
      summaryDiv.innerHTML += `
        <div class="dup-preview">
          <div style="font-size:12px;margin-bottom:4px;color:#dc3545;">é‡å¤é¢„è§ˆï¼ˆå‰3æ¡ï¼‰ï¼š</div>
          ${previewHtml.join('')}
        </div>
      `;
    }

    // å±•å¼€å†…å®¹åŒºåŸŸ
    const contentDiv = document.createElement('div');
    contentDiv.className = 'collapse-content';
    
    // å±•å¼€å†…å®¹è¯¦æƒ…
    let dupListHtml = '';
    if (isDup) {
      dupList.forEach(dup => {
        dupListHtml += `
          <div class="dup-item">
            <span class="bv-tag">${extractBV(dup.link)}</span>
            <div style="flex:1;">
              <div>${dup.title}</div>
              <div style="font-size:11px;color:#6c757d;">
                æ­Œæ‰‹ï¼š${dup.artist || 'æœªçŸ¥'} | æ¥æºï¼š${fileAlias[dup.source.replace('.js', '')] || dup.source}
                <br>é“¾æ¥ï¼š<a href="${dup.link}" target="_blank" style="color:#00a1d6;">${dup.link}</a>
              </div>
            </div>
          </div>
        `;
      });
    }

    contentDiv.innerHTML = `
      <div class="meta-info">
        <div class="meta-row">ğŸ‘¤ æ­Œæ‰‹ï¼š${song.artist || 'æœªçŸ¥'}</div>
        <div class="meta-row">ğŸ“ åˆé›†ï¼š${song.collection || 'æœªçŸ¥'}</div>
        <div class="meta-row">ğŸ”— é“¾æ¥ï¼š<a href="${song.link}" target="_blank" style="color:#00a1d6;">${song.link}</a></div>
        <div class="meta-row">ğŸ“¦ æ¥æºï¼š${fileAlias[song.source.replace('.js', '')] || song.source}</div>
        <div class="sub-info">
          <div style="font-weight:500;margin-bottom:8px;">
            åœ¨ã€${currentTab === 'all' ? 'å…¨éƒ¨' : fileAlias[currentTab.replace('.js', '')] || currentTab}ã€‘ä¸­æ‰¾åˆ° ${dupCount} æ¡åŒ¹é…ç»“æœï¼š
          </div>
          <div class="dup-list">${isDup ? dupListHtml : '<div style="color:#28a745;">âœ… æ— é‡å¤è®°å½•</div>'}</div>
        </div>
      </div>
    `;

    // æŠ˜å /å±•å¼€åˆ‡æ¢
    titleDiv.addEventListener('click', () => {
      contentDiv.classList.toggle('show');
      const toggleIcon = titleDiv.querySelector('.collapse-toggle');
      toggleIcon.textContent = contentDiv.classList.contains('show') ? 'â–²' : 'â–¼';
    });

    // ç»„è£…æ­Œæ›²é¡¹
    songItem.appendChild(titleDiv);
    songItem.appendChild(summaryDiv);
    songItem.appendChild(contentDiv);
    container.appendChild(songItem);
  });
}

// ================= æ ¸å¿ƒé€»è¾‘ =================
// åˆ‡æ¢æ¥æºæ ‡ç­¾é¡µ
function switchSourceTab(tab) {
  currentTab = tab;
  renderSourceTabs();
  // é‡æ–°åˆ†æï¼ˆå¸¦ç€ä¹‹å‰çš„BVæ­Œæ›²åˆ—è¡¨ï¼‰
  if (targetBvSongs.length > 0) {
    analyzeDuplicates();
  }
}

// æœç´¢BVå·ï¼ˆå…¨åº“ç­›é€‰å¯¹åº”æ­Œæ›²ï¼‰
function searchBV() {
  const input = document.getElementById('bvInput').value.trim();
  const bv = extractBV(input);
  
  if (!bv) {
    alert('è¯·è¾“å…¥æœ‰æ•ˆçš„BVå·æˆ–Bç«™è§†é¢‘é“¾æ¥ï¼');
    return;
  }

  // é‡ç½®ç­›é€‰çŠ¶æ€
  toggleShowMode(false);

  // å…¨åº“ç­›é€‰è¯¥BVå¯¹åº”çš„æ‰€æœ‰æ­Œæ›²
  targetBvSongs = allSongs.filter(song => extractBV(song.link) === bv);
  
  if (targetBvSongs.length === 0) {
    document.getElementById('statInfo').textContent = `æœªæ‰¾åˆ°BVå·ã€Œ${bv}ã€çš„ç›¸å…³æ­Œæ›²`;
    document.getElementById('resultList').innerHTML = `<div style="text-align:center;padding:20px;color:#6c757d;">æœªæ‰¾åˆ°BVå·ã€Œ${bv}ã€çš„ç›¸å…³æ­Œæ›²</div>`;
    analysisResult = [];
    return;
  }

  // è‡ªåŠ¨åˆ‡æ¢åˆ°è¯¥BVçš„ä¸»è¦æ¥æºæ ‡ç­¾
  const mainSource = targetBvSongs[0].source;
  switchSourceTab(mainSource);
}

// åˆ†æé‡å¤ï¼ˆæ ¸å¿ƒï¼šåœ¨å½“å‰æ ‡ç­¾åº“ä¸­æŸ¥é‡ï¼‰
function analyzeDuplicates() {
  // ç­›é€‰å½“å‰æ ‡ç­¾åº“çš„æ­Œæ›²æ± 
  const currentPool = currentTab === 'all' 
    ? allSongs 
    : allSongs.filter(song => song.source === currentTab);

  // åˆ†ææ¯é¦–ç›®æ ‡æ­Œæ›²çš„é‡å¤æƒ…å†µ
  analysisResult = targetBvSongs.map(song => {
    // æŒ‰æ ‡é¢˜ï¼ˆå¿½ç•¥å¤§å°å†™ï¼‰åŒ¹é…é‡å¤é¡¹
    const songTitle = (song.title || '').trim().toLowerCase();
    const dupList = currentPool.filter(item => 
      (item.title || '').trim().toLowerCase() === songTitle
    );

    return {
      song: song,
      dupList: dupList,
      isDup: dupList.length > 1, // é‡å¤åˆ¤æ–­ï¼ˆå‡ºç°æ¬¡æ•°>1ï¼‰
      dupCount: dupList.length
    };
  });

  // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
  const total = targetBvSongs.length;
  const dupCount = analysisResult.filter(item => item.isDup).length;
  const uniqueCount = total - dupCount;
  const currentSourceName = currentTab === 'all' ? 'å…¨éƒ¨' : fileAlias[currentTab.replace('.js', '')] || currentTab;
  
  document.getElementById('statInfo').textContent = 
    `åˆ†æBVæ­Œæ›²ï¼š${total} é¦– | å½“å‰åº“ï¼š${currentSourceName} | é‡å¤ï¼š${dupCount} é¦– | éé‡å¤ï¼š${uniqueCount} é¦–`;

  // æ¸²æŸ“ç»“æœåˆ—è¡¨
  renderSongList();
}

// å¤åˆ¶åŠŸèƒ½ï¼ˆæ”¯æŒç­›é€‰å’Œæ ¼å¼è‡ªå®šä¹‰ï¼‰
function copyResults() {
  if (analysisResult.length === 0) {
    alert('æš‚æ— åˆ†æç»“æœå¯å¤åˆ¶ï¼');
    return;
  }

  // è·å–å¤åˆ¶é€‰é¡¹
  const onlyUnique = document.getElementById('copyOnlyUnique').checked;
  const includeTitle = document.getElementById('copyTitle').checked;
  const includeLink = document.getElementById('copyLink').checked;
  const includeCount = document.getElementById('copyCount').checked;
  const isTextFormat = document.getElementById('copyText').checked;

  // ç­›é€‰è¦å¤åˆ¶çš„æ­Œæ›²
  let copyData = analysisResult;
  if (onlyUnique) {
    copyData = analysisResult.filter(item => !item.isDup);
  }

  if (copyData.length === 0) {
    alert('æ²¡æœ‰ç¬¦åˆç­›é€‰æ¡ä»¶çš„æ­Œæ›²å¯å¤åˆ¶ï¼');
    return;
  }

  // æ„å»ºå¤åˆ¶å†…å®¹
  let content = '';
  
  // çº¯æ–‡æœ¬æ ¼å¼
  if (isTextFormat) {
    copyData.forEach(item => {
      const parts = [];
      if (includeTitle) parts.push(item.song.title || 'æœªçŸ¥æ­Œæ›²');
      if (includeLink) parts.push(`é“¾æ¥ï¼š${item.song.link}`);
      if (includeCount) parts.push(`æ¬¡æ•°ï¼š${item.dupCount}`);
      content += parts.join(' | ') + '\n';
    });
  } 
  // è¡¨æ ¼æ ¼å¼ï¼ˆTSVï¼Œå¯ç›´æ¥ç²˜è´´åˆ°Excelï¼‰
  else {
    // è¡¨å¤´
    const headers = [];
    if (includeTitle) headers.push('æ­Œå');
    if (includeLink) headers.push('æ­Œæ›²é“¾æ¥');
    if (includeCount) headers.push('å‡ºç°æ¬¡æ•°');
    content += headers.join('\t') + '\n';
    
    // å†…å®¹è¡Œ
    copyData.forEach(item => {
      const row = [];
      if (includeTitle) row.push(item.song.title || 'æœªçŸ¥æ­Œæ›²');
      if (includeLink) row.push(item.song.link);
      if (includeCount) row.push(item.dupCount);
      content += row.join('\t') + '\n';
    });
  }

  // å¤åˆ¶åˆ°å‰ªè´´æ¿
  navigator.clipboard.writeText(content.trim())
    .then(() => {
      showCopyToast();
    })
    .catch(err => {
      console.error('å¤åˆ¶å¤±è´¥ï¼š', err);
      alert('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶ï¼');
    });
}

// ================= åˆå§‹åŒ– =================
function init() {
  // åŠ è½½å…¨åº“æ•°æ®
  loadAllData();

  // ç»‘å®šæœç´¢æŒ‰é’®äº‹ä»¶
  document.getElementById('searchBtn').addEventListener('click', searchBV);
  
  // å›è½¦è§¦å‘æœç´¢
  document.getElementById('bvInput').addEventListener('keydown', e => {
    if (e.key === 'Enter') searchBV();
  });

  // ç»‘å®šç­›é€‰æŒ‰é’®äº‹ä»¶
  document.getElementById('showAllBtn').addEventListener('click', () => toggleShowMode(false));
  document.getElementById('showUniqueBtn').addEventListener('click', () => toggleShowMode(true));

  // ç»‘å®šå¤åˆ¶æŒ‰é’®äº‹ä»¶
  document.getElementById('copyBtn').addEventListener('click', copyResults);
}

// å¯åŠ¨åº”ç”¨
document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
