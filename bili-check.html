<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ­Œåº“åˆ†Pé‡å¤åˆ†æå·¥å…·</title>
    <style>
        /* å¤ç”¨ä¸»é¡µé¢å…¨å±€æ ·å¼ */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "PingFang SC", "Microsoft YaHei", sans-serif; 
            max-width: 1200px; margin: 0 auto; padding: 30px 20px; 
            background: linear-gradient(135deg, #f5f7fa 0%, #e4e8ec 100%); min-height: 100vh;
        }
        h1 { text-align: center; color: #2c3e50; margin-bottom: 10px; font-size: 28px; font-weight: 700; }
        .sub-header { text-align: center; color: #6c757d; margin-bottom: 30px; font-size: 14px; }
        .nav-link { color: #00a1d6; text-decoration: none; font-weight: 600; }
        .nav-link:hover { text-decoration: underline; }
        
        /* ç­›é€‰æ æ ·å¼ï¼ˆå’Œä¸»é¡µé¢ä¸€è‡´ï¼‰ */
        .filter-bar {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            padding: 15px 20px;
            background: white;
            border-radius: 12px;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            margin-bottom: 20px;
        }
        .filter-label {
            font-size: 14px;
            color: #495057;
            font-weight: 600;
            white-space: nowrap;
        }
        .filter-btn {
            padding: 7px 16px;
            border: 1px solid #e9ecef;
            border-radius: 20px;
            background: #f8f9fa;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            color: #495057;
            transition: all 0.2s ease;
        }
        .filter-btn:hover {
            border-color: #00a1d6;
            color: #00a1d6;
            background: #f0f9ff;
        }
        .filter-btn.active {
            background: linear-gradient(135deg, #00a1d6 0%, #00c6ff 100%);
            color: white;
            border-color: transparent;
            box-shadow: 0 4px 12px rgba(0, 161, 214, 0.3);
        }
        .filter-btn.clear {
            margin-left: auto;
            background: linear-gradient(135deg, #6c757d 0%, #adb5bd 100%);
            color: white;
            border-color: transparent;
            box-shadow: 0 4px 12px rgba(108, 117, 125, 0.3);
        }
        
        /* åˆ†æè¡¨å•æ ·å¼ */
        .analysis-container {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            margin-bottom: 25px;
        }
        .form-group {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }
        #keyword-input {
            flex: 1;
            min-width: 250px;
            padding: 16px 20px;
            font-size: 16px;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            outline: none;
        }
        #keyword-input:focus {
            border-color: #00a1d6;
            box-shadow: 0 0 0 4px rgba(0, 161, 214, 0.1);
        }
        #analyze-btn {
            padding: 0 32px;
            background: linear-gradient(135deg, #00a1d6 0%, #00c6ff 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            white-space: nowrap;
        }
        #analyze-btn:disabled {
            background: #adb5bd;
            cursor: not-allowed;
        }
        
        /* ç»“æœæ ·å¼ */
        .progress-msg, .error-msg, .empty-msg {
            text-align: center;
            padding: 20px;
            font-size: 16px;
            color: #495057;
        }
        .error-msg { color: #dc3545; }
        .stats-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            margin-bottom: 20px;
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            align-items: center;
        }
        .stat-item {
            flex: 1;
            min-width: 150px;
            text-align: center;
        }
        .stat-value {
            font-size: 24px;
            font-weight: 700;
            color: #00a1d6;
            margin-bottom: 5px;
        }
        .stat-label {
            font-size: 14px;
            color: #6c757d;
        }
        .duplicate-rate { color: #dc3545 !important; }
        .unique-count { color: #28a745 !important; }
        
        /* åˆ—è¡¨æ ·å¼ */
        .result-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 15px;
        }
        .tab-btn {
            padding: 8px 16px;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            background: white;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
        }
        .tab-btn.active {
            background: #00a1d6;
            color: white;
            border-color: #00a1d6;
        }
        .result-list {
            list-style: none;
            padding: 0;
        }
        .result-item {
            padding: 15px;
            background: white;
            border-radius: 8px;
            margin-bottom: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.04);
            transition: all 0.2s;
        }
        /* é«˜äº®æœªé‡å¤æ­Œæ›² */
        .result-item.unique {
            border-left: 4px solid #28a745;
            background: linear-gradient(90deg, #f0fff4 0%, #ffffff 100%);
        }
        /* é‡å¤æ­Œæ›²æ ·å¼ */
        .result-item.duplicate {
            border-left: 4px solid #dc3545;
            background: linear-gradient(90deg, #fff5f5 0%, #ffffff 100%);
        }
        .item-title {
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
        }
        .expand-btn {
            background: none;
            border: none;
            color: #00a1d6;
            cursor: pointer;
            font-size: 16px;
            padding: 2px 6px;
        }
        .item-meta {
            font-size: 14px;
            color: #6c757d;
            line-height: 1.5;
        }
        .duplicate-tag {
            display: inline-block;
            padding: 2px 8px;
            background: #dc3545;
            color: white;
            border-radius: 4px;
            font-size: 12px;
            margin-left: 8px;
        }
        .unique-tag {
            display: inline-block;
            padding: 2px 8px;
            background: #28a745;
            color: white;
            border-radius: 4px;
            font-size: 12px;
            margin-left: 8px;
        }
        .source-tag {
            display: inline-block;
            padding: 2px 6px;
            background: #00a1d6;
            color: white;
            border-radius: 3px;
            font-size: 11px;
            margin-right: 6px;
        }
        
        /* æŠ˜å /å±•å¼€æ ·å¼ */
        .collapsible-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }
        .collapsible-content.expanded {
            max-height: 2000px; /* è¶³å¤Ÿå¤§çš„é«˜åº¦ */
        }
        .tag-list {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin: 8px 0;
        }
        .tag-item {
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 11px;
            color: white;
            background: #6f42c1;
        }
        .song-details {
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid #f1f3f5;
        }
        .song-item {
            margin-bottom: 6px;
            padding: 6px;
            background: #f8f9fa;
            border-radius: 4px;
        }
        
        .copy-toast {
            position: fixed;
            bottom: 30px;
            right: 30px;
            padding: 10px 20px;
            background: rgba(0, 0, 0, 0.75);
            color: white;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 500;
            z-index: 9999;
            opacity: 0;
            transform: translateY(10px);
            transition: all 0.3s ease;
            pointer-events: none;
        }
        .copy-toast.show {
            opacity: 1;
            transform: translateY(0);
        }
    </style>
</head>
<body>
    <h1>ğŸ“Š æ­Œåº“åˆ†Pé‡å¤åˆ†æå·¥å…·</h1>
    <div class="sub-header">
        çº¯æœ¬åœ°æ­Œåº“åˆ†æ | æ— éœ€è°ƒç”¨Bç«™æ¥å£ | <a href="index.html" class="nav-link">è¿”å›æ­Œæ›²æŸ¥è¯¢</a> | <a href="stats.html" class="nav-link">æ¼”å”±è€…ç»Ÿè®¡</a>
    </div>

    <!-- æ¥æºç­›é€‰æ  -->
    <div class="filter-bar" id="filter-bar">
        <span class="filter-label">ğŸ” æŒ‰æ¥æºç­›é€‰ï¼š</span>
    </div>

    <div class="analysis-container">
        <div class="form-group">
            <input type="text" id="keyword-input" placeholder="è¾“å…¥BVå·/Bç«™é“¾æ¥ï¼ˆä»…æ”¯æŒBVå·åˆ†æï¼‰" maxlength="50">
            <button id="analyze-btn">ğŸš€ å¼€å§‹åˆ†æ</button>
        </div>
    </div>

    <div class="progress-msg" id="progress-msg">è¯·è¾“å…¥BVå·/Bç«™é“¾æ¥è¿›è¡Œåˆ†æ</div>
    <div class="error-msg" id="error-msg" style="display: none;"></div>
    
    <!-- ç»Ÿè®¡å¡ç‰‡ï¼ˆåˆå§‹éšè—ï¼‰ -->
    <div id="stats-card" class="stats-card" style="display: none;">
        <div class="stat-item">
            <div class="stat-value" id="total-songs">0</div>
            <div class="stat-label">åˆ†ææ­Œæ›²æ€»æ•°</div>
        </div>
        <div class="stat-item">
            <div class="stat-value unique-count" id="unique-count">0</div>
            <div class="stat-label">æœªé‡å¤æ­Œæ›²æ•°</div>
        </div>
        <div class="stat-item">
            <div class="stat-value" id="duplicate-count">0</div>
            <div class="stat-label">é‡å¤æ­Œæ›²æ•°</div>
        </div>
        <div class="stat-item">
            <div class="stat-value duplicate-rate" id="duplicate-rate">0.00%</div>
            <div class="stat-label">é‡å¤ç‡</div>
        </div>
        <div class="stat-item">
            <div class="stat-value" id="filter-total">0</div>
            <div class="stat-label">ç­›é€‰åæ­Œåº“æ•°</div>
        </div>
    </div>

    <!-- ç»“æœæ ‡ç­¾é¡µï¼ˆåˆå§‹éšè—ï¼‰ -->
    <div id="result-tabs" class="result-tabs" style="display: none;">
        <button class="tab-btn active" data-tab="all">å…¨éƒ¨æ­Œæ›²</button>
        <button class="tab-btn" data-tab="unique">æœªé‡å¤æ­Œæ›²</button>
        <button class="tab-btn" data-tab="duplicate">é‡å¤æ­Œæ›²</button>
    </div>

    <!-- å…¨éƒ¨ç»“æœåˆ—è¡¨ï¼ˆåˆå§‹éšè—ï¼‰ -->
    <ul id="all-list" class="result-list" style="display: none;"></ul>
    <!-- æœªé‡å¤ç»“æœåˆ—è¡¨ï¼ˆåˆå§‹éšè—ï¼‰ -->
    <ul id="unique-list" class="result-list" style="display: none;"></ul>
    <!-- é‡å¤ç»“æœåˆ—è¡¨ï¼ˆåˆå§‹éšè—ï¼‰ -->
    <ul id="duplicate-list" class="result-list" style="display: none;"></ul>

    <div class="copy-toast" id="copy-toast">copy ok!</div>

    <script>
        // ================= å…¨å±€å˜é‡ =================
        let allSiteSongs = [];       // æ‰€æœ‰æ­Œæ›²æ•°æ®
        let filteredSongs = [];      // ç­›é€‰åçš„æ­Œæ›²æ•°æ®ï¼ˆæŒ‰æ¥æºç­›é€‰ï¼‰
        let currentAnalysisResult = null;
        let activeSource = 'all';    // å½“å‰é€‰ä¸­çš„æ¥æº
        let FILE_TO_ALIAS = {};      // æ–‡ä»¶åˆ«åæ˜ å°„

        // ================= æ ¸å¿ƒå·¥å…·å‡½æ•° =================
        function normalizeString(str) {
            if (!str) return '';
            let s = str.trim();
            // å…¨è§’è½¬åŠè§’
            s = s.replace(/[\uFF01-\uFF5E]/g, function(ch) {
                return String.fromCharCode(ch.charCodeAt(0) - 0xFEE0);
            });
            // ç‰¹æ®Šç¬¦å·ç»Ÿä¸€
            s = s.replace(/\u3000/g, ' ');
            s = s.replace(/[ï½ã€œËœ]/g, '~');
            s = s.replace(/[â€”â€“â€•]/g, '-');
            s = s.replace(/[â€œâ€]/g, '"').replace(/[â€˜â€™]/g, "'");
            s = s.replace(/â€¦/g, '...');
            s = s.replace(/\s+/g, ' ');
            return s.toLowerCase();
        }

        // ç²¾å‡†æå–BVå·ï¼ˆä¸ç®¡æœ‰æ²¡æœ‰?p=xxåç¼€ï¼‰
        function extractBvidFromLink(link) {
            if (!link) return '';
            // åŒ¹é…BVå¼€å¤´ï¼Œåé¢è·Ÿä»»æ„å­—æ¯æ•°å­—ï¼Œç›´åˆ°é‡åˆ°?æˆ–/æˆ–ç©ºæ ¼
            const bvidMatch = link.match(/BV[a-zA-Z0-9]+/);
            return bvidMatch ? bvidMatch[0] : '';
        }

        // BVå·åŒ¹é…é€»è¾‘ï¼ˆè¾“å…¥çš„BVå·å’Œæ­Œåº“ä¸­çš„BVå·ç²¾å‡†åŒ¹é…ï¼‰
        function isBvidMatch(inputBvid, songBvid) {
            if (!inputBvid || !songBvid) return false;
            // å…ˆæå–çº¯BVå·ï¼ˆå»æ‰å¯èƒ½çš„åç¼€ï¼‰
            const pureInputBvid = extractBvidFromLink(inputBvid);
            const pureSongBvid = extractBvidFromLink(songBvid);
            return pureInputBvid === pureSongBvid;
        }

        // ================= å¤åˆ¶å·¥å…·å‡½æ•° =================
        function showCopyToast() {
            const toast = document.getElementById('copy-toast');
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 1500);
        }

        async function copyToClipboard(text) {
            try {
                await navigator.clipboard.writeText(text);
                showCopyToast();
            } catch (err) {
                console.error('å¤åˆ¶å¤±è´¥:', err);
                alert('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶');
            }
        }

        // ================= æ¥æºç­›é€‰é€»è¾‘ï¼ˆä¿®å¤ï¼šç²¾å‡†ç­›é€‰å¯¹åº”JSåº“ï¼‰ =================
        function generateFilterButtons(fileNames) {
            const filterBar = document.getElementById('filter-bar');
            filterBar.innerHTML = '<span class="filter-label">ğŸ” æŒ‰æ¥æºç­›é€‰ï¼š</span>';

            // å…¨éƒ¨æŒ‰é’®
            const allBtn = document.createElement('button');
            allBtn.className = `filter-btn ${activeSource === 'all' ? 'active' : ''}`;
            allBtn.textContent = 'å…¨éƒ¨';
            allBtn.onclick = () => switchSource('all');
            filterBar.appendChild(allBtn);

            // åˆ†éš”ç¬¦
            const spacer = document.createElement('span');
            spacer.style.width = '10px';
            filterBar.appendChild(spacer);

            // æ¥æºæŒ‰é’®
            fileNames.forEach(fileName => {
                const fileBase = fileName.replace('.js', '');
                const btnText = FILE_TO_ALIAS[fileBase] || fileBase;
                const btn = document.createElement('button');
                btn.className = `filter-btn ${activeSource === fileName ? 'active' : ''}`;
                btn.textContent = btnText;
                btn.onclick = () => switchSource(fileName);
                filterBar.appendChild(btn);
            });

            // æ¸…ç©ºç­›é€‰æŒ‰é’®
            const clearBtn = document.createElement('button');
            clearBtn.className = 'filter-btn clear';
            clearBtn.textContent = 'æ¸…ç©ºç­›é€‰';
            clearBtn.onclick = () => {
                activeSource = 'all';
                generateFilterButtons(Object.keys(FILE_TO_ALIAS).map(key => `${key}.js`));
                updateFilteredSongs();
            };
            filterBar.appendChild(clearBtn);
        }

        function switchSource(source) {
            activeSource = source;
            generateFilterButtons(Object.keys(FILE_TO_ALIAS).map(key => `${key}.js`));
            // å…³é”®ä¿®å¤ï¼šç²¾å‡†ç­›é€‰å¯¹åº”æ¥æºçš„æ­Œæ›²
            updateFilteredSongs();
            // é‡ç½®åˆ†æç»“æœ
            document.getElementById('stats-card').style.display = 'none';
            document.getElementById('result-tabs').style.display = 'none';
            document.querySelectorAll('.result-list').forEach(list => list.style.display = 'none');
            document.getElementById('progress-msg').textContent = `å·²ç­›é€‰ï¼š${source === 'all' ? 'å…¨éƒ¨æ¥æº' : FILE_TO_ALIAS[source.replace('.js', '')] || source}ï¼Œè¯·è¾“å…¥BVå·/Bç«™é“¾æ¥è¿›è¡Œåˆ†æ`;
        }

        function updateFilteredSongs() {
            // å…³é”®ä¿®å¤ï¼šä¸¥æ ¼æŒ‰æ¥æºç­›é€‰æ­Œæ›²
            if (activeSource === 'all') {
                filteredSongs = [...allSiteSongs];
            } else {
                // åªç­›é€‰sourceå­—æ®µç­‰äºé€‰ä¸­æ–‡ä»¶åçš„æ­Œæ›²
                filteredSongs = allSiteSongs.filter(item => item.source === activeSource);
            }
            document.getElementById('progress-msg').textContent = `âœ… ç­›é€‰å®Œæˆï¼ˆ${filteredSongs.length} é¦–ï¼‰ï¼Œè¯·è¾“å…¥BVå·/Bç«™é“¾æ¥è¿›è¡Œåˆ†æ`;
        }

        // ================= ä¿®å¤æ ¸å¿ƒï¼šå¼‚æ­¥åŠ è½½æ­Œåº“æ•°æ® =================
        async function loadSiteSongs() {
            try {
                const progressMsg = document.getElementById('progress-msg');
                progressMsg.textContent = 'ğŸ“¥ æ­£åœ¨åŠ è½½æ­Œåº“æ•°æ®...';

                // 1. åŠ è½½ç´¢å¼•
                const indexRes = await fetch('data/index.json');
                if (!indexRes.ok) throw new Error(`åŠ è½½ç´¢å¼•å¤±è´¥ï¼ˆ${indexRes.status}ï¼‰`);
                const indexData = await indexRes.json();
                FILE_TO_ALIAS = indexData.fileToAlias || {};

                // 2. å¼‚æ­¥åŠ è½½å•ä¸ªæ–‡ä»¶ï¼ˆä¿®å¤pushæŠ¥é”™é—®é¢˜ï¼‰
                const loadSingleFile = async (fileName) => {
                    try {
                        const res = await fetch(`data/${fileName}`);
                        if (!res.ok) throw new Error(`HTTPé”™è¯¯ ${res.status}`);
                        const jsContent = await res.text();

                        // å…³é”®ä¿®å¤ï¼šå…ˆåˆå§‹åŒ–SONG_DATAå†æ‰§è¡Œä»£ç 
                        const fakeWindow = { SONG_DATA: [] };
                        try {
                            // ä½¿ç”¨Functionæ„é€ å™¨æ‰§è¡Œï¼Œé¿å…evalçš„ä½œç”¨åŸŸé—®é¢˜
                            const executeCode = new Function('window', jsContent);
                            executeCode(fakeWindow);
                        } catch (execErr) {
                            console.warn(`âš ï¸  æ‰§è¡Œ${fileName}æ—¶è­¦å‘Šï¼š`, execErr.message);
                            // å…¼å®¹æ—§ç‰ˆï¼šå°è¯•ç›´æ¥æå–æ•°ç»„
                            const match = jsContent.match(/window\.SONG_DATA\s*=\s*(\[.+\]);/s);
                            if (match && match[1]) {
                                fakeWindow.SONG_DATA = JSON.parse(match[1]);
                            }
                        }

                        // éªŒè¯åŠ è½½ç»“æœ
                        const loadedSongs = Array.isArray(fakeWindow.SONG_DATA) ? fakeWindow.SONG_DATA : [];
                        console.log(`âœ… åŠ è½½${fileName}æˆåŠŸï¼š${loadedSongs.length} é¦–`);

                        // ç»™æ¯é¦–æ­Œæ·»åŠ sourceå­—æ®µå’Œæå–BVå·
                        loadedSongs.forEach(item => {
                            item.source = fileName; // æ ‡è®°æ¥æºæ–‡ä»¶å
                            item.bvid = extractBvidFromLink(item.link); // æå–çº¯BVå·
                        });

                        return loadedSongs;
                    } catch (err) {
                        console.error(`âŒ åŠ è½½${fileName}å¤±è´¥ï¼š`, err.message);
                        return [];
                    }
                };

                // 3. å¼‚æ­¥å¹¶è¡ŒåŠ è½½ï¼ˆæ¢å¤ä¸»æ–‡ä»¶çš„åŠ è½½é€Ÿåº¦ï¼‰
                const filePromises = indexData.files.map(fileName => loadSingleFile(fileName));
                const songArrays = await Promise.all(filePromises);
                
                // 4. åˆå¹¶æ‰€æœ‰æ­Œæ›²
                allSiteSongs = songArrays.flat();
                filteredSongs = [...allSiteSongs]; // åˆå§‹ç­›é€‰ä¸ºå…¨éƒ¨

                console.log(`âœ… æ‰€æœ‰æ­Œåº“åŠ è½½å®Œæˆï¼šå…± ${allSiteSongs.length} é¦–`);

                // 5. ç”Ÿæˆç­›é€‰æŒ‰é’®
                generateFilterButtons(indexData.files);

                progressMsg.textContent = `âœ… æ­Œåº“åŠ è½½å®Œæˆï¼ˆå…± ${allSiteSongs.length} é¦–ï¼‰ï¼Œè¯·è¾“å…¥BVå·/Bç«™é“¾æ¥è¿›è¡Œåˆ†æ`;
                document.getElementById('analyze-btn').disabled = false;

            } catch (err) {
                document.getElementById('progress-msg').style.display = 'none';
                document.getElementById('error-msg').style.display = 'block';
                document.getElementById('error-msg').textContent = `âŒ æ­Œåº“åŠ è½½å¤±è´¥ï¼š${err.message}`;
                document.getElementById('analyze-btn').disabled = true;
            }
        }

        // ================= æ ¸å¿ƒï¼šé‡å¤åˆ†æé€»è¾‘ï¼ˆä»…æ”¯æŒBVå·ï¼‰ =================
        function analyzeDuplicateSongs(keyword) {
            // 1. æå–çº¯BVå·
            const inputBvid = extractBvidFromLink(keyword);
            if (!inputBvid) {
                throw new Error('è¯·è¾“å…¥æœ‰æ•ˆçš„BVå·æˆ–Bç«™é“¾æ¥');
            }

            // 2. ç­›é€‰è¯¥BVå·çš„æ‰€æœ‰æ­Œæ›²ï¼ˆåœ¨å·²ç­›é€‰çš„æ¥æºåº“ä¸­ï¼‰
            const targetSongs = filteredSongs.filter(song => isBvidMatch(inputBvid, song.bvid));
            
            console.log(`ğŸ” ç­›é€‰ç»“æœ - æ¥æºï¼š${activeSource} | BVå·ï¼š${inputBvid} | æ­Œæ›²æ•°ï¼š${targetSongs.length} é¦–`);

            if (targetSongs.length === 0) {
                throw new Error(`æœªæ‰¾åˆ°BVå·ã€Œ${inputBvid}ã€çš„æ­Œæ›²æ•°æ®`);
            }

            // 3. æ„å»ºå…¨åº“é‡å¤ç»Ÿè®¡æ˜ å°„ï¼ˆåœ¨å·²ç­›é€‰çš„æ¥æºåº“ä¸­ï¼‰
            const songStats = {};
            
            // éå†ç­›é€‰åçš„å…¨éƒ¨æ­Œæ›²ï¼Œç»Ÿè®¡é‡å¤æƒ…å†µ
            filteredSongs.forEach(song => {
                const songKey = normalizeString(song.title || 'æœªçŸ¥æ­Œæ›²');

                if (!songStats[songKey]) {
                    songStats[songKey] = {
                        originalTitle: song.title || 'æœªçŸ¥æ­Œæ›²',
                        originalArtist: song.artist || 'æœªçŸ¥æ­Œæ‰‹',
                        count: 0,                  // æ€»å‡ºç°æ¬¡æ•°
                        duplicateTimes: 0,         // é‡å¤æ¬¡æ•°ï¼ˆcount-1ï¼‰
                        duplicateSessions: 0,      // é‡å¤åœºæ¬¡ï¼ˆä¸åŒæ¥æºæ•°-1ï¼‰
                        sources: new Set(),        // æ¥æºé›†åˆ
                        bvids: new Set(),          // å…³è”çš„BVå·é›†åˆ
                        songs: []                  // æ‰€æœ‰åŒ¹é…çš„æ­Œæ›²è¯¦æƒ…
                    };
                }
                
                songStats[songKey].count++;
                songStats[songKey].sources.add(song.source || 'æœªçŸ¥');
                songStats[songKey].bvids.add(song.bvid || 'æœªçŸ¥');
                songStats[songKey].songs.push(song);
            });

            // è®¡ç®—é‡å¤æ¬¡æ•°å’Œåœºæ¬¡
            Object.keys(songStats).forEach(key => {
                const stats = songStats[key];
                stats.duplicateTimes = Math.max(0, stats.count - 1);
                stats.duplicateSessions = Math.max(0, stats.sources.size - 1);
                stats.sources = Array.from(stats.sources);
                stats.bvids = Array.from(stats.bvids);
            });

            // 4. ç­›é€‰å‡ºç›®æ ‡BVå·æ­Œæ›²å¯¹åº”çš„ç»Ÿè®¡ç»“æœ
            const targetSongKeys = new Set();
            targetSongs.forEach(song => {
                const songKey = normalizeString(song.title || 'æœªçŸ¥æ­Œæ›²');
                targetSongKeys.add(songKey);
            });

            // æå–ç›®æ ‡æ­Œæ›²çš„ç»Ÿè®¡æ•°æ®
            const targetStats = Array.from(targetSongKeys).map(key => songStats[key]);
            
            // 5. åˆ†ç±»æœªé‡å¤/é‡å¤æ­Œæ›²
            const uniqueSongs = targetStats.filter(stats => stats.count === 1);
            const duplicateSongs = targetStats.filter(stats => stats.count > 1);

            // 6. è®¡ç®—ç»Ÿè®¡æ•°æ®
            const totalSongs = targetSongs.length;
            const uniqueCount = uniqueSongs.length;
            const duplicateCount = duplicateSongs.length;
            const duplicateRate = targetStats.length > 0 ? (duplicateCount / targetStats.length * 100).toFixed(2) : 0;

            return {
                songsToAnalyze: targetSongs,
                allSongs: targetStats,
                uniqueSongs: uniqueSongs,
                duplicateSongs: duplicateSongs,
                stats: {
                    totalSongs: totalSongs,
                    uniqueCount: uniqueCount,
                    duplicateCount: duplicateCount,
                    duplicateRate: duplicateRate,
                    filterTotal: filteredSongs.length
                }
            };
        }

        // ================= æ ¸å¿ƒåˆ†æå…¥å£ =================
        function runAnalysis(keyword) {
            try {
                const progressMsg = document.getElementById('progress-msg');
                const inputBvid = extractBvidFromLink(keyword);
                progressMsg.textContent = `ğŸ“Š æ­£åœ¨åˆ†æBVå·ã€Œ${inputBvid || keyword}ã€çš„é‡å¤æƒ…å†µï¼ˆæ¥æºï¼š${activeSource === 'all' ? 'å…¨éƒ¨' : FILE_TO_ALIAS[activeSource.replace('.js', '')] || activeSource}ï¼‰...`;

                // æ‰§è¡Œé‡å¤åˆ†æ
                const analysis = analyzeDuplicateSongs(keyword);
                console.log('ğŸ“ˆ åˆ†æç»“æœï¼š', analysis);

                // ä¿å­˜æœ€ç»ˆç»“æœ
                currentAnalysisResult = analysis;

                // æ¸²æŸ“ç»“æœ
                renderResult();

            } catch (err) {
                console.error('âŒ åˆ†æå‡ºé”™ï¼š', err);
                document.getElementById('progress-msg').style.display = 'none';
                document.getElementById('error-msg').style.display = 'block';
                document.getElementById('error-msg').textContent = `âŒ åˆ†æå¤±è´¥ï¼š${err.message}`;
            }
        }

        // ================= æ¸²æŸ“åˆ†æç»“æœ =================
        function renderResult() {
            if (!currentAnalysisResult) return;

            const stats = currentAnalysisResult.stats;

            // éšè—åŠ è½½/é”™è¯¯æç¤º
            document.getElementById('progress-msg').style.display = 'none';
            document.getElementById('error-msg').style.display = 'none';

            // æ˜¾ç¤ºç»Ÿè®¡å¡ç‰‡
            document.getElementById('stats-card').style.display = 'flex';
            document.getElementById('total-songs').textContent = stats.totalSongs;
            document.getElementById('unique-count').textContent = stats.uniqueCount;
            document.getElementById('duplicate-count').textContent = stats.duplicateCount;
            document.getElementById('duplicate-rate').textContent = `${stats.duplicateRate}%`;
            document.getElementById('filter-total').textContent = stats.filterTotal;

            // æ˜¾ç¤ºæ ‡ç­¾é¡µ
            document.getElementById('result-tabs').style.display = 'flex';

            // æ¸²æŸ“æ‰€æœ‰åˆ—è¡¨
            renderAllList();
            renderUniqueList();
            renderDuplicateList();

            // é»˜è®¤æ˜¾ç¤ºå…¨éƒ¨åˆ—è¡¨
            switchTab('all');
        }

        // ================= æŠ˜å /å±•å¼€åŠŸèƒ½ =================
        function setupCollapseExpand(itemEl, contentEl) {
            const titleEl = itemEl.querySelector('.item-title');
            const expandBtn = titleEl.querySelector('.expand-btn');
            
            titleEl.addEventListener('click', () => {
                contentEl.classList.toggle('expanded');
                expandBtn.textContent = contentEl.classList.contains('expanded') ? 'â–¼' : 'â–¶';
            });
            
            // åˆå§‹çŠ¶æ€ï¼šæŠ˜å 
            expandBtn.textContent = 'â–¶';
        }

        // æ¸²æŸ“å…¨éƒ¨æ­Œæ›²åˆ—è¡¨ï¼ˆå¸¦æŠ˜å å±•å¼€ï¼‰
        function renderAllList() {
            const listEl = document.getElementById('all-list');
            listEl.innerHTML = '';

            if (!currentAnalysisResult || currentAnalysisResult.allSongs.length === 0) {
                listEl.innerHTML = '<li class="result-item"><div class="item-title">æš‚æ— åˆ†ææ•°æ®</div></li>';
                return;
            }

            currentAnalysisResult.allSongs.forEach((item, idx) => {
                const li = document.createElement('li');
                li.className = `result-item ${item.count === 1 ? 'unique' : 'duplicate'}`;
                
                // æ ‡é¢˜æ ï¼ˆå¸¦å±•å¼€æŒ‰é’®ï¼‰
                const titleTag = item.count === 1 
                    ? '<span class="unique-tag">æœªé‡å¤</span>' 
                    : `<span class="duplicate-tag">é‡å¤${item.duplicateTimes}æ¬¡</span>`;

                li.innerHTML = `
                    <div class="item-title">
                        <span>${idx+1}. ${item.originalTitle} ${titleTag}</span>
                        <button class="expand-btn">â–¶</button>
                    </div>
                    <div class="item-meta collapsible-content">
                        <div>ğŸ‘¤ æ­Œæ‰‹ï¼š${item.originalArtist || 'æœªçŸ¥'}</div>
                        <div>ğŸ“Š ç»Ÿè®¡ï¼šå…±å‡ºç° ${item.count} æ¬¡ | é‡å¤ ${item.duplicateTimes} æ¬¡ | è·¨ ${item.sources.length} ä¸ªæ¥æº | é‡å¤ ${item.duplicateSessions} åœºæ¬¡</div>
                        
                        <div class="tag-list">
                            <span class="filter-label">ğŸ“ æ¥æºï¼š</span>
                            ${item.sources.map(source => `<span class="source-tag">${FILE_TO_ALIAS[source.replace('.js', '')] || source}</span>`).join('')}
                        </div>
                        
                        <div class="tag-list">
                            <span class="filter-label">ğŸ“º BVå·ï¼š</span>
                            ${item.bvids.filter(bvid => bvid !== 'æœªçŸ¥').map(bvid => `<span class="tag-item">${bvid}</span>`).join('')}
                        </div>
                        
                        <div class="song-details">
                            ${item.songs.map((song, sIdx) => `
                                <div class="song-item">
                                    <div>ğŸµ ${song.title}</div>
                                    <div>ğŸ‘¤ æ­Œæ‰‹ï¼š${song.artist || 'æœªçŸ¥'}</div>
                                    <div>ğŸ“ åˆé›†ï¼š${song.collection || 'æœªçŸ¥'}</div>
                                    <div>ğŸ”— <a href="${song.link}" target="_blank" style="color:#00a1d6;">ç›´è¾¾Bç«™</a></div>
                                    <div>ğŸ“º BVå·ï¼š${song.bvid || 'æœªçŸ¥'}</div>
                                </div>
                            `).join('')}
                        </div>
                        
                        <button class="copy-btn" style="margin-top:8px; padding:4px 8px; background:#6f42c1; color:white; border:none; border-radius:4px; cursor:pointer;" data-title="${item.originalTitle}">ğŸ“‹ å¤åˆ¶æ­Œå</button>
                    </div>
                `;

                // ç»‘å®šå¤åˆ¶äº‹ä»¶
                const copyBtn = li.querySelector('.copy-btn');
                copyBtn.addEventListener('click', () => {
                    copyToClipboard(item.originalTitle);
                });

                // è®¾ç½®æŠ˜å å±•å¼€
                const contentEl = li.querySelector('.collapsible-content');
                setupCollapseExpand(li, contentEl);

                listEl.appendChild(li);
            });
        }

        // æ¸²æŸ“æœªé‡å¤æ­Œæ›²åˆ—è¡¨ï¼ˆå¸¦æŠ˜å å±•å¼€ï¼‰
        function renderUniqueList() {
            const listEl = document.getElementById('unique-list');
            listEl.innerHTML = '';

            const uniqueSongs = currentAnalysisResult?.uniqueSongs || [];
            if (uniqueSongs.length === 0) {
                listEl.innerHTML = '<li class="result-item"><div class="item-title">æš‚æ— æœªé‡å¤æ­Œæ›²</div></li>';
                return;
            }

            uniqueSongs.forEach((item, idx) => {
                const li = document.createElement('li');
                li.className = 'result-item unique';
                
                li.innerHTML = `
                    <div class="item-title">
                        <span>${idx+1}. ${item.originalTitle} <span class="unique-tag">æœªé‡å¤</span></span>
                        <button class="expand-btn">â–¶</button>
                    </div>
                    <div class="item-meta collapsible-content">
                        <div>ğŸ‘¤ æ­Œæ‰‹ï¼š${item.originalArtist || 'æœªçŸ¥'}</div>
                        <div style="color: #28a745; margin-top: 8px;">âœ… ä»…å‡ºç°1æ¬¡ï¼ˆæ— é‡å¤ï¼‰</div>
                        
                        <div class="tag-list">
                            <span class="filter-label">ğŸ“ æ¥æºï¼š</span>
                            ${item.sources.map(source => `<span class="source-tag">${FILE_TO_ALIAS[source.replace('.js', '')] || source}</span>`).join('')}
                        </div>
                        
                        <div class="tag-list">
                            <span class="filter-label">ğŸ“º BVå·ï¼š</span>
                            ${item.bvids.filter(bvid => bvid !== 'æœªçŸ¥').map(bvid => `<span class="tag-item">${bvid}</span>`).join('')}
                        </div>
                        
                        <div class="song-details">
                            ${item.songs.map((song, sIdx) => `
                                <div class="song-item">
                                    <div>ğŸµ ${song.title}</div>
                                    <div>ğŸ‘¤ æ­Œæ‰‹ï¼š${song.artist || 'æœªçŸ¥'}</div>
                                    <div>ğŸ“ åˆé›†ï¼š${song.collection || 'æœªçŸ¥'}</div>
                                    <div>ğŸ”— <a href="${song.link}" target="_blank" style="color:#00a1d6;">ç›´è¾¾Bç«™</a></div>
                                    <div>ğŸ“º BVå·ï¼š${song.bvid || 'æœªçŸ¥'}</div>
                                </div>
                            `).join('')}
                        </div>
                        
                        <button class="copy-btn" style="margin-top:8px; padding:4px 8px; background:#6f42c1; color:white; border:none; border-radius:4px; cursor:pointer;" data-title="${item.originalTitle}">ğŸ“‹ å¤åˆ¶æ­Œå</button>
                    </div>
                `;

                // ç»‘å®šå¤åˆ¶äº‹ä»¶
                const copyBtn = li.querySelector('.copy-btn');
                copyBtn.addEventListener('click', () => {
                    copyToClipboard(item.originalTitle);
                });

                // è®¾ç½®æŠ˜å å±•å¼€
                const contentEl = li.querySelector('.collapsible-content');
                setupCollapseExpand(li, contentEl);

                listEl.appendChild(li);
            });
        }

        // æ¸²æŸ“é‡å¤æ­Œæ›²åˆ—è¡¨ï¼ˆå¸¦æŠ˜å å±•å¼€ï¼‰
        function renderDuplicateList() {
            const listEl = document.getElementById('duplicate-list');
            listEl.innerHTML = '';

            const duplicateSongs = currentAnalysisResult?.duplicateSongs || [];
            if (duplicateSongs.length === 0) {
                listEl.innerHTML = '<li class="result-item"><div class="item-title">æš‚æ— é‡å¤æ­Œæ›²</div></li>';
                return;
            }

            duplicateSongs.forEach((item, idx) => {
                const li = document.createElement('li');
                li.className = 'result-item duplicate';

                li.innerHTML = `
                    <div class="item-title">
                        <span>${idx+1}. ${item.originalTitle} <span class="duplicate-tag">é‡å¤${item.duplicateTimes}æ¬¡</span></span>
                        <button class="expand-btn">â–¶</button>
                    </div>
                    <div class="item-meta collapsible-content">
                        <div>ğŸ‘¤ æ­Œæ‰‹ï¼š${item.originalArtist || 'æœªçŸ¥'}</div>
                        <div>ğŸ“Š ç»Ÿè®¡ï¼šå…±å‡ºç° ${item.count} æ¬¡ | è·¨ ${item.sources.length} ä¸ªæ¥æº | é‡å¤ ${item.duplicateSessions} åœºæ¬¡</div>
                        
                        <div class="tag-list">
                            <span class="filter-label">ğŸ“ æ¥æºï¼š</span>
                            ${item.sources.map(source => `<span class="source-tag">${FILE_TO_ALIAS[source.replace('.js', '')] || source}</span>`).join('')}
                        </div>
                        
                        <div class="tag-list">
                            <span class="filter-label">ğŸ“º BVå·ï¼š</span>
                            ${item.bvids.filter(bvid => bvid !== 'æœªçŸ¥').map(bvid => `<span class="tag-item">${bvid}</span>`).join('')}
                        </div>
                        
                        <div class="song-details">
                            ${item.songs.map((song, sIdx) => `
                                <div class="song-item">
                                    <div>ğŸµ ${song.title}</div>
                                    <div>ğŸ‘¤ æ­Œæ‰‹ï¼š${song.artist || 'æœªçŸ¥'}</div>
                                    <div>ğŸ“ åˆé›†ï¼š${song.collection || 'æœªçŸ¥'}</div>
                                    <div>ğŸ”— <a href="${song.link}" target="_blank" style="color:#00a1d6;">ç›´è¾¾Bç«™</a></div>
                                    <div>ğŸ“º BVå·ï¼š${song.bvid || 'æœªçŸ¥'}</div>
                                </div>
                            `).join('')}
                        </div>
                        
                        <button class="copy-btn" style="margin-top:8px; padding:4px 8px; background:#6f42c1; color:white; border:none; border-radius:4px; cursor:pointer;" data-title="${item.originalTitle}">ğŸ“‹ å¤åˆ¶æ­Œå</button>
                    </div>
                `;

                // ç»‘å®šå¤åˆ¶äº‹ä»¶
                const copyBtn = li.querySelector('.copy-btn');
                copyBtn.addEventListener('click', () => {
                    copyToClipboard(item.originalTitle);
                });

                // è®¾ç½®æŠ˜å å±•å¼€
                const contentEl = li.querySelector('.collapsible-content');
                setupCollapseExpand(li, contentEl);

                listEl.appendChild(li);
            });
        }

        // ================= æ ‡ç­¾é¡µåˆ‡æ¢ =================
        function switchTab(tabName) {
            // åˆ‡æ¢æŒ‰é’®æ ·å¼
            const tabBtns = document.querySelectorAll('.tab-btn');
            tabBtns.forEach(btn => {
                if (btn.dataset.tab === tabName) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });

            // åˆ‡æ¢åˆ—è¡¨æ˜¾ç¤º
            document.getElementById('all-list').style.display = tabName === 'all' ? 'block' : 'none';
            document.getElementById('unique-list').style.display = tabName === 'unique' ? 'block' : 'none';
            document.getElementById('duplicate-list').style.display = tabName === 'duplicate' ? 'block' : 'none';
        }

        // ================= åˆå§‹åŒ– =================
        function init() {
            // åŠ è½½æ­Œåº“æ•°æ®
            loadSiteSongs();

            // ç»‘å®šåˆ†ææŒ‰é’®äº‹ä»¶
            const analyzeBtn = document.getElementById('analyze-btn');
            const keywordInput = document.getElementById('keyword-input');
            analyzeBtn.disabled = true;

            analyzeBtn.addEventListener('click', () => {
                const keyword = keywordInput.value;
                console.log('ğŸ‘¤ ç”¨æˆ·è¾“å…¥ï¼š', keyword);
                // é‡ç½®ç»“æœ
                document.getElementById('stats-card').style.display = 'none';
                document.getElementById('result-tabs').style.display = 'none';
                document.querySelectorAll('.result-list').forEach(list => list.style.display = 'none');
                document.getElementById('error-msg').style.display = 'none';
                document.getElementById('progress-msg').style.display = 'block';
                // å¼€å§‹åˆ†æ
                runAnalysis(keyword);
            });

            // å›è½¦è§¦å‘åˆ†æ
            keywordInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !analyzeBtn.disabled) {
                    analyzeBtn.click();
                }
            });

            // ç»‘å®šæ ‡ç­¾é¡µåˆ‡æ¢äº‹ä»¶
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    switchTab(btn.dataset.tab);
                });
            });
        }

        // å¯åŠ¨
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
