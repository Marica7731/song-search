<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ­Œæ›²æŸ¥è¯¢ç«™ - Bç«™åˆ†Pç›´è¾¾</title>
    <style>
        /* æ ·å¼ä¸å˜ï¼Œçœç•¥ */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "PingFang SC", "Microsoft YaHei", sans-serif; 
            max-width: 1200px; margin: 0 auto; padding: 30px 20px; 
            background: linear-gradient(135deg, #f5f7fa 0%, #e4e8ec 100%); min-height: 100vh;
        }
        h1 { text-align: center; color: #2c3e50; margin-bottom: 10px; font-size: 28px; font-weight: 700; }
        .sub-header { text-align: center; color: #6c757d; margin-bottom: 30px; font-size: 14px; }
        .nav-link { color: #00a1d6; text-decoration: none; font-weight: 600; }
        .filter-search-container { display: flex; flex-direction: column; gap: 18px; margin-bottom: 25px; }
        .filter-bar { display: flex; gap: 10px; flex-wrap: wrap; padding: 15px 20px; background: white; border-radius: 12px; align-items: center; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .filter-label { font-size: 14px; color: #495057; font-weight: 600; white-space: nowrap; }
        .filter-btn { padding: 7px 16px; border: 1px solid #e9ecef; border-radius: 20px; background: #f8f9fa; cursor: pointer; font-size: 14px; font-weight: 500; color: #495057; transition: all 0.2s ease; }
        .filter-btn:hover { border-color: #00a1d6; color: #00a1d6; background: #f0f9ff; }
        .filter-btn.active { background: linear-gradient(135deg, #00a1d6 0%, #00c6ff 100%); color: white; border-color: transparent; }
        .filter-btn.missing-artist { border-color: #dc3545; color: #dc3545; }
        .filter-btn.clear { margin-left: auto; background: linear-gradient(135deg, #6c757d 0%, #adb5bd 100%); color: white; }
        .search-container { display: flex; gap: 12px; flex-wrap: wrap; }
        #search-input { flex: 1; min-width: 250px; padding: 16px 20px; font-size: 16px; border: 2px solid #e9ecef; border-radius: 12px; outline: none; background: white; }
        #search-btn { padding: 0 32px; background: linear-gradient(135deg, #00a1d6 0%, #00c6ff 100%); color: white; border: none; border-radius: 12px; font-size: 16px; font-weight: 600; cursor: pointer; }
        .stats-container { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .stats-msg { font-size: 13px; color: #6c757d; font-weight: 500; }
        .copy-all-btn { padding: 6px 12px; background: linear-gradient(135deg, #6f42c1 0%, #8a6edb 100%); color: white; border: none; border-radius: 8px; font-size: 12px; font-weight: 600; cursor: pointer; }
        .copy-all-btn:disabled { background: #adb5bd; cursor: not-allowed; }
        .progress-msg { text-align: center; color: #495057; padding: 40px 20px; font-size: 16px; font-weight: 500; }
        .empty-msg { text-align: center; color: #6c757d; padding: 60px 20px; font-size: 16px; display: none; font-weight: 500; }
        #song-list { list-style: none; padding: 0; margin-bottom: 35px; }
        .song-item { padding: 20px 25px; margin-bottom: 12px; background: white; border-radius: 12px; display: flex; justify-content: space-between; align-items: center; gap: 15px; flex-wrap: wrap; box-shadow: 0 2px 8px rgba(0,0,0,0.04); }
        .song-item.missing-artist { border: 2px solid #dc3545; background: linear-gradient(135deg, #fff5f5 0%, #ffffff 100%); }
        .copy-wrapper { position: relative; display: inline-block; }
        .song-title { font-weight: 700; font-size: 17px; color: #2c3e50; padding-right: 20px; }
        .song-artist-inline { font-size: 14px; color: #6c757d; padding-right: 20px; }
        .artist-tag { font-size: 11px; color: #c0c4cc; background: #f5f7fa; padding: 1px 4px; border-radius: 3px; margin-right: 6px; }
        .collection-text { font-size: 14px; color: #6c757d; padding-right: 20px; }
        .copy-btn { position: absolute; top: 0; right: 0; background: transparent; border: none; color: #c0c4cc; font-size: 10px; cursor: pointer; }
        .copy-btn:hover { color: #00a1d6; transform: scale(1.2); }
        .song-source { font-size: 12px; color: #adb5bd; margin-top: 6px; font-weight: 500; }
        .song-actions { display: flex; gap: 8px; align-items: center; }
        .song-link a { padding: 8px 25px 8px 18px; background: linear-gradient(135deg, #00a1d6 0%, #00c6ff 100%); color: white; text-decoration: none; border-radius: 8px; font-size: 13px; font-weight: 600; }
        .edit-link { width: 24px; height: 24px; border-radius: 50%; background: linear-gradient(135deg, #ff7a18 0%, #ff9f43 100%); color: white; text-decoration: none; font-size: 12px; font-weight: 600; display: flex; align-items: center; justify-content: center; }
        .copy-toast { position: fixed; bottom: 30px; right: 30px; padding: 10px 20px; background: rgba(0, 0, 0, 0.75); color: white; border-radius: 20px; font-size: 14px; font-weight: 500; z-index: 9999; opacity: 0; transform: translateY(10px); transition: all 0.3s ease; pointer-events: none; }
        .copy-toast.show { opacity: 1; transform: translateY(0); }
        .pagination { display: flex; justify-content: center; align-items: center; gap: 8px; margin-top: 30px; padding: 20px; }
        .page-btn { padding: 10px 16px; border: 1px solid #e9ecef; border-radius: 8px; background: white; cursor: pointer; font-size: 14px; color: #495057; }
        .page-btn:hover:not(.disabled):not(.active) { background: #f8f9fa; border-color: #00a1d6; color: #00a1d6; }
        .page-btn.active { background: linear-gradient(135deg, #00a1d6 0%, #00c6ff 100%); color: white; border-color: transparent; }
        .page-btn.disabled { cursor: not-allowed; color: #adb5bd; background: #f8f9fa; }
    </style>
</head>
<body>
    <h1>ğŸµ æˆ‘çš„å·²åˆ‡æ­Œæ›²æŸ¥è¯¢ç«™</h1>
    <div class="sub-header">
        ç³»ç»ŸåŒ–ç®¡ç†ä½ çš„éŸ³ä¹æ”¶è— | <a href="stats.html" class="nav-link">æŸ¥çœ‹æ¼”å”±è€…ç»Ÿè®¡ä¸æ’è¡Œ</a>
    </div>

    <div class="filter-search-container">
        <div class="filter-bar" id="filter-bar">
            <span class="filter-label">ğŸ” æŒ‰æ­Œæ‰‹/æ¥æºç­›é€‰ï¼š</span>
            <button class="filter-btn active" id="btn-all">å…¨éƒ¨</button>
            <span style="width:10px;"></span>
            <span style="color:#adb5bd;font-size:13px;">(åŠ è½½ä¸­...)</span>
        </div>
        <div class="search-container">
            <input type="text" id="search-input" placeholder="è¾“å…¥å…³é”®è¯æœç´¢..." disabled>
            <button id="search-btn" disabled>ğŸ” æœç´¢</button>
        </div>
    </div>

    <div class="stats-container">
        <div class="stats-msg" id="stats-msg">å‡†å¤‡å°±ç»ª...</div>
        <button class="copy-all-btn" id="copy-all-btn" disabled>ğŸ“‹ å¤åˆ¶å…¨éƒ¨æœç´¢ç»“æœ</button>
    </div>

    <div class="progress-msg" id="progress-msg">ğŸ“¥ æ­£åœ¨åˆå§‹åŒ–...</div>
    <div class="empty-msg" id="empty-msg">âŒ æœªæ‰¾åˆ°åŒ¹é…çš„æ­Œæ›²</div>
    <ul id="song-list"></ul>
    <div class="pagination" id="pagination"></div>
    <div class="copy-toast" id="copy-toast">copy ok!</div>

    <script src="common.js"></script>
    <script>
        // é¡µé¢ç§æœ‰å˜é‡
        window.SONG_DATA = [];
        let originalData = [];
        let filteredBySource = [];
        let filteredBySearch = [];
        const PAGE_SIZE = 50;
        let currentPage = 1;
        let activeSource = 'all';
        const fileNames = [];
        let FILE_TO_ALIAS = {};
        
        // çŠ¶æ€é”
        let isDataReady = false;

        function showCopyToast() {
            const toast = document.getElementById('copy-toast');
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 1500);
        }
        async function copyToClipboard(text) {
            try { await navigator.clipboard.writeText(text); showCopyToast(); } 
            catch (err) { console.error('å¤åˆ¶å¤±è´¥:', err); alert('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶'); }
        }

        function extractBvid(link) {
            if (!link) return null;
            const match = link.match(/BV[a-zA-Z0-9]+/);
            return match ? match[0] : null;
        }

        // ğŸ”§ ä¼˜åŒ–ï¼šç›´æ¥ç”¨ DOM æ“ä½œç”ŸæˆæŒ‰é’®ï¼Œä¸åšå¤æ‚é‡ç»˜
        function generateFilterButtons() {
            const filterBar = document.getElementById('filter-bar');
            filterBar.innerHTML = '<span class="filter-label">ğŸ” æŒ‰æ­Œæ‰‹/æ¥æºç­›é€‰ï¼š</span>';

            const allBtn = document.createElement('button');
            allBtn.className = `filter-btn ${activeSource === 'all' ? 'active' : ''}`;
            allBtn.textContent = 'å…¨éƒ¨';
            allBtn.onclick = () => switchSource('all');
            filterBar.appendChild(allBtn);

            const spacer = document.createElement('span');
            spacer.style.width = '10px';
            filterBar.appendChild(spacer);

            fileNames.forEach(fileName => {
                const fileBase = fileName.replace('.js', '');
                const btnText = FILE_TO_ALIAS[fileBase] || fileBase;
                const btn = document.createElement('button');
                btn.className = `filter-btn ${activeSource === fileName ? 'active' : ''}`;
                btn.textContent = btnText;
                btn.onclick = () => switchSource(fileName);
                filterBar.appendChild(btn);
            });

            const missingBtn = document.createElement('button');
            missingBtn.className = `filter-btn missing-artist ${activeSource === 'missing-artist' ? 'active' : ''}`;
            missingBtn.textContent = 'âš ï¸ ç¼ºå¤±æ­Œæ‰‹';
            missingBtn.onclick = () => switchSource('missing-artist');
            filterBar.appendChild(missingBtn);

            const clearBtn = document.createElement('button');
            clearBtn.className = 'filter-btn clear';
            clearBtn.textContent = 'æ¸…ç©ºç­›é€‰';
            clearBtn.onclick = () => {
                activeSource = 'all';
                document.getElementById('search-input').value = '';
                if(isDataReady) updateFilterAndSearch();
            };
            filterBar.appendChild(clearBtn);
        }

        function switchSource(source) {
            if (!isDataReady) return;
            activeSource = source;
            currentPage = 1;
            generateFilterButtons();
            updateFilterAndSearch();
        }

        // ğŸ”§ ä¼˜åŒ–ï¼šç­›é€‰é€»è¾‘ä¿æŒè½»é‡
        function updateFilterAndSearch() {
            if (!isDataReady) return;

            // 1. æ¥æºç­›é€‰
            if (activeSource === 'all') {
                filteredBySource = originalData; // ç›´æ¥å¼•ç”¨ï¼Œä¸å¤åˆ¶
            } else if (activeSource === 'missing-artist') {
                filteredBySource = originalData.filter(item => !isValidArtist(item.artist));
            } else {
                filteredBySource = originalData.filter(item => item.source === activeSource);
            }

            // 2. æœç´¢ç­›é€‰
            const keyword = document.getElementById('search-input').value.trim().toLowerCase();
            if (keyword) {
                filteredBySearch = filteredBySource.filter(item => {
                    // ç®€å•çš„åŒ…å«åˆ¤æ–­ï¼Œä¸åšå¤æ‚æ­£åˆ™
                    const t = (item.title || '').toLowerCase();
                    const a = (item.artist || '').toLowerCase();
                    const c = (item.collection || '').toLowerCase();
                    return t.includes(keyword) || a.includes(keyword) || c.includes(keyword);
                });
            } else {
                filteredBySearch = filteredBySource;
            }

            // 3. æ›´æ–°ç»Ÿè®¡ (ä½¿ç”¨è¶…å¿«çš„ Set ç®—æ³•)
            const statsMsg = document.getElementById('stats-msg');
            // æ³¨æ„ï¼šä¸ºäº†æè‡´é€Ÿåº¦ï¼Œè¿™é‡Œå¯ä»¥åªåœ¨ç¬¬ä¸€æ¬¡æˆ–æ•°æ®å˜åŒ–æ—¶ç®— totalUnique
            // è¿™é‡Œä¸ºäº†ç®€å•ï¼Œæ¯æ¬¡éƒ½ç®—ï¼Œä½†å› ä¸ºæ˜¯ O(n) æ‰€ä»¥ä¾ç„¶å¾ˆå¿«
            const uniqueSearch = getUniqueSongCount(filteredBySearch);
            
            statsMsg.textContent = `æ€»æ­Œæ›²æ•°ï¼š${originalData.length} | ç­›é€‰åï¼š${filteredBySource.length} | æœç´¢ç»“æœï¼š${filteredBySearch.length}ï¼ˆå»é‡ï¼š${uniqueSearch}ï¼‰`;
            
            document.getElementById('copy-all-btn').disabled = filteredBySearch.length === 0;
            renderSongList(filteredBySearch);
        }

        function renderSongList(data) {
            const listEl = document.getElementById('song-list');
            listEl.innerHTML = ''; // æ¸…ç©º
            const start = (currentPage - 1) * PAGE_SIZE;
            const pageData = data.slice(start, start + PAGE_SIZE);

            if (pageData.length === 0) {
                document.getElementById('empty-msg').style.display = 'block';
            } else {
                document.getElementById('empty-msg').style.display = 'none';
                // ä½¿ç”¨ DocumentFragment å‡å°‘é‡ç»˜
                const frag = document.createDocumentFragment();
                pageData.forEach(item => {
                    const sourceAlias = FILE_TO_ALIAS[item.source?.replace('.js', '')] || item.source || 'æœªçŸ¥';
                    const bvid = extractBvid(item.link);
                    const hasValidArtist = isValidArtist(item.artist);

                    const li = document.createElement('li');
                    li.className = `song-item ${hasValidArtist ? '' : 'missing-artist'}`;
                    // ç®€åŒ– innerHTML æ‹¼æ¥
                    li.innerHTML = `
                        <div class="song-info">
                            <div style="display:flex;align-items:center;gap:22px;flex-wrap:wrap;margin-bottom:8px;">
                                <div class="copy-wrapper">
                                    <div class="song-title">${item.title || 'æœªçŸ¥æ­Œæ›²'}</div>
                                    <button class="copy-btn" data-type="title">ğŸ“‹</button>
                                </div>
                                ${hasValidArtist ? `
                                <div class="copy-wrapper">
                                    <span class="song-artist-inline"><span class="artist-tag">æ­Œæ‰‹</span>${item.artist}</span>
                                    <button class="copy-btn" data-type="artist">ğŸ“‹</button>
                                </div>` : ''}
                            </div>
                            <div class="song-source">æ¥æºï¼š${sourceAlias}</div>
                        </div>
                        <div class="song-actions">
                            ${item.link ? `<a href="${item.link}" target="_blank" style="padding:8px 18px;background:#00a1d6;color:white;text-decoration:none;border-radius:8px;font-size:13px;">ç›´è¾¾Bç«™</a>` : ''}
                        </div>
                    `;
                    
                    // ç»‘å®šäº‹ä»¶
                    const titleBtn = li.querySelector('[data-type="title"]');
                    if(titleBtn) titleBtn.onclick = () => copyToClipboard(hasValidArtist ? `${item.title} - ${item.artist}` : item.title);
                    
                    frag.appendChild(li);
                });
                listEl.appendChild(frag);
            }
            renderPagination(data.length);
        }

        function renderPagination(total) {
            const el = document.getElementById('pagination');
            el.innerHTML = '';
            const totalPages = Math.ceil(total / PAGE_SIZE);
            if (totalPages <= 1) return;

            const addBtn = (text, cls, onClick) => {
                const btn = document.createElement('button');
                btn.className = `page-btn ${cls || ''}`;
                btn.textContent = text;
                btn.onclick = onClick;
                el.appendChild(btn);
            };

            addBtn('ä¸Šä¸€é¡µ', currentPage === 1 ? 'disabled' : '', () => { if(currentPage>1) { currentPage--; renderSongList(filteredBySearch); }});
            for(let i=Math.max(1, currentPage-2); i<=Math.min(totalPages, currentPage+2); i++) {
                addBtn(i, i === currentPage ? 'active' : '', () => { currentPage = i; renderSongList(filteredBySearch); });
            }
            addBtn('ä¸‹ä¸€é¡µ', currentPage === totalPages ? 'disabled' : '', () => { if(currentPage<totalPages) { currentPage++; renderSongList(filteredBySearch); }});
        }

        // ğŸ”§ ä¼˜åŒ–å¯åŠ¨æµç¨‹ï¼šå…ˆæ˜¾ç¤ºUIï¼Œå†é™é»˜åŠ è½½
        async function bootstrap() {
            const progressMsg = document.getElementById('progress-msg');
            try {
                // 1. å…ˆåŠ è½½ index.json (å¾ˆå¿«)
                progressMsg.textContent = 'ğŸ“¥ è¯»å–é…ç½®...';
                const res = await fetch('data/index.json');
                const config = await res.json();
                fileNames.push(...(config.files || []));
                FILE_TO_ALIAS = config.fileToAlias || {};

                // 2. ç«‹å³ç”Ÿæˆç­›é€‰æŒ‰é’® (è®©ç”¨æˆ·å…ˆçœ‹åˆ°ç•Œé¢)
                generateFilterButtons();
                progressMsg.textContent = 'ğŸ“¥ åŠ è½½æ­Œåº“æ•°æ®...';

                // 3. å¹¶è¡ŒåŠ è½½ JS
                await loadScriptsParallel(fileNames);

                // 4. æ•°æ®å‡†å¤‡å®Œæ¯•
                isDataReady = true;
                filteredBySource = originalData;
                filteredBySearch = originalData;

                // 5. è§£é” UI
                document.getElementById('search-input').disabled = false;
                document.getElementById('search-btn').disabled = false;
                progressMsg.style.display = 'none';

                // 6. åªç®—ä¸€æ¬¡æ€»å»é‡æ•°æ˜¾ç¤º
                const totalUnique = getUniqueSongCount(originalData);
                document.getElementById('stats-msg').textContent = `æ€»æ­Œæ›²æ•°ï¼š${originalData.length}ï¼ˆå»é‡ï¼š${totalUnique}ï¼‰`;

                // 7. æ¸²æŸ“åˆ—è¡¨
                renderSongList(originalData);

                // ç»‘å®šäº‹ä»¶
                document.getElementById('search-btn').addEventListener('click', () => { currentPage=1; updateFilterAndSearch(); });
                document.getElementById('search-input').addEventListener('keydown', (e) => { if(e.key==='Enter') { currentPage=1; updateFilterAndSearch(); }});
                document.getElementById('copy-all-btn').addEventListener('click', () => {
                    const text = filteredBySearch.map(item => `${item.title} - ${item.artist || 'æœªçŸ¥'}ï¼ˆ${item.link}ï¼‰`).join('\n');
                    if(text) copyToClipboard(text);
                });

            } catch (err) {
                console.error(err);
                progressMsg.textContent = `âŒ åŠ è½½å¤±è´¥: ${err.message}`;
            }
        }

        function loadScriptsParallel(fileList) {
            const progressMsg = document.getElementById('progress-msg');
            let loadedCount = 0;
            
            // ğŸ”§ ä¼˜åŒ–ï¼šä¸ä½¿ç”¨ Promise.all ç­‰å…¨éƒ¨ï¼Œè€Œæ˜¯æ¥ä¸€ä¸ªå¤„ç†ä¸€ä¸ª
            // ä½†ä¸ºäº†ä¿æŒæ•°æ®ä¸€è‡´æ€§ï¼Œæˆ‘ä»¬è¿˜æ˜¯ç­‰å…¨éƒ¨ï¼Œä½†å†…éƒ¨å¤„ç†åŠ å¿«
            return new Promise((resolve) => {
                let resolvedCount = 0;
                const total = fileList.length;
                
                if (total === 0) {
                    resolve();
                    return;
                }

                fileList.forEach(fileName => {
                    const script = document.createElement('script');
                    script.src = `data/${fileName}`;
                    script.onload = () => {
                        // å¿«é€Ÿå¤„ç†æ•°æ®
                        const newDataCount = window.SONG_DATA.length - originalData.length;
                        if (newDataCount > 0) {
                            const newData = window.SONG_DATA.slice(-newDataCount);
                            // è¿™é‡Œçš„å¾ªç¯æ˜¯å¿…é¡»çš„ï¼Œä½†å¾ˆå¿«
                            for(let i=0; i<newData.length; i++) {
                                newData[i].source = fileName;
                            }
                            // ç›´æ¥æ›¿æ¢å¼•ç”¨ï¼Œä¸è¦ [...spread] å¤åˆ¶å¤§æ•°ç»„
                            originalData = window.SONG_DATA;
                        }
                        loadedCount++;
                        progressMsg.textContent = `ğŸ“¥ åŠ è½½æ•°æ® (${loadedCount}/${total})...`;
                        
                        resolvedCount++;
                        if (resolvedCount === total) resolve();
                    };
                    script.onerror = () => {
                        resolvedCount++;
                        if (resolvedCount === total) resolve();
                    };
                    document.body.appendChild(script);
                });
            });
        }

        document.addEventListener('DOMContentLoaded', bootstrap);
    </script>
</body>
</html>
