<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ­Œæ›²æŸ¥è¯¢ç«™ - Bç«™åˆ†Pç›´è¾¾</title>
    <style>
        /* å…¨å±€æ ·å¼é‡ç½® */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; 
            max-width: 1000px; 
            margin: 0 auto; 
            padding: 20px; 
        }
        /* æ ‡é¢˜æ ·å¼ */
        h1 { text-align: center; color: #333; margin-bottom: 10px; }
        /* å¯¼èˆªæŒ‰é’® */
        .nav-btn-container { text-align: center; margin-bottom: 30px; }
        .nav-btn { 
            padding: 8px 16px; 
            background-color: #28a745; 
            color: white; 
            text-decoration: none; 
            border-radius: 4px; 
            font-size: 14px; 
            display: inline-block; 
        }
        .nav-btn:hover { background-color: #218838; }
        /* æœç´¢åŒºåŸŸï¼ˆè¾“å…¥æ¡†+æŒ‰é’®ï¼‰ */
        .search-container { 
            display: flex; 
            gap: 10px; 
            margin-bottom: 20px; 
        }
        #search-input { 
            flex: 1; 
            padding: 15px; 
            font-size: 18px; 
            border: 2px solid #ddd; 
            border-radius: 8px; 
            outline: none; 
        }
        #search-input:focus { border-color: #00a1d6; }
        #search-btn { 
            padding: 0 24px; 
            background-color: #00a1d6; 
            color: white; 
            border: none; 
            border-radius: 8px; 
            font-size: 18px; 
            cursor: pointer; 
        }
        #search-btn:hover { background-color: #008ebf; }
        /* æ­Œæ›²åˆ—è¡¨ */
        .list { list-style: none; padding: 0; }
        .item { 
            padding: 15px; 
            border-bottom: 1px solid #eee; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
        }
        .item:hover { background-color: #f9f9f9; }
        .info { flex: 1; }
        .title { font-weight: bold; font-size: 16px; color: #222; margin-bottom: 5px; }
        .meta { font-size: 14px; color: #666; }
        .link a { 
            padding: 8px 16px; 
            background-color: #00a1d6; 
            color: white; 
            text-decoration: none; 
            border-radius: 4px; 
            font-size: 14px; 
        }
        .link a:hover { background-color: #008ebf; }
        /* æç¤ºæ–‡æ¡ˆ */
        .status-msg, .empty-msg, .loading-msg { 
            text-align: center; 
            color: #999; 
            padding: 40px; 
            font-size: 16px; 
        }
        .empty-msg, .loading-msg { display: none; }
        /* åŠ è½½è¿›åº¦æç¤º */
        .progress-msg { text-align: center; color: #666; padding: 20px; font-size: 14px; }
    </style>
</head>
<body>
    <h1>ğŸµ æˆ‘çš„å·²åˆ‡æ­Œæ›²æŸ¥è¯¢ç«™</h1>
    <div class="nav-btn-container">
        <a href="converter.html" target="_blank" class="nav-btn">ğŸ”„ æ‰“å¼€æ­Œå•æ•°æ®è½¬æ¢å™¨</a>
    </div>

    <!-- æœç´¢åŒºåŸŸï¼ˆè¾“å…¥æ¡†+æŒ‰é’®ï¼‰ -->
    <div class="search-container">
        <input type="text" id="search-input" placeholder="è¾“å…¥æ­Œåã€æ­Œæ‰‹åã€åˆé›†åæˆ–UPä¸»æœç´¢...">
        <button id="search-btn">ğŸ” æœç´¢</button>
    </div>

    <!-- åŠ è½½è¿›åº¦æç¤º -->
    <div class="progress-msg" id="progress-msg">ğŸ“¥ æ­£åœ¨åŠ è½½æ­Œåº“ï¼ˆå…±12548æ¡ï¼‰ï¼Œè¯·ç¨å€™...</div>

    <!-- æ­Œæ›²åˆ—è¡¨å®¹å™¨ï¼ˆé‡æ„ç»“æ„ï¼Œé¿å…List.jsè§£æé”™è¯¯ï¼‰ -->
    <ul class="list" id="song-list">
        <li class="empty-msg" id="empty-msg">âŒ æœªæ‰¾åˆ°åŒ¹é…çš„æ­Œæ›²</li>
        <li class="loading-msg" id="loading-msg">â³ æ­£åœ¨åŠ è½½æ­Œåº“...</li>
    </ul>

    <!-- List.js CDNï¼ˆå›½å†…æºï¼Œé¿å…åŠ è½½å¤±è´¥ï¼‰ -->
    <script src="https://cdn.bootcdn.net/ajax/libs/list.js/2.3.1/list.min.js"></script>

    <script>
        // å…¨å±€æ•°æ®å®¹å™¨
        window.SONG_DATA = [];
        let songListInstance = null;
        const BATCH_SIZE = 500; // åˆ†æ‰¹åŠ è½½ï¼šæ¯æ¬¡åŠ è½½500æ¡ï¼Œé¿å…DOMå´©æºƒ

        // 1. åˆ†æ‰¹æ·»åŠ æ•°æ®åˆ°List.jsï¼ˆé€‚é…å¤§æ•°æ®é‡ï¼‰
        function batchAddData(listInstance, data) {
            const total = data.length;
            let currentIndex = 0;
            const progressMsg = document.getElementById('progress-msg');

            // åˆ†æ‰¹æ·»åŠ å‡½æ•°
            function addBatch() {
                const endIndex = Math.min(currentIndex + BATCH_SIZE, total);
                const batch = data.slice(currentIndex, endIndex);
                listInstance.add(batch);
                
                // æ›´æ–°è¿›åº¦
                progressMsg.textContent = `ğŸ“¥ æ­£åœ¨åŠ è½½æ­Œåº“ï¼ˆ${endIndex}/${total}æ¡ï¼‰...`;
                currentIndex = endIndex;

                // è¿˜æœ‰æ•°æ®æ²¡åŠ è½½å®Œï¼Œç»§ç»­åˆ†æ‰¹
                if (currentIndex < total) {
                    setTimeout(addBatch, 50); // å»¶è¿Ÿ50msï¼Œé¿å…é˜»å¡UI
                } else {
                    // åŠ è½½å®Œæˆ
                    progressMsg.style.display = 'none';
                    console.log(`âœ… æ•°æ®åŠ è½½å®Œæˆï¼Œå…±${total}æ¡`);
                }
            }

            // å¯åŠ¨åˆ†æ‰¹åŠ è½½
            addBatch();
        }

        // 2. åˆå§‹åŒ–List.jsåˆ—è¡¨æ¸²æŸ“ï¼ˆé‡æ„ï¼Œé¿å…childNodesæŠ¥é”™ï¼‰
        function initList() {
            // å…ˆæ¸…ç©ºåˆ—è¡¨å®¹å™¨çš„é»˜è®¤å†…å®¹ï¼ˆå…³é”®ï¼šè§£å†³childNodesæŠ¥é”™ï¼‰
            const songListEl = document.getElementById('song-list');
            songListEl.innerHTML = '<li class="empty-msg" id="empty-msg">âŒ æœªæ‰¾åˆ°åŒ¹é…çš„æ­Œæ›²</li>';

            const options = {
                valueNames: ['title', 'artist', 'collection', 'up', { data: ['link'] }],
                item: '<li class="item">' +
                        '<div class="info">' +
                            '<div class="title"></div>' +
                            '<div class="meta"><span class="artist"></span> / <span class="collection"></span> / UP: <span class="up"></span></div>' +
                        '</div>' +
                        '<div class="link"><a class="link-btn" target="_blank">ç›´è¾¾Bç«™</a></div>' +
                      '</li>',
                page: 50, // åˆ†é¡µï¼šæ¯é¡µæ˜¾ç¤º50æ¡ï¼Œé¿å…ä¸€æ¬¡æ€§æ¸²æŸ“å¤ªå¤šDOM
                pagination: true // å¯ç”¨åˆ†é¡µï¼Œä¼˜åŒ–å¤§æ•°æ®é‡æ¸²æŸ“
            };
            
            // é‡æ–°åˆ›å»ºList.jså®ä¾‹ï¼ˆæ ¸å¿ƒä¿®å¤ï¼šé¿å…DOMè§£æé”™è¯¯ï¼‰
            try {
                songListInstance = new List('song-list', options);
                console.log('âœ… List.jså®ä¾‹åˆ›å»ºæˆåŠŸ');

                // åˆ†æ‰¹æ·»åŠ 12548æ¡æ•°æ®ï¼ˆæ ¸å¿ƒï¼šé¿å…ä¸€æ¬¡æ€§æ¸²æŸ“å´©æºƒï¼‰
                batchAddData(songListInstance, window.SONG_DATA);

                // ç»‘å®šBç«™é“¾æ¥ç‚¹å‡»äº‹ä»¶
                songListEl.addEventListener('click', function(e) {
                    if (e.target.classList.contains('link-btn')) {
                        const item = e.target.closest('.item');
                        const values = songListInstance.get('item', item)[0].values();
                        window.open(values.link, '_blank');
                    }
                });

                // åˆå§‹åŒ–æœç´¢åŠŸèƒ½
                initSearch();

            } catch (err) {
                console.error('âŒ List.jså®ä¾‹åˆ›å»ºå¤±è´¥ï¼š', err);
                const progressMsg = document.getElementById('progress-msg');
                progressMsg.textContent = `âŒ åˆ—è¡¨åˆå§‹åŒ–å¤±è´¥ï¼š${err.message}`;
                progressMsg.style.color = '#dc3545';
            }
        }

        // 3. åˆå§‹åŒ–æœç´¢åŠŸèƒ½ï¼ˆå¼ºåŒ–ç‰ˆï¼šé€‚é…å¤§æ•°æ®é‡ï¼‰
        function initSearch() {
            const searchInput = document.getElementById('search-input');
            const searchBtn = document.getElementById('search-btn');
            const emptyMsg = document.getElementById('empty-msg');
            const songListEl = document.getElementById('song-list');

            // æ ¸å¿ƒæœç´¢è¿‡æ»¤é€»è¾‘ï¼ˆå…¼å®¹å¤§æ•°æ®é‡ï¼‰
            function handleSearch() {
                if (!songListInstance) {
                    alert('âš ï¸ æ­Œå•æ•°æ®æœªåŠ è½½å®Œæˆï¼Œè¯·ç­‰å¾…10ç§’åé‡è¯•ï¼');
                    return;
                }

                const keyword = searchInput.value.trim().toLowerCase();
                console.log('ğŸ” æœç´¢å…³é”®è¯ï¼š', keyword);

                // é‡ç½®æ‰€æœ‰ç­›é€‰
                songListInstance.reset();

                if (keyword) {
                    // è‡ªå®šä¹‰æ¨¡ç³Šè¿‡æ»¤ï¼ˆé€‚é…ä¸­æ–‡+å¤§æ•°æ®é‡ï¼‰
                    songListInstance.filter(function(item) {
                        const title = (item.values().title || '').toLowerCase();
                        const artist = (item.values().artist || '').toLowerCase();
                        const collection = (item.values().collection || '').toLowerCase();
                        const up = (item.values().up || '').toLowerCase();
                        // åŒ¹é…ä»»æ„å­—æ®µ
                        return title.includes(keyword) || artist.includes(keyword) || collection.includes(keyword) || up.includes(keyword);
                    });
                }

                // æ˜¾ç¤º/éšè—æ— ç»“æœæç¤º
                const matchCount = songListInstance.matchingItems.length;
                console.log('âœ… åŒ¹é…ç»“æœæ•°ï¼š', matchCount);
                emptyMsg.style.display = matchCount === 0 ? 'block' : 'none';

                // å¼ºåˆ¶åˆ·æ–°åˆ†é¡µï¼ˆé€‚é…å¤§æ•°æ®é‡ï¼‰
                songListInstance.page = matchCount > 50 ? 50 : matchCount;
                songListInstance.update();
            }

            // ç»‘å®šå›è½¦äº‹ä»¶ï¼ˆé˜²ä¸¢å¤±ï¼‰
            searchInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' || e.keyCode === 13) {
                    e.preventDefault();
                    handleSearch();
                    searchInput.focus();
                }
            });

            // ç»‘å®šæœç´¢æŒ‰é’®ç‚¹å‡»äº‹ä»¶
            searchBtn.addEventListener('click', function() {
                handleSearch();
                searchInput.blur();
                setTimeout(() => searchInput.focus(), 100);
            });

            // å®æ—¶è¾“å…¥æœç´¢ï¼ˆä¼˜åŒ–ï¼šåŠ é˜²æŠ–ï¼Œé¿å…é¢‘ç¹è§¦å‘ï¼‰
            let searchTimer = null;
            searchInput.addEventListener('input', function() {
                clearTimeout(searchTimer);
                searchTimer = setTimeout(handleSearch, 300); // 300msé˜²æŠ–
            });

            // åˆå§‹æ˜¾ç¤ºæ‰€æœ‰æ­Œæ›²
            setTimeout(handleSearch, 1000);
        }

        // 4. åŠ¨æ€åŠ è½½å•ä¸ªJSæ•°æ®æ–‡ä»¶
        function loadScript(url) {
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = url;
                script.onload = resolve;
                script.onerror = reject;
                document.body.appendChild(script);
            });
        }

        // 5. ä¸»æµç¨‹ï¼šåŠ è½½ç´¢å¼•â†’åŠ è½½æ•°æ®â†’åˆå§‹åŒ–åˆ—è¡¨ï¼ˆä¿®å¤ç©ºæŒ‡é’ˆï¼‰
        async function bootstrap() {
            try {
                // åŠ è½½index.jsonæ¸…å•
                const response = await fetch('data/index.json');
                if (!response.ok) throw new Error(`åŠ è½½ç´¢å¼•å¤±è´¥ï¼ˆçŠ¶æ€ç ï¼š${response.status}ï¼‰`);
                const config = await response.json();
                const files = config.files || [];

                if (files.length === 0) throw new Error('index.jsonä¸­æ— æ•°æ®æ–‡ä»¶é…ç½®');

                // æ‰¹é‡åŠ è½½æ‰€æœ‰æ•°æ®JSæ–‡ä»¶
                const loadPromises = files.map(filename => loadScript(`data/${filename}`));
                await Promise.all(loadPromises);

                console.log(`âœ… æ•°æ®æ–‡ä»¶åŠ è½½å®Œæˆï¼Œæ€»æ­Œæ›²æ•°ï¼š${window.SONG_DATA.length}`);

                // åˆå§‹åŒ–åˆ—è¡¨ï¼ˆæ ¸å¿ƒï¼šæ•°æ®åŠ è½½å®Œå†åˆå§‹åŒ–List.jsï¼‰
                initList();

            } catch (error) {
                console.error('âŒ å¯åŠ¨å¤±è´¥ï¼š', error);
                // ä¿®å¤ç©ºæŒ‡é’ˆï¼šå…ˆåˆ¤æ–­å…ƒç´ æ˜¯å¦å­˜åœ¨å†ä¿®æ”¹
                const progressMsg = document.getElementById('progress-msg');
                if (progressMsg) {
                    progressMsg.textContent = `âŒ åŠ è½½å¤±è´¥ï¼š${error.message}`;
                    progressMsg.style.color = '#dc3545';
                }
                // å…¼å®¹loading-msg
                const loadingMsg = document.getElementById('loading-msg');
                if (loadingMsg) {
                    loadingMsg.style.display = 'block';
                    loadingMsg.innerText = `âŒ åŠ è½½å¤±è´¥ï¼š${error.message}`;
                }
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆåå¯åŠ¨
        document.addEventListener('DOMContentLoaded', bootstrap);
    </script>
</body>
</html>
