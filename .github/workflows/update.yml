name: Auto Update Song List

on:
  schedule:
    - cron: '0 * * * *' # æ¯å°æ—¶æ‰§è¡Œï¼ˆå¯è°ƒæ•´ï¼Œæ¯”å¦‚0 0 * * * æ¯å¤©å‡Œæ™¨ï¼‰
  workflow_dispatch: # æ‰‹åŠ¨è§¦å‘

permissions:
  contents: write # èµ‹äºˆæäº¤ä»£ç çš„æƒé™

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - name: æ‹‰å–ä»“åº“ä»£ç 
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0 # æ‹‰å–å®Œæ•´å†å²ï¼Œé¿å…æäº¤å†²çª

      - name: é…ç½®Node.jsç¯å¢ƒ
        uses: actions/setup-node@v4
        with:
          node-version: '20' # ç”¨LTSç‰ˆæœ¬ï¼Œé¿å…å…¼å®¹æ€§é—®é¢˜
          cache: 'npm' # ç¼“å­˜npmä¾èµ–ï¼ŒåŠ é€Ÿå®‰è£…

      - name: å®‰è£…ç³»ç»Ÿä¾èµ–ï¼ˆå…³é”®ï¼šè¡¥é½Ubuntuç¼ºå¤±çš„Chromeä¾èµ–ï¼‰
        run: |
          sudo apt-get update
          sudo apt-get install -y libnss3 libatk-bridge2.0-0 libdrm-dev libxkbcommon-dev libgbm-dev libasound-dev libatspi2.0-0 libxshmfence-dev

      - name: å®‰è£…Puppeteerä¾èµ–ï¼ˆä¼˜åŒ–ï¼šæŒ‡å®šå›½å†…é•œåƒï¼‰
        run: |
          cd scripts
          # åˆå§‹åŒ–package.jsonï¼ˆé¿å…æ‰‹åŠ¨åˆ›å»ºçš„è¯­æ³•é—®é¢˜ï¼‰
          npm init -y --force
          # å›½å†…é•œåƒåŠ é€ŸChromeä¸‹è½½ï¼ˆå…³é”®ï¼é¿å…GitHubæœåŠ¡å™¨ä¸‹è½½å¤±è´¥ï¼‰
          npm config set puppeteer_download_host=https://npmmirror.com/mirrors
          # å®‰è£…Puppeteerå¹¶è‡ªåŠ¨ä¸‹è½½Chrome
          npm install puppeteer@21.0.0 --save-exact # æŒ‡å®šç¨³å®šç‰ˆæœ¬ï¼Œé¿å…ç‰ˆæœ¬å…¼å®¹é—®é¢˜

      - name: æ‰§è¡Œæ›´æ–°è„šæœ¬ï¼ˆæ•è·é”™è¯¯ï¼Œè¾“å‡ºæ—¥å¿—ï¼‰
        run: |
          cd scripts
          node update-songs.js
        env:
          # å¢åŠ ç¯å¢ƒå˜é‡ï¼Œç¡®ä¿Puppeteerä½¿ç”¨ä¸‹è½½çš„Chrome
          PUPPETEER_EXECUTABLE_PATH: ./node_modules/puppeteer/.local-chromium/linux-*/chrome-linux/chrome

      - name: æ£€æŸ¥æ˜¯å¦æœ‰æ•°æ®æ›´æ–°
        id: check_changes
        run: |
          # åˆ¤æ–­dataç›®å½•æ˜¯å¦æœ‰æ–‡ä»¶å˜åŒ–
          if git status --porcelain | grep -q 'data/'; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
          fi

      - name: æäº¤å¹¶æ¨é€æ›´æ–°ï¼ˆä»…å½“æœ‰å˜åŒ–æ—¶ï¼‰
        if: steps.check_changes.outputs.has_changes == 'true'
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "ğŸ¤– è‡ªåŠ¨æ›´æ–°æ­Œå•æ•°æ®ï¼ˆGitHub Actionsï¼‰"
          file_pattern: "data/*.js data/index.json" # åªæäº¤æ•°æ®æ–‡ä»¶
          branch: main
