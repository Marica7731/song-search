name: Auto Update Song List

on:
  schedule:
    - cron: '0 * * * *' # æ¯å°æ—¶æ‰§è¡Œï¼Œå¯è°ƒæ•´
  workflow_dispatch: # æ‰‹åŠ¨è§¦å‘

permissions:
  contents: write # èµ‹äºˆæäº¤ä»£ç æƒé™

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - name: æ‹‰å–ä»“åº“ä»£ç 
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: é…ç½®Node.jsç¯å¢ƒï¼ˆç§»é™¤ç¼“å­˜ï¼Œé¿å…lockæ–‡ä»¶é”™è¯¯ï¼‰
        uses: actions/setup-node@v4
        with:
          node-version: '20' # ä»…æŒ‡å®šNodeç‰ˆæœ¬ï¼Œå»æ‰cacheé…ç½®

      - name: å®‰è£…ç³»ç»Ÿä¾èµ–ï¼ˆChromeè¿è¡Œå¿…å¤‡ï¼‰
        run: |
          sudo apt-get update
          sudo apt-get install -y libnss3 libatk-bridge2.0-0 libdrm-dev libxkbcommon-dev libgbm-dev libasound-dev libatspi2.0-0 libxshmfence-dev

      - name: å®‰è£…Puppeteerï¼ˆç”¨ç¯å¢ƒå˜é‡è®¾ç½®ä¸‹è½½æºï¼‰
        run: |
          # ç”¨ç¯å¢ƒå˜é‡è®¾ç½®å›½å†…é•œåƒï¼Œè€Œénpm config
          export PUPPETEER_DOWNLOAD_HOST=https://npmmirror.com/mirrors
          # å…¨å±€å®‰è£…puppeteer
          npm install -g puppeteer@21.0.0
          # è‡ªåŠ¨è·å–Chromeè·¯å¾„å¹¶å†™å…¥ç¯å¢ƒå˜é‡
          echo "PUPPETEER_EXECUTABLE_PATH=$(find $(npm root -g)/puppeteer -name chrome -type f | head -1)" >> $GITHUB_ENV

      - name: æ‰§è¡Œæ›´æ–°è„šæœ¬
        run: |
          cd scripts
          node update-songs.js

      - name: æ£€æŸ¥æ•°æ®æ›´æ–°
        id: check_changes
        run: |
          if git status --porcelain | grep -q 'data/'; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
          fi

      - name: æäº¤æ›´æ–°ï¼ˆä»…å½“æœ‰å˜åŒ–æ—¶ï¼‰
        if: steps.check_changes.outputs.has_changes == 'true'
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "ğŸ¤– è‡ªåŠ¨æ›´æ–°æ­Œå•æ•°æ®"
          file_pattern: "data/*.js data/index.json"
          branch: main
