name: Auto Update Song List

on:
  schedule:
    - cron: '0 * * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      # 1. æ‹‰å–å®Œæ•´ä»“åº“ä»£ç ï¼ˆåŒ…å«æ‰€æœ‰å†å²ï¼‰
      - name: Checkout full repo
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0  # æ‹‰å–å…¨éƒ¨å†å²ï¼Œé¿å…æµ…å…‹éš†å†²çª
          ref: main

      # 2. å¼ºåˆ¶æ‹‰å–è¿œç¨‹æœ€æ–°ä»£ç ï¼ˆè¦†ç›–æœ¬åœ°æ‰€æœ‰å·®å¼‚ï¼‰
      - name: Force pull latest code
        run: |
          git fetch origin main
          git reset --hard origin/main
          git clean -fd

      # 3. é…ç½®Nodeç¯å¢ƒ
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      # 4. è¿è¡Œè„šæœ¬ç”Ÿæˆæ–°æ–‡ä»¶
      - name: Run update script
        run: node scripts/update-songs.js

      # 5. å¼ºåˆ¶æ¨é€ï¼ˆä»…æ¨é€dataæ–‡ä»¶å¤¹ï¼‰
      - name: Force push changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Bot"
          git add data/
          # åªæœ‰æ–‡ä»¶å˜åŒ–æ‰æäº¤ï¼Œé¿å…ç©ºæäº¤
          if ! git diff --quiet --staged; then
            git commit -m "ğŸ¤– è‡ªåŠ¨æ›´æ–°æ­Œå•æ•°æ®"
            git push origin main --force  # å¼ºåˆ¶æ¨é€ï¼ˆä»…è¿™ä¸€æ¬¡ï¼Œè§£å†³å†²çªåå¯æ”¹å›æ™®é€šæ¨é€ï¼‰
          fi
