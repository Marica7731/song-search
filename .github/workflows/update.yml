name: Auto Update Song List

on:
  schedule:
    # æ¯å¤©åŒ—äº¬æ—¶é—´æ—©ä¸Š8ç‚¹è‡ªåŠ¨è¿è¡Œ (UTCæ—¶é—´ 0ç‚¹)
    - cron: '0 0 * * *'
  workflow_dispatch: # å…è®¸ä½ åœ¨ç½‘é¡µä¸Šæ‰‹åŠ¨ç‚¹å‡»æŒ‰é’®è§¦å‘

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Create Update Script
        run: |
          cat > update-bili.js << 'EOF'
          const https = require('https');
          const fs = require('fs');

          // è¿™é‡Œæ˜¯ä¸€ä¸ªç®€åŒ–çš„ç¤ºä¾‹ï¼Œå®é™…ä½¿ç”¨éœ€è¦ä½ å¡«å…¥å…·ä½“çš„ BV å·åˆ—è¡¨
          // ç”±äºBç«™APIé™åˆ¶ï¼Œè¿™é‡Œæ¼”ç¤ºç”Ÿæˆä¸€ä¸ªæ¨¡æ‹Ÿæ–‡ä»¶
          // çœŸå®åœºæ™¯éœ€è¦å¯¹æ¥Bç«™APIæˆ–ä½¿ç”¨ yt-dlp å·¥å…·
          
          console.log("å¼€å§‹æ£€æŸ¥æ›´æ–°...");
          
          // æ¨¡æ‹Ÿï¼šç”Ÿæˆ naraetan.js (å®é™…è¿™é‡Œè¦å†™çˆ¬è™«é€»è¾‘)
          // æ³¨æ„ï¼šå®Œæ•´çš„çˆ¬è™«éœ€è¦å¤„ç†Bç«™çš„åçˆ¬ï¼Œè¿™é‡Œä»…å±•ç¤º GitHub Actions çš„ç»“æ„
          
          const mockData = `
          window.SONG_DATA = window.SONG_DATA || [];
          window.SONG_DATA.push(
            { title: "è‡ªåŠ¨æ›´æ–°æµ‹è¯•", artist: "System", collection: "è‡ªåŠ¨åŒ–æµ‹è¯•åˆé›†", up: "GitHub Actions", link: "https://www.bilibili.com" }
          );
          `;
          
          fs.writeFileSync('./data/naraetan.js', mockData);
          console.log("æ–‡ä»¶ç”Ÿæˆå®Œæ¯•");
          EOF

      - name: Run Update Script
        run: node update-bili.js

      - name: Commit and Push Changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add data/
          git diff --quiet && git diff --staged --quiet || (git commit -m "ğŸ¤– è‡ªåŠ¨æ›´æ–°æ­Œå•" && git push)
