name: Auto Update Song List

on:
  schedule:
    - cron: '0 * * * *' # æ¯å°æ—¶æ‰§è¡Œï¼Œå¯è°ƒæ•´
  workflow_dispatch: # æ‰‹åŠ¨è§¦å‘

permissions:
  contents: write # èµ‹äºˆæäº¤ä»£ç æƒé™

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - name: æ‹‰å–ä»“åº“ä»£ç 
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: é…ç½®Node.jsç¯å¢ƒ
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: å®‰è£…ç³»ç»Ÿä¾èµ–
        run: |
          sudo apt-get update
          sudo apt-get install -y libnss3 libatk-bridge2.0-0 libdrm-dev libxkbcommon-dev libgbm-dev libasound-dev libatspi2.0-0 libxshmfence-dev

      - name: å®‰è£…Puppeteerï¼ˆè·³è¿‡Chromeä¸‹è½½ï¼‰
        run: |
          export PUPPETEER_SKIP_DOWNLOAD=true
          npm install -g puppeteer@21.0.0
          echo "PUPPETEER_EXECUTABLE_PATH=/usr/bin/google-chrome" >> $GITHUB_ENV

      - name: æ‰§è¡Œæ›´æ–°è„šæœ¬ï¼ˆå®¹é”™ï¼‰
        run: |
          cd scripts
          node update-songs.js
        continue-on-error: true # ä¸ªåˆ«æ­Œæ‰‹å¤±è´¥ä¸ç»ˆæ­¢æµç¨‹

      - name: æ£€æŸ¥æ•°æ®æ›´æ–°
        id: check_changes
        run: |
          if git status --porcelain | grep -q 'data/'; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
          fi

      - name: æäº¤æ›´æ–°ï¼ˆä»…å½“æœ‰å˜åŒ–æ—¶ï¼‰
        if: steps.check_changes.outputs.has_changes == 'true'
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "ğŸ¤– è‡ªåŠ¨æ›´æ–°æ­Œå•æ•°æ®ï¼ˆéƒ¨åˆ†å¤±è´¥è§æ—¥å¿—ï¼‰"
          file_pattern: "data/*.js data/index.json"
          branch: main
